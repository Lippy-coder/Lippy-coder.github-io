<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Splitify - Settle up with friends</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .modal { display: none; }
        .modal.is-open { display: flex; }
        .settled-trip { opacity: 0.6; }
        .soft-deleted { text-decoration: line-through; color: #9ca3af; }
        #camera-view video {
            width: 100%;
            height: auto;
            max-height: 70vh;
            border-radius: 0.5rem;
        }
    </style>
</head>
<body class="bg-gray-50">

    <!-- Login/Register View -->
    <div id="auth-view" class="min-h-screen flex items-center justify-center bg-gray-100">
        <div class="max-w-md w-full bg-white p-8 rounded-xl shadow-md">
            <h2 id="auth-title" class="text-2xl font-bold text-center text-gray-800 mb-6">Login to Splitify</h2>
            <form id="auth-form">
                <div class="mb-4">
                    <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="email" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required>
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="password" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required>
                </div>
                <button type="submit" id="auth-btn" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Login</button>
            </form>
            <p id="auth-error" class="text-red-500 text-sm mt-4 text-center"></p>
            <p class="mt-4 text-center text-sm text-gray-600">
                <a href="#" id="toggle-auth-mode" class="font-medium text-indigo-600 hover:text-indigo-500">Need an account? Sign up</a>
            </p>
            <p id="verification-message" class="hidden mt-4 text-center text-sm text-green-600 bg-green-50 p-3 rounded-md">A verification email has been sent. Please check your inbox.</p>
             <footer class="text-center mt-6">
                <p class="text-xs text-gray-400">V.2.3.0-FINAL</p>
            </footer>
        </div>
    </div>

    <!-- Main App View -->
    <div id="app-view" class="hidden">
        <!-- Header -->
        <header class="bg-white shadow-sm sticky top-0 z-20">
            <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-3">
                    <h1 class="text-xl font-bold text-indigo-600">Splitify</h1>
                    <div class="flex items-center space-x-4">
                        <span id="user-display-name" class="text-sm font-medium text-gray-700"></span>
                        <img id="user-profile-pic" class="h-10 w-10 rounded-full cursor-pointer object-cover">
                    </div>
                </div>
            </div>
        </header>

        <!-- Trips Dashboard -->
        <main id="trips-dashboard" class="max-w-4xl mx-auto p-4 sm:p-6 lg:p-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Your Trips</h2>
                <button id="add-trip-btn" class="py-2 px-4 bg-indigo-600 text-white rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                    <i class="fas fa-plus mr-2"></i>New Trip
                </button>
            </div>
            <div id="trips-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Trip cards will be inserted here -->
            </div>
            <div class="mt-6">
                <label for="show-archived" class="flex items-center text-sm text-gray-600">
                    <input type="checkbox" id="show-archived" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                    <span class="ml-2">Show Archived Trips</span>
                </label>
            </div>
        </main>

        <!-- Single Trip View -->
        <div id="trip-view" class="hidden max-w-4xl mx-auto p-4 sm:p-6 lg:p-8">
             <div class="flex items-center mb-6">
                <button id="back-to-dashboard-btn" class="text-gray-500 hover:text-gray-700 mr-4"><i class="fas fa-arrow-left fa-lg"></i></button>
                <h2 id="trip-name-header" class="text-2xl font-bold text-gray-800"></h2>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-md">
                 <div class="flex justify-between items-start mb-4">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900">Trip Members</h3>
                        <div id="trip-members" class="flex -space-x-2 overflow-hidden mt-2">
                            <!-- Member avatars here -->
                        </div>
                    </div>
                    <button id="invite-member-btn" class="text-sm py-1 px-3 bg-gray-200 text-gray-700 rounded-full hover:bg-gray-300">Invite</button>
                </div>
                <div id="trip-balances" class="mb-6 space-y-2">
                    <!-- Balances will be inserted here -->
                </div>
                <div class="flex flex-col sm:flex-row gap-3">
                    <button id="add-expense-btn" class="flex-1 text-center py-3 px-4 bg-indigo-600 text-white rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2"><i class="fas fa-receipt mr-2"></i>Add Expense</button>
                    <!-- AI SCAN BUTTON ADDED HERE -->
                    <button id="ai-scan-btn" class="flex-1 text-center py-3 px-4 bg-purple-600 text-white rounded-lg shadow-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2"><i class="fas fa-camera-retro mr-2"></i>AI Scan</button>
                </div>
            </div>
             <div class="mt-6 flex justify-end space-x-4">
                <button id="settle-up-btn" class="py-2 px-4 bg-green-500 text-white rounded-lg hover:bg-green-600">Settle Up</button>
                 <button id="visualise-btn" class="py-2 px-4 bg-blue-500 text-white rounded-lg hover:bg-blue-600"><i class="fas fa-chart-pie mr-2"></i>Visualise</button>
                <button id="archive-trip-btn" class="py-2 px-4 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600">Archive</button>
            </div>
             <div id="expenses-list" class="mt-8">
                <!-- Expenses will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="add-trip-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-50 items-center justify-center z-30">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md">
            <h3 class="text-xl font-bold mb-6">Create a New Trip</h3>
            <form id="add-trip-form">
                <input type="text" id="trip-name-input" placeholder="Trip Name (e.g., Paris Getaway)" class="w-full p-3 border rounded-md mb-4" required>
                <select id="trip-currency-input" class="w-full p-3 border rounded-md mb-6" required>
                     <option value="EUR">Euro (€)</option>
                     <option value="USD">US Dollar ($)</option>
                     <option value="GBP">British Pound (£)</option>
                     <option value="JPY">Japanese Yen (¥)</option>
                </select>
                <div class="flex justify-end space-x-4">
                    <button type="button" class="modal-cancel-btn px-4 py-2 text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="px-4 py-2 text-white bg-indigo-600 rounded-md hover:bg-indigo-700">Create</button>
                </div>
            </form>
        </div>
    </div>

    <div id="add-expense-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-50 items-center justify-center z-30">
         <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-lg">
            <h3 class="text-xl font-bold mb-6">Add an Expense</h3>
            <form id="add-expense-form">
                <input type="hidden" id="expense-id-input">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                     <input type="text" id="expense-description" placeholder="Description" class="w-full p-3 border rounded-md md:col-span-2" required>
                     <input type="number" id="expense-amount" placeholder="Amount" class="w-full p-3 border rounded-md" required step="0.01">
                     <select id="expense-currency" class="w-full p-3 border rounded-md">
                         <!-- Currencies will be dynamically populated -->
                     </select>
                     <input type="date" id="expense-date" class="w-full p-3 border rounded-md" required>
                     <select id="expense-category" class="w-full p-3 border rounded-md">
                        <option value="General">General</option>
                        <option value="Food & Drink">Food & Drink</option>
                        <option value="Transport">Transport</option>
                        <option value="Accommodation">Accommodation</option>
                        <option value="Entertainment">Entertainment</option>
                        <option value="Shopping">Shopping</option>
                     </select>
                </div>
                 <div class="mt-6">
                    <p class="font-medium">Paid by:</p>
                    <div id="expense-paid-by" class="mt-2 flex flex-wrap gap-2"></div>
                </div>
                 <div class="mt-6">
                    <p class="font-medium">Split between:</p>
                    <div id="expense-split-between" class="mt-2 grid grid-cols-2 md:grid-cols-3 gap-3"></div>
                    <p id="split-error-msg" class="text-red-500 text-sm mt-2 hidden"></p>
                </div>
                <div class="flex justify-between items-center mt-8">
                    <button type="button" id="delete-expense-btn" class="px-4 py-2 text-white bg-red-600 rounded-md hover:bg-red-700 hidden">Delete</button>
                    <div>
                        <button type="button" class="modal-cancel-btn px-4 py-2 text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300">Cancel</button>
                        <button type="submit" class="px-4 py-2 text-white bg-indigo-600 rounded-md hover:bg-indigo-700 ml-2">Save</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <div id="settle-up-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-50 items-center justify-center z-30">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md">
            <h3 class="text-xl font-bold mb-4">Settle Up</h3>
            <p class="text-sm text-gray-600 mb-6">Here is the simplest way to settle all debts. Mark payments as they happen.</p>
            <div id="settle-up-list" class="space-y-4">
                <!-- Settlement transactions will be inserted here -->
            </div>
             <div class="flex justify-end mt-8">
                <button type="button" class="modal-cancel-btn px-4 py-2 text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300">Close</button>
            </div>
        </div>
    </div>

    <div id="visualise-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-50 items-center justify-center z-30">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-lg mx-4">
            <h3 class="text-xl font-bold mb-6 text-center">Trip Finances Visualisation</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div>
                    <h4 class="font-semibold text-red-600 mb-3 text-center">Who Owes Money</h4>
                    <div id="visualise-owes" class="space-y-3"></div>
                </div>
                <div>
                    <h4 class="font-semibold text-green-600 mb-3 text-center">Who Is Owed Money</h4>
                    <div id="visualise-owed" class="space-y-3"></div>
                </div>
            </div>
            <div class="mt-8 border-t pt-6">
                <h4 class="font-semibold text-blue-600 mb-3 text-center">How to Settle Up</h4>
                <div id="visualise-settle" class="space-y-3 text-center"></div>
            </div>
            <div class="flex justify-end mt-8">
                <button type="button" class="modal-cancel-btn px-4 py-2 text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300">Close</button>
            </div>
        </div>
    </div>

    <div id="user-profile-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-50 items-center justify-center z-30">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md">
            <h3 class="text-xl font-bold mb-6 text-center">My Profile</h3>
            <div class="flex flex-col items-center">
                <img id="modal-profile-pic" class="h-24 w-24 rounded-full object-cover mb-4">
                <input type="file" id="profile-pic-upload" class="hidden" accept="image/*">
                <button id="change-pic-btn" class="text-sm text-indigo-600 hover:text-indigo-500 mb-6">Change Photo</button>
                <input type="text" id="profile-name-input" class="w-full p-3 border rounded-md mb-4 text-center">
            </div>
            <div class="flex justify-between items-center mt-6">
                <button id="logout-btn" class="px-4 py-2 text-white bg-red-600 rounded-md hover:bg-red-700">Logout</button>
                <div>
                    <button type="button" class="modal-cancel-btn px-4 py-2 text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300">Cancel</button>
                    <button id="save-profile-btn" class="px-4 py-2 text-white bg-indigo-600 rounded-md hover:bg-indigo-700 ml-2">Save</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="invite-member-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-50 items-center justify-center z-30">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md">
            <h3 class="text-xl font-bold mb-6">Invite a Member</h3>
            <form id="invite-member-form">
                <input type="email" id="invite-email-input" placeholder="Enter member's email" class="w-full p-3 border rounded-md mb-6" required>
                <div class="flex justify-end space-x-4">
                    <button type="button" class="modal-cancel-btn px-4 py-2 text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="px-4 py-2 text-white bg-indigo-600 rounded-md hover:bg-indigo-700">Send Invite</button>
                </div>
            </form>
            <p id="invite-status-msg" class="text-sm mt-4 text-center"></p>
        </div>
    </div>

    <!-- AI SCAN CAMERA VIEW MODAL -->
    <div id="ai-scan-modal" class="modal fixed inset-0 bg-black items-center justify-center z-40">
        <div class="relative w-full max-w-2xl h-full flex flex-col items-center justify-center p-4">
            <video id="camera-feed" playsinline class="rounded-lg"></video>
            <canvas id="camera-canvas" class="hidden"></canvas>
            
            <div id="ai-scan-loading-overlay" class="absolute inset-0 bg-gray-900 bg-opacity-75 flex-col items-center justify-center z-50" style="display: none;">
                <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-white"></div>
                <p class="text-white mt-4">Analyzing your expense...</p>
            </div>

            <div class="absolute bottom-8 left-0 right-0 flex justify-center items-center space-x-8">
                <button id="ai-cancel-btn" class="w-16 h-16 bg-white bg-opacity-30 text-white rounded-full flex items-center justify-center text-xl">
                    &times;
                </button>
                <button id="ai-capture-btn" class="w-20 h-20 bg-white rounded-full border-4 border-gray-400 focus:outline-none"></button>
            </div>
        </div>
    </div>


    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile, sendEmailVerification } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, updateDoc, arrayUnion, query, where, getDocs, addDoc, serverTimestamp, writeBatch, deleteDoc, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // Firebase Config Keys
        const firebaseConfig = {
            apiKey: "AIzaSyAi2llnXf_VloWUL6mZgdJMa1W1EOTwLE4",
            authDomain: "splitify-2ec5e.firebaseapp.com",
            projectId: "splitify-2ec5e",
            storageBucket: "splitify-2ec5e.appspot.com",
            messagingSenderId: "1038415606946",
            appId: "1:1038415606946:web:a17be9b5dbbd9a715013fb",
            measurementId: "G-DTBQM17BV6"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth();
        const db = getFirestore();
        const storage = getStorage();

        // Global state
        let currentUser = null;
        let currentTripId = null;
        let currentTripData = null;
        let allTripExpenses = []; 
        let tripUnsubscribe = null;
        let tripsUnsubscribe = null;
        let expensesUnsubscribe = null;
        let memberProfilesCache = {};
        // AI Scan state variables
        let cameraStream = null;
        let userLocation = null;

        const exchangeRateApiKey = "9dedf9a9f74ab256717d8f4f";
        const currencies = ["EUR", "USD", "GBP", "JPY", "CAD", "AUD", "CHF", "CNY", "SEK", "NZD", "KRW", "SGD", "NOK", "MXN", "INR", "RUB", "ZAR", "TRY", "BRL", "HKD"];
        
        // --- AI SCAN FEATURE IMPLEMENTATION ---

        const aiScanBtn = document.getElementById('ai-scan-btn');
        const aiScanModal = document.getElementById('ai-scan-modal');
        const aiCancelBtn = document.getElementById('ai-cancel-btn');
        const aiCaptureBtn = document.getElementById('ai-capture-btn');
        const videoElement = document.getElementById('camera-feed');
        const canvasElement = document.getElementById('camera-canvas');
        const aiLoadingOverlay = document.getElementById('ai-scan-loading-overlay');
        const ANALYZE_IMAGE_URL = 'https://analyzeexpenseimage-1038415606946.europe-west2.run.app';

        async function openCameraView() {
            aiScanModal.classList.add('is-open');

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    userLocation = {
                        lat: position.coords.latitude,
                        lon: position.coords.longitude
                    };
                    console.log('Location acquired:', userLocation);
                },
                (error) => {
                    console.error("Error getting location (will proceed without it):", error);
                    userLocation = null; 
                }
            );

            try {
                if (cameraStream) {
                    cameraStream.getTracks().forEach(track => track.stop());
                }
                cameraStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } 
                });
                videoElement.srcObject = cameraStream;
                videoElement.play();
            } catch (err) {
                console.error("Error accessing camera:", err);
                alert("Could not access the camera. Please check permissions.");
                closeCameraView();
            }
        }

        function closeCameraView() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
            }
            videoElement.srcObject = null;
            aiScanModal.classList.remove('is-open');
            aiLoadingOverlay.style.display = 'none';
        }

        async function handleAiCapture() {
            aiLoadingOverlay.style.display = 'flex';

            const context = canvasElement.getContext('2d');
            canvasElement.width = videoElement.videoWidth;
            canvasElement.height = videoElement.videoHeight;
            context.drawImage(videoElement, 0, 0, canvasElement.width, canvasElement.height);
            const imageDataUrl = canvasElement.toDataURL('image/jpeg', 0.8);
            const base64Image = imageDataUrl.split(',')[1];

            if (!auth.currentUser) {
                alert("You must be logged in to use this feature.");
                closeCameraView();
                return;
            }
            const token = await auth.currentUser.getIdToken();

            try {
                const response = await fetch(ANALYZE_IMAGE_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        image: base64Image,
                        location: userLocation
                    })
                });

                if (!response.ok) {
                    throw new Error(`Server responded with status: ${response.status}`);
                }

                const data = await response.json();
                console.log('AI Response:', data);
                
                closeCameraView();
                openAddExpenseModal(null); 

                const descInput = document.getElementById('expense-description');
                const amountInput = document.getElementById('expense-amount');
                const currencySelect = document.getElementById('expense-currency');
                const categorySelect = document.getElementById('expense-category');

                if (data.description) descInput.value = data.description;
                if (data.amount) amountInput.value = data.amount;
                if (data.currency) {
                    if (![...currencySelect.options].some(opt => opt.value === data.currency)) {
                        const newOption = new Option(`${data.currency}`, data.currency, true, true);
                        currencySelect.add(newOption);
                    }
                    currencySelect.value = data.currency;
                }
                if (data.category) {
                     if ([...categorySelect.options].some(opt => opt.value === data.category)) {
                        categorySelect.value = data.category;
                     }
                }
                
            } catch (error) {
                console.error('AI Scan failed:', error);
                alert('AI analysis failed. Please enter the expense manually.');
                closeCameraView();
            }
        }

        aiScanBtn.addEventListener('click', openCameraView);
        aiCancelBtn.addEventListener('click', closeCameraView);
        aiCaptureBtn.addEventListener('click', handleAiCapture);


        // --- DOM Elements ---
        const dom = {
            auth: {
                view: document.getElementById('auth-view'),
                form: document.getElementById('auth-form'),
                title: document.getElementById('auth-title'),
                emailInput: document.getElementById('email'),
                passwordInput: document.getElementById('password'),
                submitBtn: document.getElementById('auth-btn'),
                toggleModeLink: document.getElementById('toggle-auth-mode'),
                errorMsg: document.getElementById('auth-error'),
                verificationMsg: document.getElementById('verification-message'),
            },
            app: {
                view: document.getElementById('app-view'),
                userDisplayName: document.getElementById('user-display-name'),
                userProfilePic: document.getElementById('user-profile-pic'),
                logoutBtn: document.getElementById('logout-btn'),
            },
            dashboard: {
                view: document.getElementById('trips-dashboard'),
                addTripBtn: document.getElementById('add-trip-btn'),
                tripsList: document.getElementById('trips-list'),
                showArchivedCheckbox: document.getElementById('show-archived'),
            },
            tripView: {
                view: document.getElementById('trip-view'),
                backBtn: document.getElementById('back-to-dashboard-btn'),
                nameHeader: document.getElementById('trip-name-header'),
                membersContainer: document.getElementById('trip-members'),
                balancesContainer: document.getElementById('trip-balances'),
                addExpenseBtn: document.getElementById('add-expense-btn'),
                settleUpBtn: document.getElementById('settle-up-btn'),
                expensesList: document.getElementById('expenses-list'),
                inviteMemberBtn: document.getElementById('invite-member-btn'),
                visualiseBtn: document.getElementById('visualise-btn'),
                archiveTripBtn: document.getElementById('archive-trip-btn'),
            },
            modals: {
                addTrip: document.getElementById('add-trip-modal'),
                addExpense: document.getElementById('add-expense-modal'),
                settleUp: document.getElementById('settle-up-modal'),
                visualise: document.getElementById('visualise-modal'),
                userProfile: document.getElementById('user-profile-modal'),
                inviteMember: document.getElementById('invite-member-modal'),
            },
            forms: {
                addTrip: document.getElementById('add-trip-form'),
                tripNameInput: document.getElementById('trip-name-input'),
                tripCurrencyInput: document.getElementById('trip-currency-input'),
                addExpense: document.getElementById('add-expense-form'),
                expenseId: document.getElementById('expense-id-input'),
                expenseDescription: document.getElementById('expense-description'),
                expenseAmount: document.getElementById('expense-amount'),
                expenseCurrency: document.getElementById('expense-currency'),
                expenseDate: document.getElementById('expense-date'),
                expenseCategory: document.getElementById('expense-category'),
                expensePaidBy: document.getElementById('expense-paid-by'),
                expenseSplitBetween: document.getElementById('expense-split-between'),
                deleteExpenseBtn: document.getElementById('delete-expense-btn'),
                splitErrorMsg: document.getElementById('split-error-msg'),
                userProfile: {
                    pic: document.getElementById('modal-profile-pic'),
                    uploadInput: document.getElementById('profile-pic-upload'),
                    changeBtn: document.getElementById('change-pic-btn'),
                    nameInput: document.getElementById('profile-name-input'),
                    saveBtn: document.getElementById('save-profile-btn'),
                },
                inviteMember: document.getElementById('invite-member-form'),
                inviteEmailInput: document.getElementById('invite-email-input'),
                inviteStatusMsg: document.getElementById('invite-status-msg'),
            },
            settleUpList: document.getElementById('settle-up-list'),
            visualise: {
                owes: document.getElementById('visualise-owes'),
                owed: document.getElementById('visualise-owed'),
                settle: document.getElementById('visualise-settle'),
            },
            loadingSpinner: document.getElementById('loading-spinner'),
        };

        function toggleModal(modal, show) {
            if (show) {
                modal.classList.add('is-open');
            } else {
                modal.classList.remove('is-open');
            }
        }
        
        document.querySelectorAll('.modal-cancel-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                btn.closest('.modal').classList.remove('is-open');
            });
        });

        onAuthStateChanged(auth, async (user) => {
            // TARGETED ERROR HANDLING: Wrap the post-login logic in a try...catch
            try {
                if (user && user.emailVerified) {
                    currentUser = user;
                    dom.auth.view.style.display = 'none';
                    dom.app.view.style.display = 'block';
                    await initApp();
                } else {
                    if (tripUnsubscribe) tripUnsubscribe();
                    if (tripsUnsubscribe) tripsUnsubscribe();
                    if (expensesUnsubscribe) expensesUnsubscribe();
                    currentUser = null;
                    currentTripId = null;
                    currentTripData = null;
                    dom.auth.view.style.display = 'flex';
                    dom.app.view.style.display = 'none';
                    memberProfilesCache = {};
                }
            } catch (error) {
                console.error("Critical error during app initialization:", error);
                // If an error happens after login, sign out and show the error
                await signOut(auth);
                dom.auth.errorMsg.textContent = `App failed to start: ${error.message}`;
            }
        });

        let isLogin = true;
        dom.auth.toggleModeLink.addEventListener('click', (e) => {
            e.preventDefault();
            isLogin = !isLogin;
            dom.auth.title.textContent = isLogin ? 'Login to Splitify' : 'Create an Account';
            dom.auth.submitBtn.textContent = isLogin ? 'Login' : 'Sign Up';
            dom.auth.toggleModeLink.textContent = isLogin ? 'Need an account? Sign up' : 'Have an account? Login';
            dom.auth.errorMsg.textContent = '';
            dom.auth.verificationMsg.classList.add('hidden');
        });

        dom.auth.form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = dom.auth.emailInput.value;
            const password = dom.auth.passwordInput.value;
            dom.auth.errorMsg.textContent = '';

            try {
                if (isLogin) {
                    const userCredential = await signInWithEmailAndPassword(auth, email, password);
                    if (!userCredential.user.emailVerified) {
                        await signOut(auth);
                        dom.auth.errorMsg.textContent = "Please verify your email before logging in.";
                    }
                } else {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    await sendEmailVerification(userCredential.user);
                    await setDoc(doc(db, "users", userCredential.user.uid), {
                        email: userCredential.user.email,
                        displayName: userCredential.user.email.split('@')[0],
                        photoURL: `https://i.pravatar.cc/150?u=${userCredential.user.uid}`
                    });
                    dom.auth.verificationMsg.classList.remove('hidden');
                    dom.auth.form.reset();
                    await signOut(auth);
                }
            } catch (error) {
                dom.auth.errorMsg.textContent = error.message;
            }
        });

        async function initApp() {
            if (!currentUser) return;
            await fetchAndDisplayProfile();
            listenForTrips();
            showDashboard();
        }

        async function fetchAndDisplayProfile() {
            const userProfile = await getCachedUserProfile(currentUser.uid);
            dom.app.userDisplayName.textContent = userProfile.displayName;
            dom.app.userProfilePic.src = userProfile.photoURL;
            dom.forms.userProfile.pic.src = userProfile.photoURL;
            dom.forms.userProfile.nameInput.value = userProfile.displayName;
        }

        function listenForTrips() {
            if (tripsUnsubscribe) tripsUnsubscribe();
            const q = query(collection(db, "trips"), where("memberIds", "array-contains", currentUser.uid));
            tripsUnsubscribe = onSnapshot(q, (snapshot) => {
                const showArchived = dom.dashboard.showArchivedCheckbox.checked;
                const trips = [];
                snapshot.forEach(doc => {
                    const trip = { id: doc.id, ...doc.data() };
                    if (showArchived || !trip.isArchived) {
                         trips.push(trip);
                    }
                });
                renderTripsDashboard(trips);
            });
        }
        
        dom.dashboard.showArchivedCheckbox.addEventListener('change', listenForTrips);

        async function renderTripsDashboard(trips) {
            dom.dashboard.tripsList.innerHTML = '';
            for (const trip of trips) {
                const tripCard = document.createElement('div');
                tripCard.className = `bg-white p-5 rounded-xl shadow-md cursor-pointer hover:shadow-lg transition-shadow ${trip.isSettled ? 'settled-trip' : ''}`;
                tripCard.dataset.tripId = trip.id;

                const membersAvatars = await Promise.all((trip.memberIds || []).map(async (uid) => {
                    const profile = await getCachedUserProfile(uid);
                    return `<img src="${profile.photoURL}" alt="${profile.displayName}" class="h-8 w-8 rounded-full border-2 border-white object-cover">`;
                }));
                
                tripCard.innerHTML = `
                    <h3 class="font-bold text-lg text-gray-800">${trip.name}</h3>
                    <div class="flex -space-x-2 overflow-hidden mt-3 mb-4">
                        ${membersAvatars.join('')}
                    </div>
                    <p class="text-sm text-gray-500">${trip.isSettled ? 'Settled' : 'Ongoing'}</p>
                    ${trip.isArchived ? '<p class="text-xs text-yellow-600 mt-2 font-semibold">ARCHIVED</p>' : ''}
                `;
                tripCard.addEventListener('click', () => showTripView(trip.id));
                dom.dashboard.tripsList.appendChild(tripCard);
            }
        }
        
        dom.dashboard.addTripBtn.addEventListener('click', () => toggleModal(dom.modals.addTrip, true));
        dom.forms.addTrip.addEventListener('submit', async (e) => {
            e.preventDefault();
            const tripName = dom.forms.tripNameInput.value;
            const baseCurrency = dom.forms.tripCurrencyInput.value;

            try {
                await addDoc(collection(db, "trips"), {
                    name: tripName,
                    ownerId: currentUser.uid,
                    memberIds: [currentUser.uid],
                    baseCurrency: baseCurrency,
                    createdAt: serverTimestamp(),
                    isSettled: false,
                    isArchived: false,
                    settledPayments: []
                });
                toggleModal(dom.modals.addTrip, false);
                dom.forms.addTrip.reset();
            } catch (error) {
                console.error("Error creating trip:", error);
                alert("Could not create trip.");
            }
        });
        
        dom.tripView.archiveTripBtn.addEventListener('click', async () => {
             if (!currentTripId) return;
             const tripRef = doc(db, "trips", currentTripId);
             await updateDoc(tripRef, {
                 isArchived: !currentTripData.isArchived
             });
             if (!currentTripData.isArchived) {
                showDashboard();
             }
        });

        function showDashboard() {
            if (tripUnsubscribe) tripUnsubscribe();
            if (expensesUnsubscribe) expensesUnsubscribe();
            currentTripId = null;
            currentTripData = null;
            dom.dashboard.view.style.display = 'block';
            dom.tripView.view.style.display = 'none';
        }

        function showTripView(tripId) {
            dom.dashboard.view.style.display = 'none';
            dom.tripView.view.style.display = 'block';
            currentTripId = tripId;
            if (tripUnsubscribe) tripUnsubscribe();

            tripUnsubscribe = onSnapshot(doc(db, "trips", tripId), async (doc) => {
                if (doc.exists()) {
                    currentTripData = { id: doc.id, ...doc.data() };
                    await renderTripDetails();
                    listenForExpenses();
                } else {
                    console.error("Trip not found!");
                    showDashboard();
                }
            });
        }
        
        dom.tripView.backBtn.addEventListener('click', showDashboard);

        async function renderTripDetails() {
            if (!currentTripData) return;
            dom.tripView.nameHeader.textContent = currentTripData.name;
            
            dom.tripView.membersContainer.innerHTML = '';
            for (const memberId of currentTripData.memberIds) {
                const profile = await getCachedUserProfile(memberId);
                const avatar = document.createElement('img');
                avatar.src = profile.photoURL;
                avatar.alt = profile.displayName;
                avatar.title = profile.displayName;
                avatar.className = 'h-10 w-10 rounded-full border-2 border-white object-cover';
                dom.tripView.membersContainer.appendChild(avatar);
            }
            
            dom.tripView.archiveTripBtn.textContent = currentTripData.isArchived ? 'Unarchive' : 'Archive';
        }
        
        function listenForExpenses() {
            if (expensesUnsubscribe) expensesUnsubscribe();
            const expensesRef = collection(db, 'trips', currentTripId, 'expenses');
            expensesUnsubscribe = onSnapshot(query(expensesRef), (snapshot) => {
                allTripExpenses = [];
                snapshot.forEach(doc => allTripExpenses.push({ id: doc.id, ...doc.data() }));
                renderExpensesList();
                calculateAndRenderBalances();
            });
        }

        function renderExpensesList() {
            dom.tripView.expensesList.innerHTML = '';
            const expenses = [...allTripExpenses];
            expenses.sort((a, b) => b.occurredAt.toMillis() - a.occurredAt.toMillis());

            if (expenses.length === 0) {
                dom.tripView.expensesList.innerHTML = '<p class="text-center text-gray-500 mt-8">No expenses added yet.</p>';
                return;
            }

            expenses.forEach(expense => {
                const expenseEl = document.createElement('div');
                const occurredDate = expense.occurredAt.toDate();
                expenseEl.className = `bg-white p-4 rounded-lg shadow-sm mb-3 flex justify-between items-center cursor-pointer ${expense.isDeleted ? 'soft-deleted' : ''}`;
                expenseEl.innerHTML = `
                    <div class="flex items-center">
                        <div class="w-12 h-12 rounded-full bg-gray-100 flex items-center justify-center mr-4">
                            <i class="${getCategoryIcon(expense.category)} text-gray-600 text-xl"></i>
                        </div>
                        <div>
                            <p class="font-semibold text-gray-800">${expense.description}</p>
                            <p class="text-sm text-gray-500">Paid by ${memberProfilesCache[expense.paidBy]?.displayName || '...'} on ${occurredDate.toLocaleDateString()}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-lg text-gray-900">${formatCurrency(expense.amountDetails.originalAmount, expense.amountDetails.originalCurrency)}</p>
                        ${expense.amountDetails.baseAmount !== expense.amountDetails.originalAmount ? `<p class="text-sm text-gray-500">(${formatCurrency(expense.amountDetails.baseAmount, currentTripData.baseCurrency)})</p>` : ''}
                    </div>
                `;
                if (!expense.isDeleted) {
                    expenseEl.addEventListener('click', () => openAddExpenseModal(expense));
                }
                dom.tripView.expensesList.appendChild(expenseEl);
            });
        }
        
        function getCategoryIcon(category) {
            const icons = {
                'Food & Drink': 'fas fa-utensils',
                'Transport': 'fas fa-bus',
                'Accommodation': 'fas fa-bed',
                'Entertainment': 'fas fa-ticket-alt',
                'Shopping': 'fas fa-shopping-bag',
                'General': 'fas fa-receipt',
            };
            return icons[category] || 'fas fa-dollar-sign';
        }
        
        async function getCachedUserProfile(uid) {
            if (memberProfilesCache[uid]) {
                return memberProfilesCache[uid];
            }
            const userDoc = await getDoc(doc(db, "users", uid));
            if (userDoc.exists()) {
                const profile = userDoc.data();
                memberProfilesCache[uid] = profile;
                return profile;
            }
            return { displayName: 'Unknown User', photoURL: '' };
        }
        
        function openAddExpenseModal(expense) {
            dom.forms.addExpense.reset();
            dom.forms.splitErrorMsg.classList.add('hidden');
            dom.forms.expenseId.value = expense ? expense.id : '';
            
            if (expense) {
                dom.forms.expenseDescription.value = expense.description;
                dom.forms.expenseAmount.value = expense.amountDetails.originalAmount;
                dom.forms.expenseCurrency.value = expense.amountDetails.originalCurrency;
                dom.forms.expenseCategory.value = expense.category || 'General';
                dom.forms.expenseDate.value = expense.occurredAt.toDate().toISOString().split('T')[0];
            } else {
                dom.forms.expenseCurrency.value = currentTripData.baseCurrency;
                dom.forms.expenseDate.value = new Date().toISOString().split('T')[0];
            }
            
            dom.forms.deleteExpenseBtn.style.display = expense && !expense.isDeleted ? 'block' : 'none';

            populateCurrencyOptions(dom.forms.expenseCurrency);
            populatePayerOptions(expense ? expense.paidBy : currentUser.uid);
            populateSplitOptions(expense);
            
            toggleModal(dom.modals.addExpense, true);
        }

        dom.tripView.addExpenseBtn.addEventListener('click', () => openAddExpenseModal(null));
        
        function populateCurrencyOptions(selectElement) {
            selectElement.innerHTML = '';
            currencies.forEach(c => {
                const option = new Option(`${c}`, c);
                selectElement.appendChild(option);
            });
        }
        
        function populatePayerOptions(selectedPayerId) {
            dom.forms.expensePaidBy.innerHTML = '';
            currentTripData.memberIds.forEach(memberId => {
                const profile = memberProfilesCache[memberId];
                const wrapper = document.createElement('div');
                wrapper.className = 'flex items-center';
                const input = document.createElement('input');
                input.type = 'radio';
                input.id = `payer-${memberId}`;
                input.name = 'paidBy';
                input.value = memberId;
                input.className = 'h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500';
                if (memberId === selectedPayerId) {
                    input.checked = true;
                }
                const label = document.createElement('label');
                label.htmlFor = `payer-${memberId}`;
                label.className = 'ml-2 block text-sm text-gray-900';
                label.textContent = profile.displayName;
                wrapper.appendChild(input);
                wrapper.appendChild(label);
                dom.forms.expensePaidBy.appendChild(wrapper);
            });
        }
        
        function populateSplitOptions(expense) {
            dom.forms.expenseSplitBetween.innerHTML = '';
            const split = expense ? expense.splitBetween : {};
            currentTripData.memberIds.forEach(memberId => {
                 const profile = memberProfilesCache[memberId];
                 const isChecked = expense ? split[memberId] !== undefined : true;

                 const container = document.createElement('div');
                 container.className = 'flex items-center p-2 bg-gray-50 rounded-md';

                 const checkbox = document.createElement('input');
                 checkbox.type = 'checkbox';
                 checkbox.id = `split-${memberId}`;
                 checkbox.dataset.memberId = memberId;
                 checkbox.className = 'h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500';
                 checkbox.checked = isChecked;
                 
                 const label = document.createElement('label');
                 label.htmlFor = `split-${memberId}`;
                 label.textContent = profile.displayName;
                 label.className = 'ml-2 text-sm text-gray-800 flex-grow';

                 const amountInput = document.createElement('input');
                 amountInput.type = 'number';
                 amountInput.step = '0.01';
                 amountInput.placeholder = 'Amt';
                 amountInput.className = 'w-20 p-1 border rounded-md text-sm ml-2 hidden';
                 amountInput.value = split[memberId] || '';

                 checkbox.addEventListener('change', () => {
                     updateSplitInputs();
                 });

                 container.appendChild(checkbox);
                 container.appendChild(label);
                 container.appendChild(amountInput);
                 dom.forms.expenseSplitBetween.appendChild(container);
            });
            updateSplitInputs();
        }

        function updateSplitInputs() {
            const checkboxes = dom.forms.expenseSplitBetween.querySelectorAll('input[type="checkbox"]');
            let isCustom = false;
            checkboxes.forEach(cb => {
                const input = cb.parentElement.querySelector('input[type="number"]');
                if (input.value) isCustom = true;
            });

            checkboxes.forEach(cb => {
                const input = cb.parentElement.querySelector('input[type="number"]');
                if(isCustom) {
                    input.classList.remove('hidden');
                } else {
                    input.classList.add('hidden');
                    input.value = '';
                }
            });
        }
        
        dom.forms.expenseSplitBetween.addEventListener('input', (e) => {
            if(e.target.type === 'number') {
                updateSplitInputs();
            }
        });

        async function getExchangeRate(from, to) {
            if (from === to) return 1;
            try {
                const response = await fetch(`https://v6.exchangerate-api.com/v6/${exchangeRateApiKey}/pair/${from}/${to}`);
                const data = await response.json();
                return data.result === 'success' ? data.conversion_rate : 1;
            } catch (error) {
                console.error("Exchange rate API error:", error);
                return 1;
            }
        }

        dom.forms.addExpense.addEventListener('submit', async (e) => {
            e.preventDefault();
            const expenseId = dom.forms.expenseId.value;
            const originalAmount = parseFloat(dom.forms.expenseAmount.value);
            const originalCurrency = dom.forms.expenseCurrency.value;
            const splitCheckboxes = dom.forms.expenseSplitBetween.querySelectorAll('input[type="checkbox"]:checked');

            let splitBetween = {};
            let customSplitTotal = 0;
            let isCustomSplit = false;

            splitCheckboxes.forEach(cb => {
                const memberId = cb.dataset.memberId;
                const amountInput = cb.parentElement.querySelector('input[type="number"]');
                if (amountInput.value) {
                    isCustomSplit = true;
                    const splitAmount = parseFloat(amountInput.value);
                    splitBetween[memberId] = splitAmount;
                    customSplitTotal += splitAmount;
                }
            });
            
            if (isCustomSplit) {
                if (Math.abs(customSplitTotal - originalAmount) > 0.01) {
                    dom.forms.splitErrorMsg.textContent = `Split amounts must add up to ${originalAmount}. Current total: ${customSplitTotal.toFixed(2)}`;
                    dom.forms.splitErrorMsg.classList.remove('hidden');
                    return;
                }
            } else {
                const numSplits = splitCheckboxes.length;
                if (numSplits > 0) {
                    const splitAmount = originalAmount / numSplits;
                    splitCheckboxes.forEach(cb => {
                        splitBetween[cb.dataset.memberId] = parseFloat(splitAmount.toFixed(2));
                    });
                }
            }
            dom.forms.splitErrorMsg.classList.add('hidden');
            
            const rate = await getExchangeRate(originalCurrency, currentTripData.baseCurrency);
            
            const expenseData = {
                description: dom.forms.expenseDescription.value,
                occurredAt: Timestamp.fromDate(new Date(dom.forms.expenseDate.value)),
                category: dom.forms.expenseCategory.value || null,
                createdAt: serverTimestamp(),
                paidBy: dom.forms.expensePaidBy.querySelector('input:checked').value,
                amountDetails: {
                    originalAmount,
                    originalCurrency,
                    baseAmount: parseFloat((originalAmount * rate).toFixed(2)),
                    baseCurrency: currentTripData.baseCurrency,
                    exchangeRate: rate
                },
                splitBetween,
                isDeleted: false
            };

            const batch = writeBatch(db);
            const expenseRef = expenseId 
                ? doc(db, 'trips', currentTripId, 'expenses', expenseId)
                : doc(collection(db, 'trips', currentTripId, 'expenses'));
            
            batch.set(expenseRef, expenseData, { merge: true });

            const tripRef = doc(db, "trips", currentTripId);
            batch.update(tripRef, { isSettled: false });

            await batch.commit();
            
            toggleModal(dom.modals.addExpense, false);
        });
        
        dom.forms.deleteExpenseBtn.addEventListener('click', async () => {
             if (!confirm("Are you sure? This will mark the expense as deleted.")) return;
             const expenseId = dom.forms.expenseId.value;
             const expenseRef = doc(db, 'trips', currentTripId, 'expenses', expenseId);
             await updateDoc(expenseRef, { isDeleted: true });
             toggleModal(dom.modals.addExpense, false);
        });

        function calculateBalances() {
            const balances = {};
            currentTripData.memberIds.forEach(uid => balances[uid] = 0);
            
            const validExpenses = allTripExpenses.filter(e => !e.isDeleted);

            validExpenses.forEach(expense => {
                const payerId = expense.paidBy;
                balances[payerId] += expense.amountDetails.baseAmount;
                Object.keys(expense.splitBetween).forEach(borrowerId => {
                    const splitAmountInBase = expense.splitBetween[borrowerId] * expense.amountDetails.exchangeRate;
                    balances[borrowerId] -= splitAmountInBase;
                });
            });
            
            (currentTripData.settledPayments || []).forEach(payment => {
                balances[payment.from] += payment.amount;
                balances[payment.to] -= payment.amount;
            });
            
            return balances;
        }

        function calculateAndRenderBalances() {
            const balances = calculateBalances();
            dom.tripView.balancesContainer.innerHTML = '';
            let allSettled = true;

            Object.entries(balances).forEach(([uid, balance]) => {
                const profile = memberProfilesCache[uid];
                const balanceEl = document.createElement('div');
                const formattedBalance = formatCurrency(Math.abs(balance), currentTripData.baseCurrency);
                if (Math.abs(balance) > 0.01) {
                    allSettled = false;
                    if (balance > 0) {
                        balanceEl.className = 'text-green-600';
                        balanceEl.textContent = `${profile.displayName} is owed ${formattedBalance}`;
                    } else {
                        balanceEl.className = 'text-red-600';
                        balanceEl.textContent = `${profile.displayName} owes ${formattedBalance}`;
                    }
                } else {
                    balanceEl.className = 'text-gray-500';
                    balanceEl.textContent = `${profile.displayName} is settled up`;
                }
                dom.tripView.balancesContainer.appendChild(balanceEl);
            });

            const tripRef = doc(db, "trips", currentTripId);
            if (allSettled !== currentTripData.isSettled) {
                updateDoc(tripRef, { isSettled: allSettled });
            }
        }
        
        function simplifyDebts(balances) {
            const debtors = [];
            const creditors = [];
            Object.entries(balances).forEach(([person, amount]) => {
                if (amount < -0.01) debtors.push({ person, amount: -amount });
                if (amount > 0.01) creditors.push({ person, amount });
            });

            debtors.sort((a, b) => b.amount - a.amount);
            creditors.sort((a, b) => b.amount - a.amount);

            const transactions = [];
            let i = 0, j = 0;
            while (i < debtors.length && j < creditors.length) {
                const debtor = debtors[i];
                const creditor = creditors[j];
                const amount = Math.min(debtor.amount, creditor.amount);
                
                transactions.push({ from: debtor.person, to: creditor.person, amount });

                debtor.amount -= amount;
                creditor.amount -= amount;

                if (debtor.amount < 0.01) i++;
                if (creditor.amount < 0.01) j++;
            }
            return transactions;
        }
        
        dom.tripView.settleUpBtn.addEventListener('click', () => {
             const balances = calculateBalances();
             const transactions = simplifyDebts(balances);
             dom.settleUpList.innerHTML = '';
             if (transactions.length === 0) {
                 dom.settleUpList.innerHTML = '<p class="text-center text-gray-500">Everyone is settled up!</p>';
             } else {
                 transactions.forEach(t => {
                     const fromName = memberProfilesCache[t.from].displayName;
                     const toName = memberProfilesCache[t.to].displayName;
                     const transactionEl = document.createElement('div');
                     transactionEl.className = 'flex justify-between items-center bg-gray-50 p-3 rounded-md';
                     transactionEl.innerHTML = `
                        <span><strong>${fromName}</strong> pays <strong>${toName}</strong></span>
                        <div class="flex items-center">
                            <span class="font-bold mr-4">${formatCurrency(t.amount, currentTripData.baseCurrency)}</span>
                            <button class="record-payment-btn py-1 px-3 bg-green-500 text-white text-sm rounded-full hover:bg-green-600" data-from="${t.from}" data-to="${t.to}" data-amount="${t.amount}">Paid</button>
                        </div>
                     `;
                     dom.settleUpList.appendChild(transactionEl);
                 });
             }
             toggleModal(dom.modals.settleUp, true);
        });

        dom.settleUpList.addEventListener('click', async (e) => {
             if (e.target.classList.contains('record-payment-btn')) {
                 const { from, to, amount } = e.target.dataset;
                 const payment = {
                     from,
                     to,
                     amount: parseFloat(amount),
                     paidAt: Timestamp.now(),
                     isDeleted: false
                 };
                 const tripRef = doc(db, "trips", currentTripId);
                 await updateDoc(tripRef, {
                     settledPayments: arrayUnion(payment)
                 });
                 e.target.closest('.flex').innerHTML = '<span class="text-green-600 font-semibold">Paid!</span>';
             }
        });
        
        dom.tripView.visualiseBtn.addEventListener('click', () => {
            const balances = calculateBalances();
            const transactions = simplifyDebts(balances);

            dom.visualise.owes.innerHTML = '';
            dom.visualise.owed.innerHTML = '';
            dom.visualise.settle.innerHTML = '';

            const debtors = Object.entries(balances).filter(([_, b]) => b < -0.01);
            const creditors = Object.entries(balances).filter(([_, b]) => b > 0.01);

            if (debtors.length > 0) {
                debtors.forEach(([uid, balance]) => {
                    dom.visualise.owes.innerHTML += `<p>${memberProfilesCache[uid].displayName}: <span class="font-semibold">${formatCurrency(Math.abs(balance), currentTripData.baseCurrency)}</span></p>`;
                });
            } else {
                dom.visualise.owes.innerHTML = '<p class="text-gray-500 text-center">None</p>';
            }
            
            if (creditors.length > 0) {
                creditors.forEach(([uid, balance]) => {
                    dom.visualise.owed.innerHTML += `<p>${memberProfilesCache[uid].displayName}: <span class="font-semibold">${formatCurrency(balance, currentTripData.baseCurrency)}</span></p>`;
                });
            } else {
                dom.visualise.owed.innerHTML = '<p class="text-gray-500 text-center">None</p>';
            }

            if (transactions.length > 0) {
                transactions.forEach(t => {
                     dom.visualise.settle.innerHTML += `<p>${memberProfilesCache[t.from].displayName} <i class="fas fa-long-arrow-alt-right text-blue-500"></i> ${memberProfilesCache[t.to].displayName}: <span class="font-bold">${formatCurrency(t.amount, currentTripData.baseCurrency)}</span></p>`;
                });
            } else {
                dom.visualise.settle.innerHTML = '<p class="text-green-600 text-center font-semibold">Everyone is settled up!</p>';
            }
            
            toggleModal(dom.modals.visualise, true);
        });
        
        dom.app.userProfilePic.addEventListener('click', () => toggleModal(dom.modals.userProfile, true));
        dom.forms.userProfile.changeBtn.addEventListener('click', () => dom.forms.userProfile.uploadInput.click());
        dom.forms.userProfile.uploadInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    dom.forms.userProfile.pic.src = e.target.result;
                }
                reader.readAsDataURL(file);
            }
        });
        dom.forms.userProfile.saveBtn.addEventListener('click', async () => {
            const newName = dom.forms.userProfile.nameInput.value;
            const file = dom.forms.userProfile.uploadInput.files[0];
            
            try {
                let photoURL = memberProfilesCache[currentUser.uid].photoURL;
                if (file) {
                    const storageRef = ref(storage, `profile_pictures/${currentUser.uid}`);
                    await uploadBytes(storageRef, file);
                    photoURL = await getDownloadURL(storageRef);
                }
                await updateProfile(auth.currentUser, { displayName: newName, photoURL: photoURL });
                await updateDoc(doc(db, "users", currentUser.uid), { displayName: newName, photoURL: photoURL });
                
                delete memberProfilesCache[currentUser.uid];

                await fetchAndDisplayProfile();
                toggleModal(dom.modals.userProfile, false);
            } catch (error) {
                console.error("Profile update error:", error);
                alert("Failed to update profile.");
            }
        });

        dom.app.logoutBtn.addEventListener('click', async () => {
            await signOut(auth);
            toggleModal(dom.modals.userProfile, false);
        });

        dom.tripView.inviteMemberBtn.addEventListener('click', () => {
             dom.forms.inviteStatusMsg.textContent = '';
             dom.forms.inviteEmailInput.value = '';
             toggleModal(dom.modals.inviteMember, true);
        });

        dom.forms.inviteMember.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = dom.forms.inviteEmailInput.value.trim();
            dom.forms.inviteStatusMsg.textContent = '';
            
            const q = query(collection(db, "users"), where("email", "==", email));
            const querySnapshot = await getDocs(q);

            if (querySnapshot.empty) {
                dom.forms.inviteStatusMsg.textContent = 'User not found.';
                dom.forms.inviteStatusMsg.className = 'text-red-500 text-sm mt-4 text-center';
                return;
            }
            
            const userToInvite = querySnapshot.docs[0];
            if (currentTripData.memberIds.includes(userToInvite.id)) {
                dom.forms.inviteStatusMsg.textContent = 'User is already in the trip.';
                dom.forms.inviteStatusMsg.className = 'text-yellow-600 text-sm mt-4 text-center';
                return;
            }

            const tripRef = doc(db, "trips", currentTripId);
            await updateDoc(tripRef, {
                memberIds: arrayUnion(userToInvite.id)
            });
            dom.forms.inviteStatusMsg.textContent = 'User invited successfully!';
            dom.forms.inviteStatusMsg.className = 'text-green-600 text-sm mt-4 text-center';
            dom.forms.inviteEmailInput.value = '';
        });

        function formatCurrency(amount, currencyCode) {
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: currencyCode }).format(amount);
        }

    </script>
</body>
</html>
