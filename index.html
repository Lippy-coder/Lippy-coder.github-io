<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Splitify - Bill Splitting Made Easy</title>
    <link rel="icon" href="https://firebasestorage.googleapis.com/v0/b/splitify-2ec5e.appspot.com/o/splitifylogo.jpeg?alt=media&token=72378b49-0e42-4fc2-bd35-4d4264701419">
    <link rel="apple-touch-icon" href="https://firebasestorage.googleapis.com/v0/b/splitify-2ec5e.appspot.com/o/splitifylogo.jpeg?alt=media&token=72378b49-0e42-4fc2-bd35-4d4264701419">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.1/dist/browser-image-compression.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <style>
        /* Custom styles */
        body { font-family: 'Inter', sans-serif; }
        .view { transition: opacity 0.3s ease-in-out; }
        .hidden-view { display: none !important; opacity: 0; }
        .modal-overlay { transition: opacity 0.3s ease-in-out; z-index: 40; }
        .spinner, .mini-spinner { border: 4px solid rgba(0, 0, 0, 0.1); border-radius: 50%; border-left-color: #ffffff; animation: spin 1s ease infinite; }
        .spinner { width: 24px; height: 24px; }
        .mini-spinner { width: 16px; height: 16px; border-width: 2px; border-left-color: #4f46e5; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .chevron-icon { transition: transform 0.2s ease-in-out; }
        .profile-pic-wrapper { position: relative; cursor: pointer; }
        .profile-pic-overlay { position: absolute; inset: 0; background-color: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.2s ease-in-out; border-radius: 9999px; }
        .profile-pic-wrapper:hover .profile-pic-overlay { opacity: 1; }
        .modal-open { overflow: hidden; }
        #camera-view video { width: 100%; height: auto; max-height: 70vh; border-radius: 0.5rem; }
        .toggle-switch:checked ~ .dot { transform: translateX(100%); background-color: #4f46e5; }
        .toggle-switch:checked ~ .block { background-color: #a5b4fc; }
        #fab-container.open #fab-icon-plus { transform: rotate(45deg); }
        #fab-container.open #fab-manual-add { transform: translateY(-95px); opacity: 1; pointer-events: auto; }
        #fab-container.open #fab-camera-scan { transform: translate(-67px, -67px); opacity: 1; pointer-events: auto; }
        #fab-container.open #fab-gallery-upload { transform: translateX(-95px); opacity: 1; pointer-events: auto; }
        #fab-container.open #fab-feedback { transform: translate(-95px, -95px); opacity: 1; pointer-events: auto; }
        .manual-payment-area { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-in-out, margin-top 0.3s ease-in-out; }
        .manual-payment-area.open { max-height: 100px; margin-top: 0.75rem; }
        .dropdown-menu { transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out; }
        #trip-supremo-btn.active { background-color: #e0e7ff; color: #4338ca; }
        .action-sheet-panel { transition: transform 0.3s ease-in-out; transform: translateY(100%); }
        #action-sheet-modal:not(.hidden-view) .action-sheet-panel { transform: translateY(0); }
        .item-assignment-avatar { transition: all 0.2s ease-in-out; border: 2px solid transparent; }
        .item-assignment-avatar.assigned { border-color: #4f46e5; transform: scale(1.1); }
        #ai-report-content h2 { font-size: 1.25rem; font-weight: 700; margin-top: 1rem; margin-bottom: 0.5rem; }
        #ai-report-content h3 { font-size: 1.1rem; font-weight: 600; margin-top: 0.75rem; margin-bottom: 0.25rem; }
        #ai-report-content ul { list-style-type: disc; margin-left: 1.5rem; }
        #ai-report-content li { margin-bottom: 0.25rem; }
        #ai-report-content strong { font-weight: 700; }
        #ai-report-content pre { background-color: #f3f4f6; padding: 0.75rem; border-radius: 0.375rem; font-size: 0.75rem; white-space: pre-wrap; word-break: break-all; }
        .info-icon { cursor: help; position: relative; display: inline-flex; align-items: center; justify-content: center; margin-left: 8px; width: 16px; height: 16px; border-radius: 50%; background-color: #e0e7ff; color: #4338ca; font-size: 10px; font-weight: bold; }
        .info-icon .tooltip-text { visibility: hidden; width: 220px; background-color: #374151; color: #fff; text-align: center; border-radius: 6px; padding: 8px; position: absolute; z-index: 1; bottom: 125%; left: 50%; margin-left: -110px; opacity: 0; transition: opacity 0.3s; font-size: 12px; font-weight: normal; }
        .info-icon:hover .tooltip-text { visibility: visible; opacity: 1; }
        .companion-item.selected { background-color: #e0e7ff; }
        #scan-qr-video-feed { width: 100%; max-height: 70vh; border-radius: 0.5rem; }
        .golden-halo { box-shadow: 0 0 0 3px #FFD700; }
        .segmented-control { display: flex; background-color: #e5e7eb; padding: 4px; border-radius: 0.5rem; }
        .segmented-control button { flex: 1; padding: 0.5rem 0; border-radius: 0.375rem; font-weight: 600; color: #4b5563; transition: background-color 0.2s, color 0.2s; border: none; background: none; }
        .segmented-control button.active { background-color: white; color: #1f2937; box-shadow: 0 1px 3px 0 rgba(0,0,0,0.1), 0 1px 2px 0 rgba(0,0,0,0.06); }
        .tab-panel.hidden { display: none; }
        .member-avatar-wrapper { position: relative; }
        .remove-icon-overlay { position: absolute; top: -4px; right: -4px; opacity: 0; transition: opacity 0.2s ease-in-out; }
        .member-avatar-wrapper:hover .remove-icon-overlay { opacity: 1; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    <div class="w-full max-w-4xl mx-auto p-4 sm:p-6">
        <!-- Authentication View -->
        <div id="auth-view" class="view">
            <div class="text-center mb-8 mt-16">
                <h1 class="text-4xl font-bold text-blue-600">Splitify</h1>
                <p class="text-gray-500 mt-4">Sign in or create an account to start splitting bills.</p>
            </div>
            <div class="bg-white p-8 rounded-xl shadow-md max-w-md mx-auto">
                <div id="auth-message-area" class="hidden mb-4 p-3 rounded-md bg-yellow-100 text-yellow-800 text-sm"></div>
                <div class="flex border-b mb-6">
                    <button type="button" id="login-tab-btn" class="flex-1 py-2 font-semibold text-blue-600 border-b-2 border-blue-600">Login</button>
                    <button type="button" id="register-tab-btn" class="flex-1 py-2 font-semibold text-gray-500">Register</button>
                </div>
                <form id="login-form">
                    <div class="mb-4">
                        <label for="login-email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input type="email" id="login-email" required class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="you@example.com" autocomplete="email">
                    </div>
                    <div class="mb-6">
                        <div class="flex justify-between items-center mb-1">
                            <label for="login-password" class="block text-sm font-medium text-gray-700">Password</label>
                            <a href="#" id="forgot-password-link" class="text-sm text-blue-600 hover:underline">Forgot?</a>
                        </div>
                        <input type="password" id="login-password" required class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="••••••••" autocomplete="current-password">
                    </div>
                    <button type="submit" id="login-btn" class="w-full bg-blue-600 text-white py-2 rounded-md font-semibold hover:bg-blue-700">Login</button>
                </form>
                <form id="register-form" class="hidden">
                    <div class="mb-4">
                        <label for="register-name" class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                        <input type="text" id="register-name" required class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="John Doe" autocomplete="name">
                    </div>
                    <div class="mb-4">
                        <label for="register-email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input type="email" id="register-email" required class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="you@example.com" autocomplete="email">
                    </div>
                    <div class="mb-4">
                        <label for="register-password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                        <input type="password" id="register-password" required class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="Minimum 6 characters" autocomplete="new-password">
                    </div>
                    <div class="mb-6">
                        <label for="register-referrer-email" class="block text-sm font-medium text-gray-700 mb-1">Referrer's Email</label>
                        <input type="email" id="register-referrer-email" required class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="friend@example.com" autocomplete="off">
                        <p class="text-xs text-gray-500 mt-1">The email address of an existing Splitify user who invited you.</p>
                    </div>
                    <button type="submit" id="register-btn" class="w-full bg-blue-600 text-white py-2 rounded-md font-semibold hover:bg-blue-700">Create Account</button>
                </form>
            </div>
        </div>

        <!-- Dashboard View -->
        <div id="dashboard-view" class="view hidden-view py-8">
            <header class="flex flex-col sm:flex-row justify-between items-center mb-8 gap-4">
                <h1 class="text-3xl font-bold text-blue-600">Splitify</h1>
                <div class="flex items-center">
                    <span id="welcome-message" class="text-gray-600 mr-4 text-center"></span>
                    <div id="profile-area" class="relative"></div>
                </div>
            </header>
            <main>
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">My Trips</h2>
                    <div class="flex items-center space-x-3">
                        <button id="create-trip-btn" title="New Trip" class="flex flex-col items-center justify-center w-14 h-14 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition-colors">
                            <svg viewBox="0 0 64 64" fill="currentColor" xmlns="http://www.w3.org/2000/svg" class="w-6 h-6">
                                <path d="M54 16H10c-2.2 0-4 1.8-4 4v8c2.2 0 4 1.8 4 4s-1.8 4-4 4v8c0 2.2 1.8 4 4 4h44c2.2 0 4-1.8 4-4V20c0-2.2-1.8-4-4-4z"></path>
                                <text x="32" y="36" font-family="Inter, sans-serif" font-size="12" font-weight="bold" text-anchor="middle" fill="white">NEW</text>
                            </svg>
                            <span class="text-xs mt-1">New Trip</span>
                        </button>
                        <button id="open-feedback-hub-btn" title="Ideas & Feedback" class="flex flex-col items-center justify-center w-14 h-14 bg-purple-600 text-white rounded-lg font-semibold hover:bg-purple-700 transition-colors">
                           <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                             <path stroke-linecap="round" stroke-linejoin="round" d="M8.625 12a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H8.25m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H12m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0h-.375M21 12c0 4.556-4.03 8.25-9 8.25a9.76 9.76 0 01-2.53-.388A.75.75 0 008.25 20.25l.438-2.55a.75.75 0 00-.416-.833A9.76 9.76 0 013 12c0-4.556 4.03-8.25 9-8.25s9 3.694 9 8.25z" />
                           </svg>
                           <span class="text-xs mt-1">Feedback</span>
                        </button>
                        <button id="show-my-qr-code-icon-btn" title="Show My Join Code" class="flex flex-col items-center justify-center w-14 h-14 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition-colors">
                            <svg viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg" class="w-6 h-6">
                                <path d="M5 5h4v4H5z M15 5h4v4h-4z M5 15h4v4H5z"/>
                                <path d="M11 5h2v2h-2z M5 11h2v2H5z M11 11h2v2h-2z M17 11h2v2h-2z M11 17h2v2h-2z"/>
                                <path d="M15 15h4v4h-4z" fill="#4ade80"/>
                                <path d="M16 16h2v2h-2z" fill="currentColor"/>
                            </svg>
                           <span class="text-xs mt-1">Join by QR</span>
                        </button>
                    </div>
                </div>
                <div id="trips-list" class="space-y-4">
                    <p id="no-trips-message" class="text-center text-gray-500 py-10 bg-white rounded-xl shadow-sm">You have no trips yet. Create one to get started!</p>
                </div>
            </main>
        </div>
        
        <!-- Trip Detail View -->
        <div id="trip-detail-view" class="view hidden-view py-8">
            <header class="mb-6">
                <button id="back-to-dashboard-btn" class="text-blue-600 hover:underline mb-4">&larr; Back to My Trips</button>
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                    <div>
                        <h2 id="trip-detail-name" class="text-3xl font-bold"></h2>
                        <div class="flex flex-col sm:flex-row sm:space-x-4 text-sm text-gray-500 mt-1">
                            <p id="trip-total-spent"></p>
                            <p id="trip-outstanding-balance" class="font-semibold"></p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-3">
                        <button id="ai-report-btn" title="Generate AI Trip Report" class="h-12 w-12 flex items-center justify-center bg-yellow-500 text-white rounded-full hover:bg-yellow-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-yellow-400 transition-transform transform hover:scale-110">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M7.5 8.25h9m-9 3H12m-9.75 1.51c0 1.6 1.123 2.994 2.707 3.227 1.129.166 2.27.293 3.423.379.35.026.67.21.865.501L12 21l2.755-4.133a1.14 1.14 0 01.865-.501 48.172 48.172 0 003.423-.379c1.584-.233 2.707-1.626 2.707-3.228V6.741c0-1.602-1.123-2.995-2.707-3.228A48.394 48.394 0 0012 3c-2.392 0-4.744.175-7.043.513C3.373 3.746 2.25 5.14 2.25 6.741v6.018z" />
                            </svg>
                        </button>
                        <button id="visualise-settlement-btn" title="Visualise Summary" class="h-12 w-12 flex items-center justify-center bg-indigo-600 text-white rounded-full hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-transform transform hover:scale-110">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-7 w-7">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v15M3 9h18M6 9V6.75a1.5 1.5 0 011.5-1.5h9a1.5 1.5 0 011.5 1.5V9" />
                              <path stroke-linecap="round" stroke-linejoin="round" d="M6 9l-2.25 6h4.5L6 9zm12 0l-2.25 6h4.5L18 9z" />
                              <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 21h7.5L12 18l-3.75 3z" />
                            </svg>
                        </button>
                        <button id="settle-up-btn" title="Settle Up" class="h-12 w-12 flex items-center justify-center bg-purple-600 text-white rounded-full hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition-transform transform hover:scale-110">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
                            </svg>
                        </button>
                        <div id="supremo-menu-container" class="relative hidden">
                            <button id="supremo-menu-btn" title="Trip Supremo Controls" class="h-12 w-12 flex items-center justify-center bg-gray-200 text-gray-600 rounded-full hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all transform hover:scale-110">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                  <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75m-3-7.036A11.959 11.959 0 013.598 6 11.99 11.99 0 003 9.749c0 5.592 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.571-.598-3.751h-.152c-3.196 0-6.1-1.248-8.25-3.286z" />
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </header>
            <main>
                <div class="mb-8 p-4 bg-white rounded-xl shadow-sm">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="font-bold text-lg">Trip Members</h3>
                        <button id="invite-member-btn" class="text-sm text-green-600 hover:underline font-semibold">Add Friend</button>
                    </div>
                    <div id="trip-members-list" class="flex flex-wrap gap-4">
                    </div>
                </div>
                <div id="trip-items-list" class="space-y-1">
                    <p id="no-items-message" class="text-center text-gray-500 py-10 bg-white rounded-xl shadow-sm">No expenses or payments logged for this trip yet.</p>
                </div>
            </main>
            <div id="fab-container" class="fixed bottom-6 right-6 sm:bottom-8 sm:right-8 z-30">
                <button id="fab-manual-add" title="Add Manually" class="absolute bottom-1 right-1 h-14 w-14 flex items-center justify-center bg-blue-600 text-white rounded-full shadow-md hover:bg-blue-700 transition-all duration-300 ease-in-out opacity-0 pointer-events-none transform">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                </button>
                <button id="fab-camera-scan" title="Scan with Camera" class="absolute bottom-1 right-1 h-14 w-14 flex items-center justify-center bg-teal-500 text-white rounded-full shadow-md hover:bg-teal-600 transition-all duration-300 ease-in-out opacity-0 pointer-events-none transform">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2-2H5a2 2 0 01-2-2V9z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                </button>
                <button id="fab-gallery-upload" title="Upload from Gallery" class="absolute bottom-1 right-1 h-14 w-14 flex items-center justify-center bg-indigo-500 text-white rounded-full shadow-md hover:bg-indigo-600 transition-all duration-300 ease-in-out opacity-0 pointer-events-none transform">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                </button>
                <button id="fab-toggle" title="Add Item" class="relative h-16 w-16 flex items-center justify-center bg-blue-600 text-white rounded-full shadow-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-transform transform hover:scale-110 z-10">
                    <div id="fab-icon-plus" class="transition-transform duration-300"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg></div>
                </button>
            </div>
        </div>

        <!-- Feedback Hub View -->
        <div id="feedback-hub-view" class="view hidden-view py-8">
            <header class="flex justify-between items-center mb-8">
                <div>
                    <button id="back-to-dashboard-from-feedback-btn" class="text-blue-600 hover:underline mb-2">&larr; Back to Dashboard</button>
                    <h1 class="text-3xl font-bold">Ideas & Feedback Hub</h1>
                    <p class="text-gray-500 mt-1">Vote on ideas or submit your own. Help us build a better Splitify!</p>
                </div>
                <button id="submit-new-idea-btn" class="bg-green-500 text-white px-5 py-3 rounded-md font-semibold hover:bg-green-600">+ Submit an Idea</button>
            </header>
            <main>
                <!-- Feedback items will be rendered here -->
                <div id="feedback-list" class="space-y-4">
                    <p class="text-center text-gray-500 py-10">Loading feedback...</p>
                </div>
            </main>
        </div>

        <div id="create-trip-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden-view"><div class="bg-white rounded-xl shadow-2xl m-4 w-full max-w-md p-8"><h3 class="text-2xl font-bold mb-6">Create a New Trip</h3><form id="create-trip-form"><div class="mb-4"><label for="trip-name" class="block text-sm font-medium text-gray-700 mb-1">Trip Name</label><input type="text" id="trip-name" required class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="e.g., Summer in Italy"></div><div class="mb-6"><label for="base-currency" class="block text-sm font-medium text-gray-700 mb-1">Base Currency</label><select id="base-currency" required class="w-full px-3 py-2 border border-gray-300 rounded-md bg-white"><option value="GBP">GBP (British Pound)</option><option value="USD">USD (US Dollar)</option><option value="EUR">EUR (Euro)</option><option value="JPY">JPY (Japanese Yen)</option><option value="CAD">CAD (Canadian Dollar)</option><option value="AUD">AUD (Australian Dollar)</option></select></div><div class="flex justify-end space-x-4"><button type="button" id="cancel-create-trip-btn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md font-semibold hover:bg-gray-300">Cancel</button><button type="submit" id="submit-create-trip-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md font-semibold hover:bg-blue-700">Create</button></div></form></div></div>
        <div id="add-expense-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden-view"><div class="bg-white rounded-xl shadow-2xl m-4 w-full max-w-lg p-8 max-h-[90vh] overflow-y-auto"><h3 class="text-2xl font-bold mb-6">Add an Expense</h3><form id="add-expense-form"><div class="mb-4"><label for="expense-description" class="block text-sm font-medium text-gray-700 mb-1">Description</label><div class="flex items-center"><input type="text" id="expense-description" required class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="e.g., Dinner, Museum tickets"><span id="ai-reasoning-tooltip" class="hidden"></span></div></div><div class="grid grid-cols-2 gap-4 mb-2"><div><label for="expense-amount" class="block text-sm font-medium text-gray-700 mb-1">Amount</label><input type="number" id="expense-amount" step="0.01" required class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="100.00"></div><div><label for="expense-currency" class="block text-sm font-medium text-gray-700 mb-1">Currency</label><select id="expense-currency" required class="w-full px-3 py-2 border border-gray-300 rounded-md bg-white"></select></div></div><div id="fx-conversion-display" class="h-6 mb-4 text-sm text-indigo-600 flex items-center"></div><div class="mb-4"><label for="expense-occurred-at" class="block text-sm font-medium text-gray-700 mb-1">Date & Time of Expense</label><input type="datetime-local" id="expense-occurred-at" required class="w-full px-3 py-2 border border-gray-300 rounded-md"></div><div class="mb-4"><label for="expense-category" class="block text-sm font-medium text-gray-700 mb-1">Category</label><div class="flex items-center space-x-2"><select id="expense-category" class="w-full px-3 py-2 border border-gray-300 rounded-md bg-white"><option value="">-- Select a Category --</option><option value="Food & Drink">Food & Drink</option><option value="Transport">Transport</option><option value="Accommodation">Accommodation</option><option value="Activities">Activities</option><option value="Shopping">Shopping</option><option value="Other">Other</option></select></div><div id="ai-category-spinner" class="mt-2 h-6 flex items-center hidden"></div></div><div class="mb-4"><label for="expense-paid-by" class="block text-sm font-medium text-gray-700 mb-1">Paid By</label><select id="expense-paid-by" required class="w-full px-3 py-2 border border-gray-300 rounded-md bg-white"></select></div><div id="split-mode-toggle-container" class="my-4 hidden"><button type="button" id="toggle-split-mode-btn" class="w-full text-center bg-gray-100 text-gray-800 text-sm font-semibold px-4 py-2 rounded-md hover:bg-gray-200">Switch to Split by Item</button></div><div id="itemized-split-section" class="hidden"><div class="flex justify-between items-center mb-2"><label class="block text-sm font-medium text-gray-700">Assign Items to Members</label></div><div id="itemized-list" class="space-y-3 p-3 border rounded-md bg-gray-50 max-h-48 overflow-y-auto"></div><div id="itemized-summary" class="mt-2 text-sm"></div></div><div id="equal-split-section" class="mb-6"><div class="flex justify-between items-center mb-2"><label class="block text-sm font-medium text-gray-700">Split Between</label><div class="space-x-4"><button type="button" id="deselect-all-btn" class="text-sm text-red-600 hover:underline font-semibold">Deselect All</button></div></div><div id="expense-split-between" class="space-y-2 p-2 border rounded-md bg-gray-50"></div><div id="split-total-validation" class="text-xs text-right mt-1 min-h-[1rem]"></div></div><div class="flex justify-end space-x-4"><button type="button" id="cancel-add-expense-btn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md font-semibold hover:bg-gray-300">Cancel</button><button type="submit" id="submit-expense-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md font-semibold hover:bg-blue-700 flex items-center justify-center w-36 h-10"><span class="btn-text">Add Expense</span><div class="spinner hidden"></div></button></div></form></div></div>
        <div id="edit-profile-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden-view"><div class="bg-white rounded-xl shadow-2xl m-4 w-full max-w-md p-8"><h3 class="text-2xl font-bold mb-6">Edit Profile & Payment Link</h3><form id="edit-profile-form"><div class="mb-4"><label for="profile-name" class="block text-sm font-medium text-gray-700 mb-1">Full Name</label><input type="text" id="profile-name" required class="w-full px-3 py-2 border border-gray-300 rounded-md"></div><div class="mb-4"><label for="payment-bank" class="block text-sm font-medium text-gray-700 mb-1">Payment App</label><select id="payment-bank" class="w-full px-3 py-2 border border-gray-300 rounded-md bg-white"><option value="">None</option><option value="Monzo">Monzo</option><option value="Revolut">Revolut</option></select></div><div class="mb-6"><label for="payment-username" class="block text-sm font-medium text-gray-700 mb-1">Payment Username</label><input type="text" id="payment-username" class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="e.g., johnsmith"><p class="text-xs text-gray-500 mt-1">Your Monzo username or Revtag, without the '@'.</p></div><div class="flex justify-end space-x-4"><button type="button" id="cancel-edit-profile-btn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md font-semibold hover:bg-gray-300">Cancel</button><button type="submit" id="confirm-edit-profile-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md font-semibold hover:bg-blue-700">Save Profile</button></div></form></div></div>
        <div id="edit-expense-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden-view"><div class="bg-white rounded-xl shadow-2xl m-4 w-full max-w-md p-8"><h3 class="text-2xl font-bold mb-6">Edit Expense Description</h3><form id="edit-expense-form"><input type="hidden" id="edit-expense-id"><div class="mb-4"><label for="edit-expense-description" class="block text-sm font-medium text-gray-700 mb-1">Description</label><input type="text" id="edit-expense-description" required class="w-full px-3 py-2 border border-gray-300 rounded-md"></div><div class="flex justify-end space-x-4"><button type="button" id="cancel-edit-expense-btn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md font-semibold hover:bg-gray-300">Cancel</button><button type="submit" id="confirm-edit-expense-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md font-semibold hover:bg-blue-700">Save</button></div></form></div></div>
        
        <!-- "Add Friend" Modal using Segmented Control -->
        <div id="invite-member-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden-view">
            <div class="bg-gray-50 rounded-lg shadow-xl w-full max-w-md max-h-[90vh] flex flex-col transform scale-95 transition-transform duration-300">
                <!-- Header -->
                <div class="p-5 border-b border-gray-200 flex-shrink-0 relative">
                    <h3 class="text-xl font-bold text-center text-gray-900">Add Friends to Trip</h3>
                    <button id="close-invite-modal-x-btn" type="button" class="absolute top-3 right-3 h-8 w-8 rounded-full flex items-center justify-center text-gray-500 hover:bg-gray-200">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>

                <!-- Segmented Control -->
                <div class="p-4 flex-shrink-0">
                    <div class="segmented-control flex bg-gray-200 p-1 rounded-lg">
                        <button data-tab="frequent" class="flex-1 py-1.5 rounded-md font-semibold text-sm active">Frequent</button>
                        <button data-tab="email" class="flex-1 py-1.5 rounded-md font-semibold text-sm">By Email</button>
                        <button data-tab="scan" class="flex-1 py-1.5 rounded-md font-semibold text-sm">Scan QR</button>
                    </div>
                </div>

                <!-- Content Panels -->
                <div class="px-6 pb-6 flex-grow overflow-y-auto">
                    <!-- Panel 1: Frequent Friends -->
                    <div id="panel-frequent" class="tab-panel active">
                        <input type="search" id="companion-search" class="w-full px-3 py-2 border border-gray-300 rounded-md mb-4" placeholder="Search past companions...">
                        <div id="companion-list-container" class="space-y-2 max-h-60 overflow-y-auto"></div>
                    </div>
                    <!-- Panel 2: Invite by Email -->
                    <div id="panel-email" class="tab-panel hidden">
                        <form id="invite-member-form">
                            <label for="invite-email" class="block text-sm font-medium text-gray-700 mb-1">Invite by Email</label>
                            <p id="invite-helper-text" class="text-xs text-gray-500 mb-3">Enter an email. We'll add them if they're a member, or help you create an invite if they're new.</p>
                            <input type="email" id="invite-email" required class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="friend@example.com">
                            
                            <div id="invite-name-wrapper" class="hidden mt-4">
                                <label for="invite-name" class="block text-sm font-medium text-gray-700 mb-1">Friend's Full Name</label>
                                <input type="text" id="invite-name" class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="Jane Doe">
                            </div>
                            
                            <button type="submit" id="submit-invite-btn" class="w-full mt-4 bg-indigo-600 text-white py-2.5 rounded-md font-semibold hover:bg-indigo-700 flex items-center justify-center h-10">
                                <span class="btn-text">Check Email & Invite</span>
                                <div class="spinner hidden"></div>
                            </button>
                        </form>
                    </div>
                    <!-- Panel 3: Scan QR -->
                    <div id="panel-scan" class="tab-panel hidden text-center pt-4">
                         <svg class="mx-auto h-16 w-16 text-gray-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 4.875c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5A1.125 1.125 0 013.75 9.375v-4.5zM3.75 14.625c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5a1.125 1.125 0 01-1.125-1.125v-4.5zM13.5 4.875c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5a1.125 1.125 0 01-1.125-1.125v-4.5z" /><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 14.625c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5a1.125 1.125 0 01-1.125-1.125v-4.5z" /></svg>
                        <p class="mt-2 font-semibold">Scan a friend's Join Code</p>
                        <p class="text-sm text-gray-500 mt-1">Ask your friend to show their QR code from the dashboard.</p>
                        <button type="button" id="scan-qr-code-btn" class="w-full mt-4 bg-teal-600 text-white py-2.5 rounded-md font-semibold hover:bg-teal-700">Open Camera Scanner</button>
                    </div>
                </div>

                <!-- Footer -->
                <div class="p-4 bg-gray-100 border-t border-gray-200 flex-shrink-0 flex justify-between items-center">
                    <button type="button" id="cancel-invite-btn" class="bg-gray-200 text-gray-800 px-5 py-2 rounded-md font-semibold hover:bg-gray-300">Cancel</button>
                    <button type="button" id="add-selected-companions-btn" class="bg-blue-600 text-white px-5 py-2 rounded-md font-semibold hover:bg-blue-700 disabled:bg-gray-400" disabled>Add Selected (0)</button>
                </div>
            </div>
        </div>

        <div id="archive-trip-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden-view"><div class="bg-white rounded-xl shadow-2xl m-4 w-full max-w-md p-8"><h3 class="text-2xl font-bold mb-2">Archive Trip</h3><p class="text-gray-600 mb-6">Are you sure you want to archive "<span id="archive-trip-name" class="font-semibold"></span>"? This will hide the trip from your dashboard, but all data will be saved.</p><div class="flex justify-end space-x-4"><button type="button" id="cancel-archive-trip-btn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md font-semibold hover:bg-gray-300">Cancel</button><button type="button" id="confirm-archive-trip-btn" class="bg-orange-600 text-white px-4 py-2 rounded-md font-semibold hover:bg-orange-700">Archive Trip</button></div></div></div>
        <div id="delete-expense-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden-view"><div class="bg-white rounded-xl shadow-2xl m-4 w-full max-w-md p-8"><h3 class="text-2xl font-bold mb-2">Delete Expense</h3><p class="text-gray-600 mb-6">Are you sure you want to delete this expense? It will be removed from calculations but remain visible in the list.</p><div class="flex justify-end space-x-4"><button type="button" id="cancel-delete-expense-btn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md font-semibold hover:bg-gray-300">Cancel</button><button type="button" id="confirm-delete-expense-btn" class="bg-red-600 text-white px-4 py-2 rounded-md font-semibold hover:bg-red-700">Delete Expense</button></div></div></div>
        <div id="delete-payment-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden-view"><div class="bg-white rounded-xl shadow-2xl m-4 w-full max-w-md p-8"><h3 class="text-2xl font-bold mb-2">Delete Payment</h3><p class="text-gray-600 mb-6">Are you sure you want to delete this payment record? It will be removed from calculations but remain visible in the list.</p><div class="flex justify-end space-x-4"><button type="button" id="cancel-delete-payment-btn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md font-semibold hover:bg-gray-300">Cancel</button><button type="button" id="confirm-delete-payment-btn" class="bg-red-600 text-white px-4 py-2 rounded-md font-semibold hover:bg-red-700">Delete Payment</button></div></div></div>
        <div id="settle-up-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden-view"><div class="bg-white rounded-xl shadow-2xl m-4 w-full max-w-lg p-8 flex flex-col max-h-[90vh]"><div class="flex justify-between items-center mb-2 flex-shrink-0"><h3 class="text-2xl font-bold">Time to Settle Up!</h3><button type="button" id="close-settle-up-btn-x" class="h-8 w-8 rounded-full flex items-center justify-center text-gray-500 hover:bg-gray-200 hover:text-gray-800 transition-colors"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button></div><p id="settlement-currency" class="text-sm text-gray-500 mb-4"></p><p id="settlement-summary" class="text-gray-600 mb-6 flex-shrink-0"></p><div id="settlement-list" class="space-y-4 overflow-y-auto flex-grow"></div><div class="flex justify-end mt-8 flex-shrink-0"><button type="button" id="close-settle-up-btn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md font-semibold hover:bg-gray-300">Close</button></div></div></div>
        <div id="settlement-visualisation-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden-view"><div class="bg-white rounded-xl shadow-2xl m-4 w-full max-w-md p-6 flex flex-col"><div class="flex-shrink-0"><div class="flex justify-between items-center mb-2"><h3 class="text-xl font-bold">Summary Balances</h3><button type="button" id="close-visualisation-btn" class="text-gray-500 hover:text-gray-800 text-2xl leading-none">&times;</button></div><p id="visualisation-currency" class="text-sm text-gray-500 mb-4"></p></div><div class="space-y-3 max-h-[60vh] overflow-y-auto pr-2"><div id="viz-debtors" class="p-3 bg-red-50 rounded-lg"><h4 class="font-bold text-red-800">Who Owes</h4><div id="viz-debtors-list" class="mt-2 space-y-1 text-sm"></div></div><div class="flex justify-center items-center py-2"><svg class="w-6 h-6 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 13.5L12 21m0 0l-7.5-7.5M12 21V3" /></svg></div><div id="viz-payments" class="p-3 bg-indigo-50 rounded-lg"><h4 class="font-bold text-indigo-800">Payments to Make</h4><div id="viz-payments-list" class="mt-2 space-y-2 text-sm"></div></div><div class="flex justify-center items-center py-2"><svg class="w-6 h-6 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 13.5L12 21m0 0l-7.5-7.5M12 21V3" /></svg></div><div id="viz-creditors" class="p-3 bg-green-50 rounded-lg"><h4 class="font-bold text-green-800">Who Gets Paid</h4><div id="viz-creditors-list" class="mt-2 space-y-1 text-sm"></div></div></div></div></div>
        <div id="ai-scan-modal" class="modal-overlay fixed inset-0 bg-black flex items-center justify-center z-40 hidden-view"><div class="relative w-full max-w-2xl h-full flex flex-col items-center justify-center p-4"><video id="camera-feed" playsinline class="rounded-lg"></video><canvas id="camera-canvas" class="hidden"></canvas><div class="absolute bottom-8 left-0 right-0 flex justify-center items-center space-x-8"><button id="ai-cancel-btn" class="w-16 h-16 bg-white bg-opacity-30 text-white rounded-full flex items-center justify-center text-xl">&times;</button><button id="ai-capture-btn" class="w-20 h-20 bg-white rounded-full border-4 border-gray-400 focus:outline-none"></button></div></div></div>
        <div id="action-sheet-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex flex-col justify-end z-50 hidden-view"><div class="action-sheet-panel w-full bg-gray-100 rounded-t-2xl p-4"><div class="bg-white rounded-xl"><div class="p-4 flex items-center"><label for="supremo-toggle-action-sheet" class="flex-1 text-lg text-gray-800">Enable Editing</label><div class="relative"><input type="checkbox" id="supremo-toggle-action-sheet" class="sr-only toggle-switch"><div class="block bg-gray-600 w-10 h-6 rounded-full"></div><div class="dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition"></div></div></div><div class="border-t border-gray-200"></div><button id="action-sheet-archive-btn" class="w-full text-left p-4 text-lg text-gray-800">Archive Trip</button><div class="border-t border-gray-200"></div><button id="action-sheet-email-btn" class="w-full text-left p-4 text-lg text-gray-800">Email Members</button></div><button id="action-sheet-cancel-btn" class="w-full mt-3 bg-white rounded-xl p-4 text-lg text-blue-600 font-semibold">Cancel</button></div></div>
        <div id="ai-report-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden-view"><div class="bg-white rounded-xl shadow-2xl m-4 w-full max-w-md p-8"><h3 class="text-2xl font-bold mb-6">Generate AI Trip Report</h3><form id="ai-report-form"><div class="mb-4"><label for="ai-report-type" class="block text-sm font-medium text-gray-700 mb-1">Choose a Report Type</label><select id="ai-report-type" class="w-full px-3 py-2 border border-gray-300 rounded-md bg-white"><option value="spending_analysis">Spending Analysis</option><option value="spreadsheet_data">Data for Spreadsheet (CSV)</option><option value="fun_awards">Fun Awards</option><option value="custom_question">Your own question...</option></select></div><div id="custom-question-area" class="mb-6 hidden"><label for="ai-report-question" class="block text-sm font-medium text-gray-700 mb-1">Ask a Specific Question</label><textarea id="ai-report-question" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="e.g., How much did we spend on just wine?"></textarea></div><div class="flex justify-end space-x-4"><button type="button" id="cancel-ai-report-btn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md font-semibold hover:bg-gray-300">Cancel</button><button type="submit" id="submit-ai-report-btn" class="bg-yellow-500 text-white px-4 py-2 rounded-md font-semibold hover:bg-yellow-600">Generate Report</button></div></form></div></div>
        <div id="ai-report-display-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden-view"><div class="bg-white rounded-xl shadow-2xl m-4 w-full max-w-2xl p-8 flex flex-col max-h-[90vh]"><div class="flex justify-between items-center mb-4 flex-shrink-0"><h3 class="text-2xl font-bold">Your Trip Report ✨</h3><button type="button" id="close-ai-display-btn-x" class="h-8 w-8 rounded-full flex items-center justify-center text-gray-500 hover:bg-gray-200 hover:text-gray-800 transition-colors"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button></div><div id="ai-report-content" class="prose max-w-none overflow-y-auto flex-grow text-gray-700"></div><div class="flex justify-end mt-8 space-x-4 flex-shrink-0"><button type="button" id="copy-ai-report-btn" class="bg-gray-600 text-white px-4 py-2 rounded-md font-semibold hover:bg-gray-700">Copy to Clipboard</button><button type="button" id="close-ai-display-btn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md font-semibold hover:bg-gray-300">Close</button></div></div></div>
        
        <div id="show-qr-code-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden-view">
            <div class="bg-white rounded-xl shadow-2xl m-4 p-8 text-center flex flex-col items-center">
                <div id="my-qr-code-profile" class="flex items-center space-x-4 mb-4"></div>
                <canvas id="my-qr-code-canvas"></canvas>
                <p class="text-gray-600 mt-4 max-w-xs">Have a trip member scan this code to add you to their trip.</p>
                <button type="button" id="close-my-qr-code-btn" class="mt-6 bg-gray-200 text-gray-800 px-4 py-2 rounded-md font-semibold hover:bg-gray-300">Close</button>
            </div>
        </div>

        <div id="scan-qr-code-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden-view">
            <div class="bg-white rounded-xl shadow-2xl m-4 w-full max-w-md p-4 text-center">
                <h3 class="text-xl font-bold mb-4">Scan a Friend's Join Code</h3>
                <video id="scan-qr-video-feed" playsinline></video>
                <canvas id="scan-qr-canvas-hidden" class="hidden"></canvas>
                <button type="button" id="cancel-scan-qr-btn" class="mt-4 bg-gray-200 text-gray-800 px-4 py-2 rounded-md font-semibold hover:bg-gray-300">Cancel</button>
            </div>
        </div>
        
        <div id="submit-feedback-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden-view">
            <div class="bg-white rounded-xl shadow-2xl m-4 w-full max-w-lg p-8">
                <h3 class="text-2xl font-bold mb-6">Submit your Idea or Bug Report</h3>
                <form id="submit-feedback-form">
                    <div class="mb-4">
                        <label for="feedback-title" class="block text-sm font-medium text-gray-700 mb-1">Title</label>
                        <input type="text" id="feedback-title" required class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="e.g., Add trip budgets">
                    </div>
                    <div class="mb-4">
                        <label for="feedback-type-submit" class="block text-sm font-medium text-gray-700 mb-1">Type</label>
                        <select id="feedback-type-submit" required class="w-full px-3 py-2 border border-gray-300 rounded-md bg-white">
                            <option value="Suggestion">New Requirement / Suggestion</option>
                            <option value="Bug">Bug Report</option>
                            <option value="Comment">General Comment</option>
                        </select>
                    </div>
                    <div class="mb-6">
                        <label for="feedback-description-submit" class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                        <textarea id="feedback-description-submit" rows="5" required class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="Please describe your idea in detail. If it's a bug, what were you doing when it happened?"></textarea>
                    </div>
                    <div class="flex justify-end space-x-4">
                        <button type="button" id="cancel-submit-feedback-btn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md font-semibold hover:bg-gray-300">Cancel</button>
                        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md font-semibold hover:bg-blue-700">Submit Idea</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="remove-member-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden-view">
            <div class="bg-white rounded-xl shadow-2xl m-4 w-full max-w-md p-8">
                <h3 class="text-2xl font-bold mb-2">Remove Member</h3>
                <p class="text-gray-600 mb-6">Are you sure you want to remove "<span id="remove-member-name" class="font-semibold"></span>" from the trip? This member has no financial history and this action cannot be undone.</p>
                <div class="flex justify-end space-x-4">
                    <button type="button" id="cancel-remove-member-btn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md font-semibold hover:bg-gray-300">Cancel</button>
                    <button type="button" id="confirm-remove-member-btn" class="bg-red-600 text-white px-4 py-2 rounded-md font-semibold hover:bg-red-700">Confirm Remove</button>
                </div>
            </div>
        </div>

        <div id="delete-account-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden-view">
            <div class="bg-white rounded-xl shadow-2xl m-4 w-full max-w-md p-8">
                <h3 class="text-2xl font-bold mb-2 text-red-700">Delete Account</h3>
                <p class="text-gray-600 mb-6">Are you sure you want to permanently delete your account? All of your personal information will be removed. This action cannot be undone.</p>
                <div class="flex justify-end space-x-4">
                    <button type="button" id="cancel-delete-account-btn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md font-semibold hover:bg-gray-300">Cancel</button>
                    <button type="button" id="confirm-delete-account-btn" class="bg-red-600 text-white px-4 py-2 rounded-md font-semibold hover:bg-red-700 flex items-center justify-center w-40 h-10">
                        <span class="btn-text">Yes, Delete My Account</span>
                        <div class="spinner hidden"></div>
                    </button>
                </div>
            </div>
        </div>

        <div id="password-reset-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden-view">
            <div class="bg-white rounded-xl shadow-2xl m-4 w-full max-w-md p-8">
                <h3 class="text-2xl font-bold mb-2">Reset Password</h3>
                <p class="text-gray-600 mb-6">Enter your account's email address and we will send you a password reset link.</p>
                <form id="password-reset-form">
                    <div class="mb-4">
                        <label for="reset-email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input type="email" id="reset-email" required class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="you@example.com" autocomplete="email">
                    </div>
                    <div class="flex justify-end space-x-4 mt-6">
                        <button type="button" id="cancel-password-reset-btn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md font-semibold hover:bg-gray-300">Cancel</button>
                        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md font-semibold hover:bg-blue-700 flex items-center justify-center w-40 h-10">
                            <span class="btn-text">Send Reset Link</span>
                            <div class="spinner hidden"></div>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex flex-col items-center justify-center z-50 hidden-view"><div id="loading-spinner" class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-white"></div><p id="loading-text" class="text-white mt-4">Analysing Scene...</p></div>
        <div id="message-box" class="fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transition-opacity duration-300 z-50"><p id="message-text"></p></div>
        <input type="file" id="profile-pic-input" class="hidden" accept="image/png, image/jpeg, image/heic, image/heif">
        <input type="file" id="receipt-upload-input" class="hidden" accept="image/*">

        <div id="share-invite-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden-view">
            <div class="bg-white rounded-xl shadow-2xl m-4 p-8 text-center flex flex-col items-center max-w-md">
                <h3 class="text-2xl font-bold mb-2">Invite for <span id="share-invite-name"></span></h3>
                <p class="text-gray-600 mb-6">Your magic link is ready! Send it to your friend so they can join the trip.</p>
                
                <button type="button" id="share-invite-btn" class="w-full bg-blue-600 text-white px-6 py-3 rounded-md font-semibold hover:bg-blue-700 flex items-center justify-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                      <path d="M15 8a3 3 0 10-2.977-2.63l-4.94 2.47a3 3 0 100 4.319l4.94 2.47a3 3 0 10.895-1.789l-4.94-2.47a3.027 3.027 0 000-.74l4.94-2.47C13.456 7.68 14.19 8 15 8z" />
                    </svg>
                    <span>Share Invite Link</span>
                </button>

                <button type="button" id="copy-shareable-link-btn" class="w-full mt-3 bg-gray-200 text-gray-800 px-4 py-2 rounded-md font-semibold hover:bg-gray-300">Copy Link</button>
                
                <button type="button" id="close-share-modal-btn" class="mt-6 text-sm text-gray-500 hover:underline">Done</button>
            </div>
        </div>

        <footer class="text-center py-4">
            <p class="text-xs text-gray-400">
              Version 9.0.13 (Password Reset)
            </p>
        </footer>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, createUserWithEmailAndPassword, sendEmailVerification, signInWithEmailAndPassword, updateProfile, deleteUser, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, addDoc, query, where, onSnapshot, serverTimestamp, setLogLevel, updateDoc, arrayUnion, getDocs, deleteDoc, writeBatch, Timestamp, orderBy, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, uploadBytesResumable } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-functions.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAi2llnXf_VloWUL6mZgdJMa1W1EOTwLE4",
            authDomain: "splitify-2ec5e.firebaseapp.com",
            projectId: "splitify-2ec5e",
            storageBucket: "splitify-2ec5e.firebasestorage.app",
            messagingSenderId: "1038415606946",
            appId: "1:1038415606946:web:a17be9b5dbbd9a715013fb",
            measurementId: "G-DTBQM17BV6"
        };
        
        const CLOUD_FUNCTION_URL = 'https://us-central1-splitify-2ec5e.cloudfunctions.net/callgemini';
        const FX_API_KEY = '9dedf9a9f74ab256717d8f4f';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const functions = getFunctions(app);
        setLogLevel('error');

        let currentTrip = null;
        let tripToArchive = null;
        let expenseToEdit = null;
        let expenseToDelete = null;
        let paymentToDeleteId = null;
        let memberToRemove = null;
        let allTripExpenses = [];
        let tripsUnsubscribe = null;
        let singleTripUnsubscribe = null;
        let expensesUnsubscribe = null;
        let feedbackUnsubscribe = null;
        const userProfilesCache = new Map();
        let cameraStream = null;
        let userLocation = null;
        let showDeletedItems = false;
        let showArchivedTrips = false;
        let isTripSupremoEnabled = false;
        let currentItemization = null;
        let remainderAssignments = new Set();
        let lastAiReportMarkdown = '';
        let selectedCompanions = new Set();
        let isScanning = false;
        let qrScannerAnimation;

        const allViews = document.querySelectorAll('.view');
        const allModals = document.querySelectorAll('.modal-overlay');
        const authView = document.getElementById('auth-view');
        const dashboardView = document.getElementById('dashboard-view');
        const tripDetailView = document.getElementById('trip-detail-view');
        const feedbackHubView = document.getElementById('feedback-hub-view');
        const authMessageArea = document.getElementById('auth-message-area');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const loginTabBtn = document.getElementById('login-tab-btn');
        const registerTabBtn = document.getElementById('register-tab-btn');
        const welcomeMessage = document.getElementById('welcome-message');
        const loginBtn = document.getElementById('login-btn');
        const registerBtn = document.getElementById('register-btn');
        const profileArea = document.getElementById('profile-area');
        const profilePicInput = document.getElementById('profile-pic-input');
        const tripsList = document.getElementById('trips-list');
        const noTripsMessage = document.getElementById('no-trips-message');
        const createTripBtn = document.getElementById('create-trip-btn');
        const createTripModal = document.getElementById('create-trip-modal');
        const createTripForm = document.getElementById('create-trip-form');
        const cancelCreateTripBtn = document.getElementById('cancel-create-trip-btn');
        const submitCreateTripBtn = document.getElementById('submit-create-trip-btn');
        const backToDashboardBtn = document.getElementById('back-to-dashboard-btn');
        const tripDetailName = document.getElementById('trip-detail-name');
        const tripTotalSpent = document.getElementById('trip-total-spent');
        const tripOutstandingBalance = document.getElementById('trip-outstanding-balance');
        const tripMembersList = document.getElementById('trip-members-list');
        const tripItemsList = document.getElementById('trip-items-list');
        const noItemsMessage = document.getElementById('no-items-message');
        const supremoMenuContainer = document.getElementById('supremo-menu-container');
        const supremoMenuBtn = document.getElementById('supremo-menu-btn');
        const addExpenseModal = document.getElementById('add-expense-modal');
        const addExpenseForm = document.getElementById('add-expense-form');
        const cancelAddExpenseBtn = document.getElementById('cancel-add-expense-btn');
        const expenseAmountInput = document.getElementById('expense-amount');
        const expenseCurrencySelect = document.getElementById('expense-currency');
        const fxConversionDisplay = document.getElementById('fx-conversion-display');
        const expensePaidBySelect = document.getElementById('expense-paid-by');
        const expenseSplitBetweenDiv = document.getElementById('expense-split-between');
        const splitTotalValidation = document.getElementById('split-total-validation');
        const submitExpenseBtn = document.getElementById('submit-expense-btn');
        const itemizedSplitSection = document.getElementById('itemized-split-section');
        const itemizedListDiv = document.getElementById('itemized-list');
        const itemizedSummaryDiv = document.getElementById('itemized-summary');
        const equalSplitSection = document.getElementById('equal-split-section');
        const splitModeToggleContainer = document.getElementById('split-mode-toggle-container');
        const toggleSplitModeBtn = document.getElementById('toggle-split-mode-btn');
        const aiCategorySpinner = document.getElementById('ai-category-spinner');
        const aiReasoningTooltip = document.getElementById('ai-reasoning-tooltip');
        const inviteMemberBtn = document.getElementById('invite-member-btn');
        const inviteMemberModal = document.getElementById('invite-member-modal');
        const inviteMemberForm = document.getElementById('invite-member-form');
        const cancelInviteBtn = document.getElementById('cancel-invite-btn');
        const submitInviteBtn = document.getElementById('submit-invite-btn');
        const archiveTripModal = document.getElementById('archive-trip-modal');
        const archiveTripNameSpan = document.getElementById('archive-trip-name');
        const cancelArchiveTripBtn = document.getElementById('cancel-archive-trip-btn');
        const confirmArchiveTripBtn = document.getElementById('confirm-archive-trip-btn');
        const editProfileModal = document.getElementById('edit-profile-modal');
        const editProfileForm = document.getElementById('edit-profile-form');
        const cancelEditProfileBtn = document.getElementById('cancel-edit-profile-btn');
        const editExpenseModal = document.getElementById('edit-expense-modal');
        const editExpenseForm = document.getElementById('edit-expense-form');
        const editExpenseIdInput = document.getElementById('edit-expense-id');
        const editExpenseDescriptionInput = document.getElementById('edit-expense-description');
        const cancelEditExpenseBtn = document.getElementById('cancel-edit-expense-btn');
        const confirmEditExpenseBtn = document.getElementById('confirm-edit-expense-btn');
        const deleteExpenseModal = document.getElementById('delete-expense-modal');
        const cancelDeleteExpenseBtn = document.getElementById('cancel-delete-expense-btn');
        const confirmDeleteExpenseBtn = document.getElementById('confirm-delete-expense-btn');
        const deletePaymentModal = document.getElementById('delete-payment-modal');
        const cancelDeletePaymentBtn = document.getElementById('cancel-delete-payment-btn');
        const confirmDeletePaymentBtn = document.getElementById('confirm-delete-payment-btn');
        const settleUpBtn = document.getElementById('settle-up-btn');
        const settleUpModal = document.getElementById('settle-up-modal');
        const settlementSummary = document.getElementById('settlement-summary');
        const settlementCurrency = document.getElementById('settlement-currency');
        const settlementList = document.getElementById('settlement-list');
        const closeSettleUpBtn = document.getElementById('close-settle-up-btn');
        const closeSettleUpBtnX = document.getElementById('close-settle-up-btn-x');
        const messageBox = document.getElementById('message-box');
        const messageText = document.getElementById('message-text');
        const visualiseSettlementBtn = document.getElementById('visualise-settlement-btn');
        const settlementVisualisationModal = document.getElementById('settlement-visualisation-modal');
        const visualisationCurrency = document.getElementById('visualisation-currency');
        const closeVisualisationBtn = document.getElementById('close-visualisation-btn');
        const vizDebtorsList = document.getElementById('viz-debtors-list');
        const vizCreditorsList = document.getElementById('viz-creditors-list');
        const vizPaymentsList = document.getElementById('viz-payments-list');
        const aiScanModal = document.getElementById('ai-scan-modal');
        const aiCancelBtn = document.getElementById('ai-cancel-btn');
        const aiCaptureBtn = document.getElementById('ai-capture-btn');
        const videoElement = document.getElementById('camera-feed');
        const canvasElement = document.getElementById('camera-canvas');
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingText = document.getElementById('loading-text');
        const receiptUploadInput = document.getElementById('receipt-upload-input');
        const fabContainer = document.getElementById('fab-container');
        const fabToggle = document.getElementById('fab-toggle');
        const fabManualAdd = document.getElementById('fab-manual-add');
        const fabCameraScan = document.getElementById('fab-camera-scan');
        const fabGalleryUpload = document.getElementById('fab-gallery-upload');
        const actionSheetModal = document.getElementById('action-sheet-modal');
        const actionSheetCancelBtn = document.getElementById('action-sheet-cancel-btn');
        const actionSheetArchiveBtn = document.getElementById('action-sheet-archive-btn');
        const actionSheetEmailBtn = document.getElementById('action-sheet-email-btn');
        const supremoToggleActionSheet = document.getElementById('supremo-toggle-action-sheet');
        const aiReportBtn = document.getElementById('ai-report-btn');
        const aiReportModal = document.getElementById('ai-report-modal');
        const aiReportForm = document.getElementById('ai-report-form');
        const cancelAiReportBtn = document.getElementById('cancel-ai-report-btn');
        const aiReportDisplayModal = document.getElementById('ai-report-display-modal');
        const aiReportContent = document.getElementById('ai-report-content');
        const closeAiDisplayBtn = document.getElementById('close-ai-display-btn');
        const closeAiDisplayBtnX = document.getElementById('close-ai-display-btn-x');
        const copyAiReportBtn = document.getElementById('copy-ai-report-btn');
        const aiReportTypeSelect = document.getElementById('ai-report-type');
        const customQuestionArea = document.getElementById('custom-question-area');
        const closeInviteModalXBtn = document.getElementById('close-invite-modal-x-btn');
        const addSelectedCompanionsBtn = document.getElementById('add-selected-companions-btn');
        const showQrCodeModal = document.getElementById('show-qr-code-modal');
        const myQrCodeCanvas = document.getElementById('my-qr-code-canvas');
        const myQrCodeProfile = document.getElementById('my-qr-code-profile');
        const closeMyQrCodeBtn = document.getElementById('close-my-qr-code-btn');
        const showMyQrCodeIconBtn = document.getElementById('show-my-qr-code-icon-btn');
        const scanQrCodeBtn = document.getElementById('scan-qr-code-btn');
        const scanQrCodeModal = document.getElementById('scan-qr-code-modal');
        const scanQrVideo = document.getElementById('scan-qr-video-feed');
        const scanQrCanvas = document.getElementById('scan-qr-canvas-hidden');
        const cancelScanQrBtn = document.getElementById('cancel-scan-qr-btn');
        const openFeedbackHubBtn = document.getElementById('open-feedback-hub-btn');
        const backToDashboardFromFeedbackBtn = document.getElementById('back-to-dashboard-from-feedback-btn');
        const feedbackList = document.getElementById('feedback-list');
        const submitNewIdeaBtn = document.getElementById('submit-new-idea-btn');
        const submitFeedbackModal = document.getElementById('submit-feedback-modal');
        const submitFeedbackForm = document.getElementById('submit-feedback-form');
        const cancelSubmitFeedbackBtn = document.getElementById('cancel-submit-feedback-btn');
        const removeMemberModal = document.getElementById('remove-member-modal');
        const removeMemberNameSpan = document.getElementById('remove-member-name');
        const cancelRemoveMemberBtn = document.getElementById('cancel-remove-member-btn');
        const confirmRemoveMemberBtn = document.getElementById('confirm-remove-member-btn');
        const deleteAccountModal = document.getElementById('delete-account-modal');
        const cancelDeleteAccountBtn = document.getElementById('cancel-delete-account-btn');
        const confirmDeleteAccountBtn = document.getElementById('confirm-delete-account-btn');
        const passwordResetModal = document.getElementById('password-reset-modal');
        const passwordResetForm = document.getElementById('password-reset-form');
        const forgotPasswordLink = document.getElementById('forgot-password-link');
        const cancelPasswordResetBtn = document.getElementById('cancel-password-reset-btn');
        
        const currencySymbols = { GBP: '£', USD: '$', EUR: '€', JPY: '¥', CAD: '$', AUD: '$' };
        const allCurrencies = { 'GBP': 'GBP (British Pound)', 'USD': 'USD (US Dollar)', 'EUR': 'EUR (Euro)', 'JPY': 'JPY (Japanese Yen)', 'CAD': 'CAD (Canadian Dollar)', 'AUD': 'AUD (Australian Dollar)' };
        
        function calculateAllBalances(trip, allExpenses) {
            const balances = new Map();
            trip.memberUids.forEach(uid => balances.set(uid, 0));
            const activeExpenses = allExpenses.filter(e => !e.isDeleted);
            activeExpenses.forEach(expense => {
                const paidBy = expense.paidBy;
                const baseAmountInCents = expense.amountDetails.baseAmountInCents || 0;
                const splitBetweenInCents = expense.splitBetweenInCents || {};
                if (balances.has(paidBy)) {
                    balances.set(paidBy, balances.get(paidBy) + baseAmountInCents);
                }
                for (const memberId in splitBetweenInCents) {
                    const shareInCents = splitBetweenInCents[memberId];
                    if (balances.has(memberId)) {
                        balances.set(memberId, balances.get(memberId) - shareInCents);
                    }
                }
            });
            const activePayments = (trip.settledPayments || []).filter(p => !p.isDeleted);
            activePayments.forEach(payment => {
                const paymentAmountInCents = payment.amountInCents || 0;
                if (balances.has(payment.from)) {
                    balances.set(payment.from, balances.get(payment.from) + paymentAmountInCents);
                }
                if (balances.has(payment.to)) {
                    balances.set(payment.to, balances.get(payment.to) - paymentAmountInCents);
                }
            });
            return balances;
        }

        async function getExchangeRate(fromCurrency, toCurrency) {
            const url = `https://v6.exchangerate-api.com/v6/${FX_API_KEY}/pair/${fromCurrency}/${toCurrency}`;
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                if (data.result === 'success') return data;
                else throw new Error(`FX API error: ${data['error-type']}`);
            } catch (error) {
                console.error("Failed to fetch exchange rate:", error);
                throw new Error("Could not retrieve the currency exchange rate.");
            }
        }

        function formatDateTimeForInput(timestampString) {
            if (!timestampString || timestampString.length < 16) return null;
            return timestampString.slice(0, 16);
        }
        
        function getCurrentLocalDateTime() {
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            return now.toISOString().slice(0, 16);
        }

        function showView(viewId) {
            allViews.forEach(view => view.classList.add('hidden-view'));
            allModals.forEach(modal => modal.classList.add('hidden-view'));
            document.getElementById(viewId).classList.remove('hidden-view');
        }

        function showMessage(message, isError = true) {
            messageText.textContent = message;
            messageBox.className = `fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg transition-opacity duration-300 z-50 ${isError ? 'bg-red-500' : 'bg-green-500'}`;
            messageBox.classList.remove('opacity-0');
            setTimeout(() => messageBox.classList.add('opacity-0'), 3000);
        }

        function openModal(modalElement) {
            if (!modalElement) return;
            document.body.classList.add('modal-open');
            modalElement.classList.remove('hidden-view');
        }

        function closeModal(modalElement) {
            if (!modalElement) return;
            document.body.classList.remove('modal-open');
            modalElement.classList.add('hidden-view');
        }

        function showAuthMessage(message) {
            authMessageArea.textContent = message;
            authMessageArea.classList.remove('hidden');
        }

        function hideAuthMessage() {
            authMessageArea.classList.add('hidden');
        }
        
        function toggleFabMenu(forceClose = false) {
            if (forceClose || fabContainer.classList.contains('open')) {
                fabContainer.classList.remove('open');
            } else {
                fabContainer.classList.toggle('open');
            }
        }

        async function selectTrip(trip) {
            if (singleTripUnsubscribe) singleTripUnsubscribe();
            
            const tripRef = doc(db, 'trips', trip.id);
            singleTripUnsubscribe = onSnapshot(tripRef, async (doc) => {
                if (doc.exists()) {
                    currentTrip = { id: doc.id, ...doc.data() };
                    tripDetailName.textContent = currentTrip.name;
                    const user = auth.currentUser;
                    if (user && user.uid === currentTrip.ownerId) {
                        supremoMenuContainer.classList.remove('hidden');
                    } else {
                        supremoMenuContainer.classList.add('hidden');
                    }
                    await renderTripMembers(currentTrip.members);
                    if(allTripExpenses.length > 0 || currentTrip.settledPayments?.length > 0) {
                         renderTripItems();
                    }
                } else {
                    console.error("Selected trip no longer exists.");
                    backToDashboardBtn.click();
                }
            }, (error) => {
                console.error("Error listening to single trip:", error);
                showMessage("Could not get real-time trip updates.");
            });
            if (expensesUnsubscribe) expensesUnsubscribe();
            listenForExpenses(trip.id);
            showView('trip-detail-view');
        }

        backToDashboardBtn.addEventListener('click', () => {
            if (expensesUnsubscribe) expensesUnsubscribe();
            if (singleTripUnsubscribe) singleTripUnsubscribe();
            currentTrip = null;
            showView('dashboard-view');
        });

        async function fetchUserProfiles(uids) {
            const profilesToFetch = uids.filter(uid => uid && !userProfilesCache.has(uid));
            if (profilesToFetch.length > 0) {
                const usersRef = collection(db, "users");
                const q = query(usersRef, where("uid", "in", profilesToFetch));
                const snapshot = await getDocs(q);
                snapshot.forEach(doc => {
                    userProfilesCache.set(doc.id, doc.data());
                });
            }
            const profiles = {};
            uids.forEach(uid => {
                if(uid) profiles[uid] = userProfilesCache.get(uid);
            });
            return profiles;
        }

        async function loadUserPreferences(userId) {
            try {
                const userDocRef = doc(db, "users", userId);
                const userDoc = await getDoc(userDocRef);
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    const prefs = userData.preferences || {};
                    showDeletedItems = prefs.showDeleted ?? false;
                    isTripSupremoEnabled = prefs.supremoEnabled ?? false;
                    showArchivedTrips = prefs.showArchived ?? false;
                } else {
                    showDeletedItems = false;
                    isTripSupremoEnabled = false;
                    showArchivedTrips = false;
                }
            } catch (error) {
                console.warn("Could not load user preferences. Using defaults.");
                showDeletedItems = false; 
                isTripSupremoEnabled = false;
                showArchivedTrips = false;
            }
        }

        async function saveUserPreferences(userId, prefs) {
            try {
                const userDocRef = doc(db, "users", userId);
                await updateDoc(userDocRef, { preferences: prefs });
            } catch (error) {
                console.error("Could not save user preferences. Check Firestore rules.", error);
                showMessage("Could not save your preference.");
            }
        }

        function renderProfile(user) {
            welcomeMessage.textContent = `Hi ${user.displayName || user.email}`;
            profileArea.innerHTML = '';
            const profileContainer = document.createElement('div');
            profileContainer.className = 'relative';
            const profilePicBtn = document.createElement('button');
            profilePicBtn.id = 'profile-pic-btn';
            profilePicBtn.type = 'button';
            profilePicBtn.className = 'profile-pic-wrapper block';
            let avatar;
            if (user.photoURL) {
                avatar = `<img src="${user.photoURL}" alt="Profile Picture" class="w-12 h-12 rounded-full object-cover">`;
            } else {
                const initial = user.displayName ? user.displayName.charAt(0).toUpperCase() : '?';
                avatar = `<div class="w-12 h-12 rounded-full bg-blue-500 text-white flex items-center justify-center text-xl font-bold">${initial}</div>`;
            }
            profilePicBtn.innerHTML = avatar;
            const dropdown = document.createElement('div');
            dropdown.id = 'profile-dropdown';
            dropdown.className = 'dropdown-menu absolute right-0 mt-2 w-56 bg-white rounded-md shadow-lg py-1 z-50 hidden origin-top-right transform opacity-0 scale-95';
            dropdown.innerHTML = `
                <a href="#" id="change-pic-btn" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Change Picture</a>
                <a href="#" id="edit-profile-btn" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Edit Profile & Payments</a>
                <div class="border-t border-gray-100 my-1"></div>
                <div class="px-4 py-2 space-y-2">
                    <label for="show-deleted-toggle" class="flex items-center justify-between cursor-pointer">
                        <span class="text-sm text-gray-700">Display Deleted Items</span>
                        <div class="relative">
                            <input type="checkbox" id="show-deleted-toggle" class="sr-only toggle-switch">
                            <div class="block bg-gray-600 w-10 h-6 rounded-full"></div>
                            <div class="dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition"></div>
                        </div>
                    </label>
                    <label for="show-archived-toggle" class="flex items-center justify-between cursor-pointer">
                        <span class="text-sm text-gray-700">Display Archived Trips</span>
                        <div class="relative">
                            <input type="checkbox" id="show-archived-toggle" class="sr-only toggle-switch">
                            <div class="block bg-gray-600 w-10 h-6 rounded-full"></div>
                            <div class="dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition"></div>
                        </div>
                    </label>
                </div>
                <div class="border-t border-gray-100 my-1"></div>
                <a href="#" id="delete-account-btn" class="block px-4 py-2 text-sm text-red-600 hover:bg-gray-100">Delete Account</a>
                <a href="#" id="logout-btn" class="block px-4 py-2 text-sm text-red-600 hover:bg-gray-100">Logout</a>
            `;
            profileContainer.appendChild(profilePicBtn);
            profileContainer.appendChild(dropdown);
            profileArea.appendChild(profileContainer);
            const showDeletedToggle = document.getElementById('show-deleted-toggle');
            showDeletedToggle.checked = showDeletedItems;
            showDeletedToggle.addEventListener('change', async () => {
                showDeletedItems = showDeletedToggle.checked;
                if (auth.currentUser) {
                    await saveUserPreferences(auth.currentUser.uid, { showDeleted: showDeletedItems, supremoEnabled: isTripSupremoEnabled, showArchived: showArchivedTrips });
                }
                if (currentTrip) renderTripItems();
            });
            const showArchivedToggle = document.getElementById('show-archived-toggle');
            showArchivedToggle.checked = showArchivedTrips;
            showArchivedToggle.addEventListener('change', async () => {
                showArchivedTrips = showArchivedToggle.checked;
                if (auth.currentUser) {
                    await saveUserPreferences(auth.currentUser.uid, { showDeleted: showDeletedItems, supremoEnabled: isTripSupremoEnabled, showArchived: showArchivedTrips });
                }
                if (tripsUnsubscribe) tripsUnsubscribe();
                listenForTrips(auth.currentUser.uid);
            });
        }

        onAuthStateChanged(auth, async (user) => {
            if (user && user.emailVerified) {
                const userDocRef = doc(db, "users", user.uid);
                const userDoc = await getDoc(userDocRef);

                if (!userDoc.exists()) {
                    console.error("User document not found for authenticated user. Forcing logout.", user.uid);
                    showMessage("Your user profile could not be found. Please log in again.", true);
                    await signOut(auth);
                    return; 
                }

                userProfilesCache.set(user.uid, { uid: user.uid, ...userDoc.data() });
                await loadUserPreferences(user.uid);
                renderProfile(user);
                if (tripsUnsubscribe) tripsUnsubscribe();
                listenForTrips(user.uid);
                showView('dashboard-view');

            } else {
                if (user && !user.emailVerified) {
                     showAuthMessage("Your email is not verified. Please check your inbox for the verification link.");
                }
                if (tripsUnsubscribe) tripsUnsubscribe();
                if (expensesUnsubscribe) expensesUnsubscribe();
                if (singleTripUnsubscribe) singleTripUnsubscribe();
                currentTrip = null;
                userProfilesCache.clear();
                showView('auth-view');
            }
        });

        function listenForTrips(userId) {
            const tripsRef = collection(db, 'trips');
            const q = query(tripsRef, where("memberUids", "array-contains", userId));
            
            tripsUnsubscribe = onSnapshot(q, async (snapshot) => {
                let trips = [];
                snapshot.forEach((doc) => {
                    trips.push({ id: doc.id, ...doc.data() });
                });
                if (!showArchivedTrips) {
                    trips = trips.filter(trip => !trip.isArchived);
                }
                const allMemberUids = [...new Set(trips.flatMap(trip => trip.memberUids || []))];
                if (allMemberUids.length > 0) await fetchUserProfiles(allMemberUids);
                await renderTrips(trips);
            }, (error) => {
                console.error("Error listening for trips:", error);
                showMessage("Could not fetch trips.");
            });
        }

        async function renderTrips(trips) {
            tripsList.innerHTML = '';
            if (trips.length === 0) {
                tripsList.appendChild(noTripsMessage);
                noTripsMessage.classList.remove('hidden');
                return;
            } 
            noTripsMessage.classList.add('hidden');
            trips.sort((a,b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));
            trips.forEach(trip => {
                const tripElement = document.createElement('div');
                const isSettled = trip.isSettled || false;
                const isArchived = trip.isArchived || false;
                tripElement.className = `p-4 rounded-xl shadow-sm hover:shadow-md transition-shadow group relative`;
                tripElement.style.backgroundColor = isArchived ? '#e5e7eb' : (isSettled ? '#dcfce7' : '#ffffff');
                const settledBadge = isSettled && !isArchived ? `<span class="text-xs font-bold text-green-800 bg-green-200 px-2 py-1 rounded-full">SETTLED</span>` : '';
                const archivedBadge = isArchived ? `<span class="text-xs font-bold text-gray-800 bg-gray-300 px-2 py-1 rounded-full">ARCHIVED</span>` : '';
                const unarchiveButton = isArchived ? `<button data-trip-id="${trip.id}" class="unarchive-btn text-xs font-bold text-blue-800 bg-blue-200 px-2 py-1 rounded-full hover:bg-blue-300">Unarchive</button>` : '';
                const memberAvatars = (trip.memberUids || []).slice(0, 4).map(uid => {
                    const profile = userProfilesCache.get(uid);
                    if (profile && profile.photoURL) {
                        return `<img src="${profile.photoURL}" class="inline-block h-8 w-8 rounded-full object-cover ring-2 ring-white">`;
                    }
                    const initial = profile ? (profile.displayName || '?').charAt(0).toUpperCase() : '?';
                    return `<div class="inline-block h-8 w-8 rounded-full bg-blue-500 text-white flex items-center justify-center text-sm font-bold ring-2 ring-white">${initial}</div>`;
                }).join('');
                tripElement.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex-1 min-w-0">
                            <h3 class="text-xl font-bold ${isArchived ? 'text-gray-500' : 'text-gray-800'} truncate">${trip.name}</h3>
                            <p class="text-sm ${isArchived ? 'text-gray-400' : 'text-gray-500'}">Base Currency: ${trip.baseCurrency}</p>
                        </div>
                        <div class="flex items-center space-x-2 pl-2 flex-shrink-0">
                            ${settledBadge}
                            ${archivedBadge} ${unarchiveButton}
                            <div class="flex -space-x-2 overflow-hidden">
                                ${memberAvatars}
                                ${trip.memberUids && trip.memberUids.length > 4 ? `<div class="inline-block h-8 w-8 rounded-full bg-gray-600 text-white flex items-center justify-center text-xs font-bold ring-2 ring-white">+${trip.memberUids.length - 4}</div>` : ''}
                            </div>
                        </div>
                    </div>
                `;
                tripElement.addEventListener('click', (e) => {
                    if (e.target.closest('.unarchive-btn')) return;
                    selectTrip(trip);
                });
                tripsList.appendChild(tripElement);
            });
        }
        
        const handleUnarchiveTrip = async (tripId) => {
            if (!tripId) return;
            try {
                const tripRef = doc(db, "trips", tripId);
                await updateDoc(tripRef, { isArchived: false });
                showMessage("Trip has been unarchived!", false);
            } catch (error) {
                console.error("Error unarchiving trip:", error);
                showMessage("Could not unarchive the trip.");
            }
        };

        tripsList.addEventListener('click', (e) => {
            const unarchiveBtn = e.target.closest('.unarchive-btn');
            if (unarchiveBtn) {
                e.stopPropagation();
                handleUnarchiveTrip(unarchiveBtn.dataset.tripId);
            }
        });

        function hasFinancialHistory(memberUid) {
            const balances = calculateAllBalances(currentTrip, allTripExpenses);
            const balanceInCents = balances.get(memberUid) || 0;
            // A user has financial history if their balance is not zero.
            return balanceInCents !== 0;
        }

        async function renderTripMembers(members) {
            tripMembersList.innerHTML = '';
            const isOwner = auth.currentUser.uid === currentTrip.ownerId;
        
            const memberContributions = new Map();
            currentTrip.memberUids.forEach(uid => memberContributions.set(uid, 0));
        
            allTripExpenses.forEach(expense => {
                if (!expense.isDeleted) {
                    const payerId = expense.paidBy;
                    const amount = expense.amountDetails.baseAmountInCents || 0;
                    if (memberContributions.has(payerId)) {
                        memberContributions.set(payerId, memberContributions.get(payerId) + amount);
                    }
                }
            });
        
            let topContributorUid = null;
            let maxContribution = 0;
            if (Array.from(memberContributions.values()).some(val => val > 0)) {
                for (const [uid, total] of memberContributions.entries()) {
                    if (total > maxContribution) {
                        maxContribution = total;
                        topContributorUid = uid;
                    }
                }
            }
        
            for (const member of members) {
                const memberEl = document.createElement('div');
                memberEl.className = 'flex flex-col items-center text-center';
                const profile = userProfilesCache.get(member.uid);
                if (!profile) continue;
        
                const isSelf = member.uid === auth.currentUser.uid;
                const haloClass = member.uid === topContributorUid ? 'golden-halo' : '';
        
                let removeIconHTML = '';
                if (isOwner && !isSelf) {
                    const canRemove = !hasFinancialHistory(member.uid);
                    let iconContent;

                    if (canRemove) {
                        // The clickable button for removable members
                        iconContent = `<button class="remove-member-btn h-6 w-6 bg-red-600 text-white rounded-full flex items-center justify-center cursor-pointer hover:bg-red-700" data-uid="${member.uid}" data-name="${profile.displayName}"><svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M6 18L18 6M6 6l12 12"></path></svg></button>`;
                    } else {
                        // A button that looks disabled but triggers a toast message on click.
                        iconContent = `<button data-action="show-remove-error" class="h-6 w-6 bg-gray-400 text-white rounded-full flex items-center justify-center cursor-not-allowed"><svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M6 18L18 6M6 6l12 12"></path></svg></button>`;
                    }
                    removeIconHTML = `<div class="remove-icon-overlay">${iconContent}</div>`;
                }
        
                let avatarHTML = '';
                if (profile.photoURL) {
                    avatarHTML = `<img src="${profile.photoURL}" alt="${profile.displayName}" class="w-12 h-12 rounded-full object-cover mb-1 ${haloClass}">`;
                } else {
                    const initial = profile.displayName ? profile.displayName.charAt(0).toUpperCase() : '?';
                    avatarHTML = `<div class="w-12 h-12 rounded-full bg-blue-500 text-white flex items-center justify-center text-xl font-bold mb-1 ${haloClass}">${initial}</div>`;
                }
        
                const nameHTML = `<span class="text-xs text-gray-600 w-20 truncate">${profile.displayName}</span>`;
                memberEl.innerHTML = `
                    <div class="member-avatar-wrapper">
                        ${avatarHTML}
                        ${removeIconHTML}
                    </div>
                    ${nameHTML}
                `;
                tripMembersList.appendChild(memberEl);
            }
        }

        function listenForExpenses(tripId) {
            const expensesRef = collection(db, 'trips', tripId, 'expenses');
            const q = query(expensesRef);
            expensesUnsubscribe = onSnapshot(q, (snapshot) => {
                allTripExpenses = [];
                snapshot.forEach(doc => allTripExpenses.push({ id: doc.id, ...doc.data() }));
                renderTripItems();
            }, (error) => {
                console.error("Error listening for expenses: ", error);
                showMessage("Could not load trip expenses.");
            });
        }
        
        function renderTripItems() {
            tripItemsList.innerHTML = '';
            const expenses = allTripExpenses.map(e => ({ type: 'expense', data: e, date: e.occurredAt.toDate() }));
            const payments = (currentTrip.settledPayments || []).map(p => ({ type: 'payment', data: p, date: p.paidAt.toDate() }));
            let allItems = [...expenses, ...payments];
            if (!showDeletedItems) { allItems = allItems.filter(item => !item.data.isDeleted); }
            if (allItems.length === 0) {
                tripItemsList.appendChild(noItemsMessage);
                noItemsMessage.classList.remove('hidden');
                tripTotalSpent.textContent = '';
                tripOutstandingBalance.textContent = '';
                return;
            }
            noItemsMessage.classList.add('hidden');
            allItems.sort((a, b) => b.date - a.date);
            let totalSpentInCents = allTripExpenses.filter(e => !e.isDeleted).reduce((sum, e) => sum + (e.amountDetails.baseAmountInCents || 0), 0);
            tripTotalSpent.textContent = `Total Spent: ${(totalSpentInCents / 100).toFixed(2)} ${currentTrip.baseCurrency}`;
            const balances = calculateAllBalances(currentTrip, allTripExpenses);
            const myBalanceInCents = balances.get(auth.currentUser.uid) || 0;
            if (myBalanceInCents > 0) {
                tripOutstandingBalance.textContent = `I am owed: ${(myBalanceInCents / 100).toFixed(2)} ${currentTrip.baseCurrency}`;
                tripOutstandingBalance.className = 'font-semibold text-green-600';
            } else if (myBalanceInCents < 0) {
                tripOutstandingBalance.textContent = `I owe: ${(Math.abs(myBalanceInCents) / 100).toFixed(2)} ${currentTrip.baseCurrency}`;
                tripOutstandingBalance.className = 'font-semibold text-red-600';
            } else {
                tripOutstandingBalance.textContent = 'All settled for me';
                tripOutstandingBalance.className = 'font-semibold text-gray-500';
            }
            allItems.forEach(item => {
                if (item.type === 'expense') { renderExpenseItem(item.data); } 
                else if (item.type === 'payment') { renderPaymentItem(item.data); }
            });
            if(currentTrip) renderTripMembers(currentTrip.members);
        }
        
        function renderExpenseItem(expense) {
            const isDeleted = expense.isDeleted || false;
            const paidByMe = expense.paidBy === auth.currentUser.uid;
            const expenseWrapper = document.createElement('div');
            expenseWrapper.className = `rounded-xl shadow-sm transition-shadow hover:shadow-md relative ${!isDeleted && paidByMe ? 'bg-blue-50' : 'bg-white'}`;
            const paidByProfile = userProfilesCache.get(expense.paidBy);
            const paidByName = paidByProfile ? paidByProfile.displayName : 'Unknown';
            const ad = expense.amountDetails;
            const baseAmountForDisplay = ((ad.baseAmountInCents || 0) / 100).toFixed(2);
            const originalAmountForDisplay = ((ad.originalAmountInCents || 0) / 100).toFixed(2);
            const amountDisplay = (ad.originalCurrency === ad.baseCurrency) 
                ? `<div class="text-right"><span class="font-bold text-lg">${baseAmountForDisplay} ${ad.baseCurrency}</span></div>` 
                : `<div class="text-right"><span class="font-bold text-lg">${baseAmountForDisplay} ${ad.baseCurrency}</span><p class="text-xs text-gray-500">${originalAmountForDisplay} ${ad.originalCurrency} at ${ad.exchangeRate.toFixed(4)}</p></div>`;
            const formattedDate = expense.occurredAt.toDate().toLocaleString([], { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
            const splitBetweenData = expense.splitBetweenInCents || {};
            const activeSplitLines = Object.keys(splitBetweenData).map(uid => {
                const memberProfile = userProfilesCache.get(uid);
                const memberName = memberProfile ? memberProfile.displayName : 'A User';
                const shareForDisplay = ((splitBetweenData[uid] || 0) / 100).toFixed(2);
                return `<div class="flex justify-between items-center text-sm text-gray-600 py-0.5"><span>${memberName}</span><span>${shareForDisplay} ${currentTrip.baseCurrency}</span></div>`;
            }).join('');
            const canModify = paidByMe || (auth.currentUser.uid === currentTrip.ownerId && isTripSupremoEnabled);
            const actionButtons = (canModify && !isDeleted) ? `<div class="absolute top-2 right-2 flex flex-col space-y-1"><button data-expense-id="${expense.id}" data-expense-description="${expense.description}" class="edit-expense-btn p-1.5 bg-gray-100 rounded-full text-gray-500 hover:bg-yellow-100 hover:text-yellow-600"><svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg></button><button data-expense-id="${expense.id}" class="delete-expense-btn p-1.5 bg-gray-100 rounded-full text-gray-500 hover:bg-red-100 hover:text-red-600"><svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg></button></div>` : '';
            let avatarHTML = '';
            if (paidByProfile && paidByProfile.photoURL) { 
                avatarHTML = `<img src="${paidByProfile.photoURL}" alt="${paidByName}" class="w-8 h-8 rounded-full object-cover mr-3 flex-shrink-0">`; 
            } else { 
                const initial = paidByName.charAt(0).toUpperCase(); 
                avatarHTML = `<div class="w-8 h-8 rounded-full bg-gray-300 text-gray-700 flex items-center justify-center font-bold text-sm mr-3 flex-shrink-0">${initial}</div>`; 
            }
            const detailsContentHTML = `<div class="text-xs text-gray-500 mb-2">${formattedDate}</div><h4 class="font-semibold text-sm mb-1 text-gray-700">Shared Between:</h4><div>${activeSplitLines}</div>`;
            if (isDeleted) { 
                const deletedDetailsContentHTML = `
                    <div class="flex items-center min-w-0 mb-2">
                        ${avatarHTML}
                        <div class="min-w-0">
                            <p class="font-semibold truncate">${expense.description}</p>
                            <p class="text-sm text-gray-600">${paidByMe ? 'You' : paidByName}</p>
                        </div>
                    </div>
                    ${amountDisplay}${detailsContentHTML}`;
                expenseWrapper.innerHTML = `<div class="p-3 flex justify-between items-center cursor-pointer expense-header"><p class="italic text-gray-500">Deleted Item</p><svg class="w-5 h-5 ml-3 text-gray-400 chevron-icon" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg></div><div class="px-3 pb-3 pt-2 border-t border-gray-200 hidden expense-details bg-gray-50/50 rounded-b-xl"><div class="opacity-60">${deletedDetailsContentHTML}</div></div>`; 
            } else { 
                expenseWrapper.innerHTML = `
                <div class="p-3 flex justify-between items-center cursor-pointer expense-header">
                    <div class="flex items-center min-w-0">
                        ${avatarHTML}
                        <div class="min-w-0">
                            <p class="font-semibold truncate">${expense.description}</p>
                            <p class="text-sm text-gray-600">${paidByMe ? 'You' : paidByName}</p>
                        </div>
                    </div>
                    <div class="flex items-center flex-shrink-0 ml-2">
                        ${amountDisplay}
                        <svg class="w-5 h-5 ml-3 text-gray-400 chevron-icon" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                    </div>
                </div>
                <div class="px-3 pb-3 pt-2 border-t border-gray-200 hidden expense-details bg-gray-50/50 rounded-b-xl">${detailsContentHTML}</div>
                ${actionButtons}`;
            }
            expenseWrapper.querySelector('.expense-header').addEventListener('click', (e) => { 
                if (e.target.closest('.delete-expense-btn') || e.target.closest('.edit-expense-btn')) return; 
                const details = expenseWrapper.querySelector('.expense-details'); 
                const icon = expenseWrapper.querySelector('.chevron-icon'); 
                details.classList.toggle('hidden'); 
                icon.classList.toggle('rotate-180'); 
            });
            tripItemsList.appendChild(expenseWrapper);
        }

        function renderPaymentItem(payment) {
            const isDeleted = payment.isDeleted || false; const fromUser = userProfilesCache.get(payment.from)?.displayName || 'Unknown'; const toUser = userProfilesCache.get(payment.to)?.displayName || 'Unknown'; const date = payment.paidAt.toDate(); const formattedDate = date.toLocaleString([], { year: 'numeric', month: 'short', day: 'numeric' }); const isTripOwner = auth.currentUser.uid === currentTrip.ownerId; const amPayerOrPayee = auth.currentUser.uid === payment.from || auth.currentUser.uid === payment.to; const canDelete = amPayerOrPayee || (isTripOwner && isTripSupremoEnabled); const paymentWrapper = document.createElement('div'); paymentWrapper.className = 'rounded-xl shadow-sm bg-green-50 relative'; 
            const paymentAmountForDisplay = ((payment.amountInCents || 0) / 100).toFixed(2);
            const paymentDetailsHTML = `
                <div class="flex items-center min-w-0">
                    <div class="flex-shrink-0 h-10 w-10 rounded-full bg-green-100 text-green-600 flex items-center justify-center">
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                    </div>
                    <div class="ml-4 min-w-0">
                        <p class="font-semibold truncate">${fromUser} paid ${toUser}</p>
                        <p class="text-sm text-gray-600">Settlement on ${formattedDate}</p>
                    </div>
                </div>
                <span class="font-bold text-lg text-green-800 flex-shrink-0 ml-2">${paymentAmountForDisplay} ${currentTrip.baseCurrency}</span>`;
            if (isDeleted) { paymentWrapper.innerHTML = `<div class="p-3 flex justify-between items-center cursor-pointer payment-header"><p class="italic text-gray-500">Deleted Payment</p><svg class="w-5 h-5 ml-3 text-gray-400 chevron-icon" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg></div><div class="px-3 pb-3 pt-2 border-t border-gray-200 hidden payment-details bg-gray-50/50 rounded-b-xl"><div class="opacity-60 flex items-center justify-between">${paymentDetailsHTML}</div></div>`; } 
            else { const deleteBtn = (canDelete) ? `<button data-payment-id="${payment.paidAt.toMillis()}" class="delete-payment-btn absolute top-2 right-2 p-1.5 bg-gray-100 rounded-full text-gray-500 hover:bg-red-100 hover:text-red-600"><svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg></button>` : ''; paymentWrapper.innerHTML = `<div class="p-3 flex items-center justify-between">${paymentDetailsHTML}${deleteBtn}</div>`; }
            if (paymentWrapper.querySelector('.payment-header')) { paymentWrapper.querySelector('.payment-header').addEventListener('click', (e) => { const details = paymentWrapper.querySelector('.payment-details'); const icon = paymentWrapper.querySelector('.chevron-icon'); details.classList.toggle('hidden'); icon.classList.toggle('rotate-180'); }); }
            tripItemsList.appendChild(paymentWrapper);
        }
        
        const handleLogin = async () => {
            hideAuthMessage();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                if (!userCredential.user.emailVerified) {
                    await signOut(auth);
                    showAuthMessage("Your email is not verified. Please check your inbox for the verification link.");
                }
            } catch (error) { 
                if (error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                     showAuthMessage("Incorrect email or password. Please try again.");
                } else {
                     showMessage(error.message);
                }
            }
        };

        const handlePasswordReset = async (e) => {
            e.preventDefault();
            const email = document.getElementById('reset-email').value;
            const submitBtn = passwordResetForm.querySelector('button[type="submit"]');
            const submitBtnText = submitBtn.querySelector('.btn-text');
            const spinner = submitBtn.querySelector('.spinner');

            if (!email) {
                showMessage("Please enter your email address.");
                return;
            }

            submitBtnText.classList.add('hidden');
            spinner.classList.remove('hidden');
            submitBtn.disabled = true;
            cancelPasswordResetBtn.disabled = true;

            try {
                await sendPasswordResetEmail(auth, email);
                closeModal(passwordResetModal);
                loginTabBtn.click(); 
                authMessageArea.className = 'mb-4 p-3 rounded-md bg-green-100 text-green-800 text-sm';
                showAuthMessage(`Success! If an account exists for ${email}, a password reset link has been sent.`);
            } catch (error) {
                closeModal(passwordResetModal);
                loginTabBtn.click();
                authMessageArea.className = 'mb-4 p-3 rounded-md bg-green-100 text-green-800 text-sm';
                showAuthMessage(`Success! If an account exists for ${email}, a password reset link has been sent.`);
                console.error("Password reset error:", error);
            } finally {
                submitBtnText.classList.remove('hidden');
                spinner.classList.add('hidden');
                submitBtn.disabled = false;
                cancelPasswordResetBtn.disabled = false;
                passwordResetForm.reset();
            }
        };

        const handleRegister = async () => {
            hideAuthMessage();
            const displayName = document.getElementById('register-name').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const referrerEmail = document.getElementById('register-referrer-email').value;

            if (!displayName || !email || !password || !referrerEmail) {
                return showMessage("Please fill out all fields.");
            }
            if (email.trim().toLowerCase() === referrerEmail.trim().toLowerCase()) {
                showAuthMessage("You cannot refer yourself.");
                return;
            }

            registerBtn.disabled = true;
            registerBtn.textContent = 'Creating Account...';

            const registerUserFunction = httpsCallable(functions, 'registerNewUser');

            try {
                await registerUserFunction({
                    displayName, email, password, referrerEmail
                });
                
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                await sendEmailVerification(userCredential.user);
                await signOut(auth);
                
                showAuthMessage("Success! A verification email has been sent. Please verify your email then log in.");
                registerForm.reset();

            } catch (error) {
                console.error("Registration flow failed:", error);
                showAuthMessage(error.message);
            } finally {
                registerBtn.disabled = false;
                registerBtn.textContent = 'Create Account';
            }
        };

        const handleCreateTrip = async () => {
            const user = auth.currentUser;
            if (!user) return;
            const tripName = document.getElementById('trip-name').value;
            const baseCurrency = document.getElementById('base-currency').value;
            try {
                const newTrip = {
                    name: tripName, baseCurrency: baseCurrency, ownerId: user.uid, createdAt: serverTimestamp(),
                    members: [{ uid: user.uid, status: 'active' }],
                    memberUids: [user.uid],
                    isSettled: false, isArchived: false, settledPayments: []
                };
                await addDoc(collection(db, "trips"), newTrip);
                createTripForm.reset();
                closeModal(createTripModal);
                showMessage("Trip created successfully!", false);
            } catch (error) { showMessage(error.message); }
        };

        async function addUserToCurrentTrip(uidToAdd) {
            if (!currentTrip || !uidToAdd) return false;

            if (currentTrip.memberUids.includes(uidToAdd)) {
                showMessage("This user is already a member of the trip.");
                return false;
            }
            
            try {
                const tripRef = doc(db, "trips", currentTrip.id);
                await updateDoc(tripRef, {
                    members: arrayUnion({ uid: uidToAdd, status: 'active' }),
                    memberUids: arrayUnion(uidToAdd)
                });
                await fetchUserProfiles([uidToAdd]);
                const newUserProfile = userProfilesCache.get(uidToAdd);
                showMessage(`${newUserProfile.displayName || 'Friend'} was added!`, false);
                return true;
            } catch (error) {
                console.error("Error adding member:", error);
                showMessage(error.message);
                return false;
            }
        }

        async function addMultipleUsersToCurrentTrip(uidsToAdd) {
            if (!currentTrip || uidsToAdd.length === 0) return;
            
            const batch = writeBatch(db);
            const tripRef = doc(db, "trips", currentTrip.id);
            const newMembers = uidsToAdd.map(uid => ({ uid, status: 'active' }));

            batch.update(tripRef, {
                members: arrayUnion(...newMembers),
                memberUids: arrayUnion(...uidsToAdd)
            });

            try {
                await batch.commit();
                showMessage(`${uidsToAdd.length} friends added to the trip!`, false);
                closeModal(inviteMemberModal);
            } catch (error) {
                console.error("Error adding multiple members:", error);
                showMessage("An error occurred while adding friends.");
            }
        }
        
        const handleRemoveMember = async () => {
            if (!memberToRemove || !currentTrip) return;
        
            const updatedMembers = currentTrip.members.filter(m => m.uid !== memberToRemove.uid);
            const updatedMemberUids = currentTrip.memberUids.filter(uid => uid !== memberToRemove.uid);
        
            try {
                const tripRef = doc(db, 'trips', currentTrip.id);
                await updateDoc(tripRef, {
                    members: updatedMembers,
                    memberUids: updatedMemberUids
                });
                showMessage(`${memberToRemove.name} has been removed from the trip.`, false);
            } catch (error) {
                console.error("Error removing member:", error);
                showMessage("Could not remove the member from the trip.");
            } finally {
                memberToRemove = null;
                closeModal(removeMemberModal);
            }
        };

        const handleDeleteAccount = async () => {
            const submitBtnText = confirmDeleteAccountBtn.querySelector('.btn-text');
            const spinner = confirmDeleteAccountBtn.querySelector('.spinner');
            
            submitBtnText.classList.add('hidden');
            spinner.classList.remove('hidden');
            confirmDeleteAccountBtn.disabled = true;
            cancelDeleteAccountBtn.disabled = true;

            try {
                const deleteUserAccountFunction = httpsCallable(functions, 'deleteUserAccount');
                const result = await deleteUserAccountFunction();

                if (result.data.success) {
                    showMessage("Your account has been deleted.", false);
                    await signOut(auth); 
                }
            } catch (error) {
                console.error("Error deleting account:", error);
                showMessage(error.message || "An unknown error occurred.");
            } finally {
                submitBtnText.classList.remove('hidden');
                spinner.classList.add('hidden');
                confirmDeleteAccountBtn.disabled = false;
                cancelDeleteAccountBtn.disabled = false;
                closeModal(deleteAccountModal);
            }
        };
        
        const handleInviteMemberByEmail = async (e) => {
            e.preventDefault();
            const emailToAdd = document.getElementById('invite-email').value.trim().toLowerCase();
            if (!emailToAdd) return;

            const nameWrapper = document.getElementById('invite-name-wrapper');
            const nameInput = document.getElementById('invite-name');
            const helperText = document.getElementById('invite-helper-text');
            const submitBtnText = submitInviteBtn.querySelector('.btn-text');
            const spinner = submitInviteBtn.querySelector('.spinner');
            
            submitBtnText.classList.add('hidden');
            spinner.classList.remove('hidden');
            submitInviteBtn.disabled = true;

            try {
                if (nameWrapper.classList.contains('hidden')) {
                    const usersRef = collection(db, "users");
                    const q = query(usersRef, where("email", "==", emailToAdd));
                    const querySnapshot = await getDocs(q);

                    if (!querySnapshot.empty) {
                        const userToAdd = querySnapshot.docs[0].data();
                        const success = await addUserToCurrentTrip(userToAdd.uid);
                        if (success) {
                            closeModal(inviteMemberModal);
                        }
                    } else {
                        nameWrapper.classList.remove('hidden');
                        helperText.textContent = "Looks like they're new! Add their name to send an invite.";
                        nameInput.required = true;
                        submitBtnText.textContent = 'Send Invite';
                    }
                } else {
                    const name = nameInput.value.trim();
                    if (!name) {
                        showMessage("Please enter the friend's name.");
                        return;
                    }

                    const inviteAndCreateUser = httpsCallable(functions, 'inviteAndCreateUser');
                    const result = await inviteAndCreateUser({ 
                        name: name, 
                        email: emailToAdd, 
                        tripId: currentTrip.id,
                        inviterUid: auth.currentUser.uid 
                    });

                    const data = result.data;
                    if (data.success && data.link) {
                        closeModal(inviteMemberModal);
                        showShareableLinkModal(data.link, name);
                    } else {
                        throw new Error(data.message || "Failed to invite user.");
                    }
                }
            } catch (error) {
                console.error("Error inviting member:", error);
                showMessage(error.message);
            } finally {
                submitBtnText.classList.remove('hidden');
                spinner.classList.add('hidden');
                submitInviteBtn.disabled = false;
            }
        };
        
        function showShareableLinkModal(link, friendName) {
            const shareModal = document.getElementById('share-invite-modal');
            const shareNameSpan = document.getElementById('share-invite-name');
            const shareBtn = document.getElementById('share-invite-btn');
            const copyBtn = document.getElementById('copy-shareable-link-btn');
            const closeBtn = document.getElementById('close-share-modal-btn');

            shareNameSpan.textContent = friendName;

            const shareData = {
                title: 'Join my trip on Splitify!',
                text: `Hey! I'm using Splitify for our "${currentTrip.name}" trip. Here's your personal link to join and set up your account.`,
                url: link
            };

            if (navigator.share) {
                shareBtn.classList.remove('hidden');
                shareBtn.onclick = async () => {
                    try {
                        await navigator.share(shareData);
                        showMessage("Link shared!", false);
                    } catch (err) {
                        console.log("Share action was cancelled or failed:", err.message);
                    }
                };
            } else {
                shareBtn.classList.add('hidden');
            }

            copyBtn.onclick = () => {
                navigator.clipboard.writeText(link).then(() => {
                    showMessage("Link copied to clipboard!", false);
                }, () => {
                    showMessage("Failed to copy link.");
                });
            };

            closeBtn.onclick = () => closeModal(shareModal);
            openModal(shareModal);
        }

        function resetInviteModal() {
            const form = document.getElementById('invite-member-form');
            if (form) form.reset();

            const nameWrapper = document.getElementById('invite-name-wrapper');
            if (nameWrapper) nameWrapper.classList.add('hidden');
            
            const nameInput = document.getElementById('invite-name');
            if(nameInput) nameInput.required = false;

            const submitBtnText = submitInviteBtn.querySelector('.btn-text');
            if (submitBtnText) submitBtnText.textContent = 'Check Email & Invite';
            
            const helperText = document.getElementById('invite-helper-text');
            if(helperText) helperText.textContent = "Enter an email. We'll add them if they're a member, or help you create an invite if they're new.";
            
            selectedCompanions.clear();
            updateAddSelectedButton();
        }

        async function populateCompanionList() {
            const container = document.getElementById('companion-list-container');
            container.innerHTML = '<p class="text-center text-gray-500 text-sm py-2">Loading past companions...</p>';
            
            const user = auth.currentUser;
            if (!user) return;

            const tripsRef = collection(db, 'trips');
            const q = query(tripsRef, where("memberUids", "array-contains", user.uid));
            const snapshot = await getDocs(q);

            const frequencyMap = new Map();
            snapshot.forEach(doc => {
                doc.data().memberUids.forEach(uid => {
                    if (uid !== user.uid) {
                        frequencyMap.set(uid, (frequencyMap.get(uid) || 0) + 1);
                    }
                });
            });

            const sortedCompanions = [...frequencyMap.entries()]
                .sort((a, b) => b[1] - a[1])
                .map(entry => entry[0]);

            const companionUidsToDisplay = sortedCompanions.filter(uid => 
                !currentTrip.memberUids.includes(uid)
            );

            if (companionUidsToDisplay.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 text-sm py-2">No past companions to add.</p>';
                return;
            }

            await fetchUserProfiles(companionUidsToDisplay);
            container.innerHTML = '';
            
            companionUidsToDisplay.forEach(uid => {
                const profile = userProfilesCache.get(uid);
                if (profile) {
                    const companionEl = document.createElement('div');
                    companionEl.className = 'companion-item flex items-center justify-between p-2 rounded-md hover:bg-gray-100 cursor-pointer';
                    companionEl.dataset.uid = uid;
                    companionEl.dataset.name = profile.displayName.toLowerCase();

                    const avatarHTML = profile.photoURL 
                        ? `<img src="${profile.photoURL}" alt="${profile.displayName}" class="w-8 h-8 rounded-full object-cover pointer-events-none">`
                        : `<div class="w-8 h-8 rounded-full bg-blue-500 text-white flex items-center justify-center text-sm font-bold pointer-events-none">${profile.displayName.charAt(0).toUpperCase()}</div>`;
                    
                    companionEl.innerHTML = `
                        <div class="flex items-center space-x-3 pointer-events-none">
                            ${avatarHTML}
                            <span class="text-sm font-medium text-gray-800">${profile.displayName}</span>
                        </div>
                        <button class="add-companion-toggle-btn h-8 w-8 rounded-full flex items-center justify-center text-green-600 bg-green-100 hover:bg-green-200">
                            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12m6-6H6" /></svg>
                        </button>
                    `;
                    container.appendChild(companionEl);
                }
            });

            container.querySelectorAll('.companion-item').forEach(item => {
                item.addEventListener('click', () => toggleCompanionSelection(item));
            });
        }
        
        function toggleCompanionSelection(itemElement) {
            const uid = itemElement.dataset.uid;
            const toggleButton = itemElement.querySelector('.add-companion-toggle-btn');
            
            if (selectedCompanions.has(uid)) {
                selectedCompanions.delete(uid);
                itemElement.classList.remove('selected');
                toggleButton.innerHTML = `<svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12m6-6H6" /></svg>`;
                toggleButton.classList.remove('bg-red-100', 'text-red-600', 'hover:bg-red-200');
                toggleButton.classList.add('bg-green-100', 'text-green-600', 'hover:bg-green-200');
            } else {
                selectedCompanions.add(uid);
                itemElement.classList.add('selected');
                toggleButton.innerHTML = `<svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M18 12H6" /></svg>`;
                toggleButton.classList.remove('bg-green-100', 'text-green-600', 'hover:bg-green-200');
                toggleButton.classList.add('bg-red-100', 'text-red-600', 'hover:bg-red-200');
            }
            updateAddSelectedButton();
        }

        function updateAddSelectedButton() {
            const count = selectedCompanions.size;
            if (count > 0) {
                addSelectedCompanionsBtn.disabled = false;
                addSelectedCompanionsBtn.textContent = `Add Selected (${count})`;
            } else {
                addSelectedCompanionsBtn.disabled = true;
                addSelectedCompanionsBtn.textContent = 'Add Selected (0)';
            }
        }
        
        function showMyJoinCode() {
            const user = auth.currentUser;
            if (!user) return;

            const profile = userProfilesCache.get(user.uid);
            myQrCodeProfile.innerHTML = `
                <img src="${user.photoURL || `https://ui-avatars.com/api/?name=${user.displayName}&background=0D8ABC&color=fff`}" class="w-12 h-12 rounded-full object-cover">
                <span class="font-bold text-lg">${user.displayName}</span>
            `;

            const qrData = `splitify_user_id::${user.uid}`;
            QRCode.toCanvas(myQrCodeCanvas, qrData, { width: 256, margin: 2 }, function (error) {
                if (error) {
                    console.error(error);
                    showMessage("Could not generate QR code.");
                } else {
                    openModal(showQrCodeModal);
                }
            });
        }

        async function startQrScanner() {
            isScanning = true;
            openModal(scanQrCodeModal);
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                scanQrVideo.srcObject = stream;
                scanQrVideo.play();
                qrScannerAnimation = requestAnimationFrame(tickQrScanner);
            } catch (err) {
                console.error("Camera access error:", err);
                showMessage("Could not access camera. Please check permissions.");
                stopQrScanner();
            }
        }

        function stopQrScanner() {
            isScanning = false;
            cancelAnimationFrame(qrScannerAnimation);
            if (scanQrVideo.srcObject) {
                scanQrVideo.srcObject.getTracks().forEach(track => track.stop());
            }
            closeModal(scanQrCodeModal);
        }

        function tickQrScanner() {
            if (!isScanning) return;

            if (scanQrVideo.readyState === scanQrVideo.HAVE_ENOUGH_DATA) {
                const canvasContext = scanQrCanvas.getContext('2d');
                scanQrCanvas.height = scanQrVideo.videoHeight;
                scanQrCanvas.width = scanQrVideo.videoWidth;
                canvasContext.drawImage(scanQrVideo, 0, 0, scanQrCanvas.width, scanQrCanvas.height);
                
                const imageData = canvasContext.getImageData(0, 0, scanQrCanvas.width, scanQrCanvas.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height, {
                    inversionAttempts: "dontInvert",
                });

                if (code && code.data.startsWith('splitify_user_id::')) {
                    stopQrScanner();
                    const scannedUid = code.data.split('::')[1];
                    if (scannedUid) {
                        addUserToCurrentTrip(scannedUid);
                    } else {
                        showMessage("Invalid QR code scanned.");
                    }
                }
            }
            if (isScanning) {
                qrScannerAnimation = requestAnimationFrame(tickQrScanner);
            }
        }
        
        const handleAddExpense = async () => {
            if (!currentTrip) return;
            const submitBtnText = submitExpenseBtn.querySelector('.btn-text');
            const spinner = submitExpenseBtn.querySelector('.spinner');
            submitBtnText.classList.add('hidden');
            spinner.classList.remove('hidden');
            submitExpenseBtn.disabled = true;
            try {
                const description = document.getElementById('expense-description').value;
                const originalAmountFloat = parseFloat(document.getElementById('expense-amount').value);
                const originalCurrency = document.getElementById('expense-currency').value;
                const baseCurrency = currentTrip.baseCurrency;
                const occurredAt = Timestamp.fromDate(new Date(document.getElementById('expense-occurred-at').value));
                const category = document.getElementById('expense-category').value;
                const paidBy = document.getElementById('expense-paid-by').value;
                let finalBaseSplitsInCents = {};
                let exchangeRate = 1;
                if (originalCurrency !== baseCurrency) {
                    const rateData = await getExchangeRate(originalCurrency, baseCurrency);
                    exchangeRate = rateData.conversion_rate;
                }
                const originalAmountInCents = Math.round(originalAmountFloat * 100);
                
                let totalBaseAmountInCents;
                const isItemizedMode = currentItemization && !itemizedSplitSection.classList.contains('hidden');
                
                if (isItemizedMode) {
                    const { memberSharesInCents } = calculateItemizedShares();
                    finalBaseSplitsInCents = memberSharesInCents;
                    totalBaseAmountInCents = Object.values(finalBaseSplitsInCents).reduce((sum, val) => sum + val, 0);
                } else {
                    totalBaseAmountInCents = Math.round((originalAmountFloat * exchangeRate) * 100);
                    const checkedSharers = Array.from(expenseSplitBetweenDiv.querySelectorAll('.split-input-group input[type="checkbox"]:checked'));
                    const sharerUids = checkedSharers.map(cb => cb.closest('.split-input-group').dataset.uid);
                    if (sharerUids.length > 0) {
                        const numSharers = sharerUids.length;
                        const baseShareCents = Math.floor(totalBaseAmountInCents / numSharers);
                        let remainderCents = totalBaseAmountInCents % numSharers;
                        shuffleArray(sharerUids);
                        sharerUids.forEach(uid => {
                            let shareForThisUser = baseShareCents;
                            if (remainderCents > 0) {
                                shareForThisUser++;
                                remainderCents--;
                            }
                            finalBaseSplitsInCents[uid] = shareForThisUser;
                        });
                        const sumOfSplits = Object.values(finalBaseSplitsInCents).reduce((a, b) => a + b, 0);
                        const diff = totalBaseAmountInCents - sumOfSplits;
                        if (diff !== 0 && sharerUids.length > 0) {
                            finalBaseSplitsInCents[sharerUids[0]] += diff;
                        }
                    }
                }
                const newExpense = {
                    description, occurredAt, category: category || null, createdAt: serverTimestamp(), paidBy,
                    amountDetails: {
                        originalAmount: originalAmountFloat,
                        originalCurrency, baseCurrency, exchangeRate,
                        originalAmountInCents,
                        baseAmountInCents: totalBaseAmountInCents,
                    },
                    splitBetweenInCents: finalBaseSplitsInCents,
                    isDeleted: false
                };
                const batch = writeBatch(db);
                const newExpenseRef = doc(collection(db, 'trips', currentTrip.id, 'expenses'));
                batch.set(newExpenseRef, newExpense);
                const tripRef = doc(db, "trips", currentTrip.id);
                batch.update(tripRef, { isSettled: false });
                await batch.commit();
                addExpenseForm.reset();
                closeModal(addExpenseModal);
                showMessage("Expense added successfully!", false);
            } catch (error) {
                console.error("Error adding expense:", error);
                showMessage(error.message);
            } finally {
                submitBtnText.classList.remove('hidden');
                spinner.classList.add('hidden');
                submitExpenseBtn.disabled = false;
            }
        };
        
        const handleProfilePicUpload = async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const user = auth.currentUser;
            if (!user) {
                showMessage("You must be logged in to upload a photo.");
                return;
            }
            const options = { maxSizeMB: 1, maxWidthOrHeight: 1024, useWebWorker: true, fileType: 'image/jpeg' };
            showMessage("Compressing and uploading photo...", false);
            try {
                const compressedFile = await imageCompression(file, options);
                const storagePath = `profile-pictures/${user.uid}`;
                const storageRef = ref(storage, storagePath);
                const uploadTask = uploadBytesResumable(storageRef, compressedFile);
                uploadTask.on('state_changed', 
                  () => {}, 
                  (error) => { console.error("Error during photo upload:", error); showMessage("An error occurred during upload."); }, 
                  async () => {
                    try {
                        const photoURL = await getDownloadURL(uploadTask.snapshot.ref);
                        await updateProfile(user, { photoURL });
                        await updateDoc(doc(db, "users", user.uid), { photoURL });
                        const existingProfile = userProfilesCache.get(user.uid) || {};
                        userProfilesCache.set(user.uid, { ...existingProfile, photoURL });
                        renderProfile(auth.currentUser); 
                        showMessage("Profile picture updated!", false);
                    } catch (error) {
                        console.error("Error updating profile with new photo URL:", error);
                        showMessage("Could not save profile picture after upload.");
                    }
                  }
                );
            } catch (error) {
                console.error("Error compressing image:", error);
                showMessage("Could not process image. Please try a different one.");
            }
        };

        const handleRecordPayment = async (fromUid, toUid, amountFloat) => {
            if (!currentTrip) return showMessage("Error: No active trip selected.");
            const amountInCents = Math.round(amountFloat * 100);
            const newPayment = { 
                from: fromUid, 
                to: toUid, 
                amountInCents: amountInCents, 
                paidAt: Timestamp.now(), 
                isDeleted: false 
            };
            try {
                await updateDoc(doc(db, 'trips', currentTrip.id), { settledPayments: arrayUnion(newPayment) });
                closeModal(settleUpModal);
                showMessage("Payment recorded successfully!", false);
            } catch (error) {
                console.error("Error recording payment:", error);
                showMessage("Failed to record payment.");
            }
        };

        function listenForFeedback() {
            if (feedbackUnsubscribe) feedbackUnsubscribe();

            const feedbackRef = collection(db, 'feedback');
            const q = query(feedbackRef, orderBy('upvotes', 'desc'), orderBy('createdAt', 'desc'));

            feedbackUnsubscribe = onSnapshot(q, (snapshot) => {
                const allFeedback = [];
                snapshot.forEach(doc => {
                    allFeedback.push({ id: doc.id, ...doc.data() });
                });
                renderFeedbackList(allFeedback);
            }, (error) => {
                console.error("Error listening for feedback:", error);
                feedbackList.innerHTML = '<p class="text-center text-red-500 py-10">Could not load feedback. Check console for index creation link.</p>';
            });
        }

        function renderFeedbackList(items) {
            feedbackList.innerHTML = '';
            if (items.length === 0) {
                feedbackList.innerHTML = '<p class="text-center text-gray-500 py-10">No feedback yet. Be the first to submit an idea!</p>';
                return;
            }

            const currentUser = auth.currentUser;

            items.forEach(item => {
                const card = document.createElement('div');
                card.className = 'bg-white p-4 rounded-lg shadow-sm flex items-start space-x-4';

                const hasVoted = currentUser && item.upvotedBy?.includes(currentUser.uid);
                const voteButtonClass = hasVoted
                    ? 'bg-indigo-600 text-white cursor-not-allowed'
                    : 'bg-gray-200 text-gray-800 hover:bg-gray-300';
                const voteButtonDisabled = hasVoted ? 'disabled' : '';

                const statusColors = {
                    'New': 'bg-blue-100 text-blue-800',
                    'Planned': 'bg-yellow-100 text-yellow-800',
                    'In-Progress': 'bg-purple-100 text-purple-800',
                    'Completed': 'bg-green-100 text-green-800'
                };
                const statusBadge = `<span class="px-2 py-1 text-xs font-medium rounded-full ${statusColors[item.status] || 'bg-gray-100 text-gray-800'}">${item.status}</span>`;

                card.innerHTML = `
                    <div class="text-center flex-shrink-0">
                        <button class="upvote-btn w-12 h-16 flex flex-col items-center justify-center rounded-md transition-colors ${voteButtonClass}" data-feedback-id="${item.id}" ${voteButtonDisabled}>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z" clip-rule="evenodd" /></svg>
                            <span class="font-bold text-lg">${item.upvotes || 0}</span>
                        </button>
                    </div>
                    <div class="flex-grow">
                        <div class="flex items-center space-x-3 mb-1">
                            ${statusBadge}
                            <h3 class="text-lg font-bold text-gray-800">${item.title}</h3>
                        </div>
                        <p class="text-gray-600 text-sm mb-3">${item.description}</p>
                        <p class="text-xs text-gray-400">
                            Submitted by ${item.userDisplayName || 'a user'} on ${item.createdAt?.toDate().toLocaleDateString() || 'a while ago'}
                        </p>
                    </div>
                `;
                feedbackList.appendChild(card);
            });
        }

        async function handleUpvote(feedbackId) {
            const user = auth.currentUser;
            if (!user) return;

            const feedbackRef = doc(db, "feedback", feedbackId);

            try {
                await runTransaction(db, async (transaction) => {
                    const feedbackDoc = await transaction.get(feedbackRef);
                    if (!feedbackDoc.exists()) {
                        throw "Document does not exist!";
                    }

                    const data = feedbackDoc.data();
                    const upvotedBy = data.upvotedBy || [];

                    if (upvotedBy.includes(user.uid)) {
                        return;
                    }

                    const newUpvoteCount = (data.upvotes || 0) + 1;
                    const newUpvotedBy = [...upvotedBy, user.uid];

                    transaction.update(feedbackRef, {
                        upvotes: newUpvoteCount,
                        upvotedBy: newUpvotedBy
                    });
                });
            } catch (error) {
                console.error("Upvote transaction failed: ", error);
                showMessage("Could not register your vote at this time.");
            }
        }
        
        createTripBtn.addEventListener('click', () => openModal(createTripModal));
        loginForm.addEventListener('submit', (e) => { e.preventDefault(); handleLogin(); });
        registerForm.addEventListener('submit', (e) => { e.preventDefault(); handleRegister(); });
        createTripForm.addEventListener('submit', (e) => { e.preventDefault(); handleCreateTrip(); });
        addExpenseForm.addEventListener('submit', (e) => { e.preventDefault(); handleAddExpense(); });
        inviteMemberForm.addEventListener('submit', (e) => { handleInviteMemberByEmail(e); });
        profilePicInput.addEventListener('change', handleProfilePicUpload);
        supremoMenuBtn.addEventListener('click', () => { supremoToggleActionSheet.checked = isTripSupremoEnabled; openModal(actionSheetModal); });
        
        const inviteModal = document.getElementById('invite-member-modal');
        const tabButtons = inviteModal.querySelectorAll('.segmented-control button');
        const tabPanels = inviteModal.querySelectorAll('.tab-panel');

        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const tabId = button.dataset.tab;
                
                tabButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');

                tabPanels.forEach(panel => {
                   if (panel.id === `panel-${tabId}`) {
                       panel.classList.remove('hidden');
                       panel.classList.add('active');
                   } else {
                       panel.classList.remove('hidden', 'active');
                       panel.classList.add('hidden');
                   }
                });
            });
        });

        openFeedbackHubBtn.addEventListener('click', () => {
            showView('feedback-hub-view');
            listenForFeedback();
        });

        backToDashboardFromFeedbackBtn.addEventListener('click', () => {
            if (feedbackUnsubscribe) {
                feedbackUnsubscribe();
                feedbackUnsubscribe = null;
            }
            showView('dashboard-view');
        });

        submitNewIdeaBtn.addEventListener('click', () => openModal(submitFeedbackModal));
        cancelSubmitFeedbackBtn.addEventListener('click', () => closeModal(submitFeedbackModal));

        feedbackList.addEventListener('click', (e) => {
            const upvoteBtn = e.target.closest('.upvote-btn');
            if (upvoteBtn && !upvoteBtn.disabled) {
                const feedbackId = upvoteBtn.dataset.feedbackId;
                handleUpvote(feedbackId);
            }
        });

        submitFeedbackForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = auth.currentUser;
            if (!user) {
                showMessage("You must be logged in to submit feedback.");
                return;
            }

            const title = document.getElementById('feedback-title').value;
            const type = document.getElementById('feedback-type-submit').value;
            const description = document.getElementById('feedback-description-submit').value;

            const newFeedback = {
                title,
                type,
                description,
                status: 'New',
                createdAt: serverTimestamp(),
                userId: user.uid,
                userDisplayName: user.displayName,
                upvotes: 1,
                upvotedBy: [user.uid]
            };

            try {
                await addDoc(collection(db, "feedback"), newFeedback);
                submitFeedbackForm.reset();
                closeModal(submitFeedbackModal);
                showMessage("Your idea has been submitted. Thank you!", false);
            } catch (error) {
                console.error("Error submitting feedback:", error);
                showMessage("Could not submit feedback.");
            }
        });

        actionSheetCancelBtn.addEventListener('click', () => closeModal(actionSheetModal));
        actionSheetModal.addEventListener('click', (e) => { if (e.target === actionSheetModal) closeModal(actionSheetModal); });
        actionSheetArchiveBtn.addEventListener('click', () => {
            closeModal(actionSheetModal);
            tripToArchive = { id: currentTrip.id, name: currentTrip.name };
            archiveTripNameSpan.textContent = tripToArchive.name;
            openModal(archiveTripModal);
        });
        
        cancelCreateTripBtn.addEventListener('click', () => closeModal(createTripModal));
        
        confirmArchiveTripBtn.addEventListener('click', async () => {
            if (!tripToArchive) return;
            try {
                await updateDoc(doc(db, 'trips', tripToArchive.id), { isArchived: true });
                showMessage("Trip archived.", false);
                backToDashboardBtn.click();
            } catch (error) {
                console.error("Error archiving trip:", error);
                showMessage("Could not archive trip.");
            } finally {
                tripToArchive = null;
                closeModal(archiveTripModal);
            }
        });

        actionSheetEmailBtn.addEventListener('click', () => {
            closeModal(actionSheetModal);
            showMessage("Email function coming soon!", false);
        });

        supremoToggleActionSheet.addEventListener('change', async (e) => {
            isTripSupremoEnabled = e.target.checked;
            if (auth.currentUser) {
                await saveUserPreferences(auth.currentUser.uid, { showDeleted: showDeletedItems, supremoEnabled: isTripSupremoEnabled, showArchived: showArchivedTrips });
                showMessage(`Trip Supremo ${isTripSupremoEnabled ? 'Enabled' : 'Disabled'}`, false);
            }
            if (currentTrip) renderTripItems();
        });

        profileArea.addEventListener('click', (e) => {
            const dropdown = document.getElementById('profile-dropdown');
            if (e.target.closest('#profile-pic-btn')) {
                if (dropdown.classList.contains('hidden')) {
                    dropdown.classList.remove('hidden', 'opacity-0', 'scale-95');
                } else {
                    dropdown.classList.add('opacity-0', 'scale-95');
                    setTimeout(() => dropdown.classList.add('hidden'), 200);
                }
            }
            if (e.target.closest('#change-pic-btn')) {
                e.preventDefault();
                profilePicInput.click();
                dropdown.classList.add('hidden', 'opacity-0', 'scale-95');
            }
            if (e.target.closest('#edit-profile-btn')) {
                e.preventDefault();
                const user = auth.currentUser;
                const userProfile = userProfilesCache.get(user.uid);
                document.getElementById('profile-name').value = user.displayName;
                document.getElementById('payment-bank').value = userProfile?.paymentInfo?.bank || '';
                document.getElementById('payment-username').value = userProfile?.paymentInfo?.username || '';
                openModal(editProfileModal);
                dropdown.classList.add('hidden', 'opacity-0', 'scale-95');
            }
            if (e.target.closest('#logout-btn')) {
                e.preventDefault();
                signOut(auth);
            }
            if (e.target.closest('#delete-account-btn')) {
                e.preventDefault();
                openModal(deleteAccountModal);
                dropdown.classList.add('hidden', 'opacity-0', 'scale-95');
            }
        });

        document.addEventListener('click', (e) => {
            const dropdown = document.getElementById('profile-dropdown');
            if (dropdown && !e.target.closest('#profile-area')) {
                 dropdown.classList.add('hidden', 'opacity-0', 'scale-95');
            }
        });

        tripItemsList.addEventListener('click', (e) => {
            const editExpenseBtn = e.target.closest('.edit-expense-btn');
            if (editExpenseBtn) {
                expenseToEdit = { id: editExpenseBtn.dataset.expenseId, description: editExpenseBtn.dataset.expenseDescription };
                editExpenseIdInput.value = expenseToEdit.id;
                editExpenseDescriptionInput.value = expenseToEdit.description;
                openModal(editExpenseModal);
            }
            const deleteExpenseBtn = e.target.closest('.delete-expense-btn');
            if (deleteExpenseBtn) {
                expenseToDelete = deleteExpenseBtn.dataset.expenseId;
                openModal(deleteExpenseModal);
            }
            const deletePaymentBtn = e.target.closest('.delete-payment-btn');
            if (deletePaymentBtn) {
                paymentToDeleteId = parseInt(deletePaymentBtn.dataset.paymentId, 10);
                openModal(deletePaymentModal);
            }
        });

        tripMembersList.addEventListener('click', (e) => {
            const btn = e.target.closest('button');
            if (!btn) return;
            
            if (btn.classList.contains('remove-member-btn')) {
                memberToRemove = {
                    uid: btn.dataset.uid,
                    name: btn.dataset.name
                };
                removeMemberNameSpan.textContent = memberToRemove.name;
                openModal(removeMemberModal);
            } else if (btn.dataset.action === 'show-remove-error') {
                showMessage("Cannot remove member with financial history. Settle all debts first.");
            }
        });
        
        cancelRemoveMemberBtn.addEventListener('click', () => {
            memberToRemove = null;
            closeModal(removeMemberModal);
        });
        
        confirmRemoveMemberBtn.addEventListener('click', handleRemoveMember);
        cancelDeleteAccountBtn.addEventListener('click', () => closeModal(deleteAccountModal));
        confirmDeleteAccountBtn.addEventListener('click', handleDeleteAccount);
        
        settlementList.addEventListener('click', (e) => {
            const recordBtn = e.target.closest('.record-payment-btn');
            if (recordBtn) {
                handleRecordPayment(recordBtn.dataset.fromUid, recordBtn.dataset.toUid, parseFloat(recordBtn.dataset.amount));
            }
        });

        editProfileForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = auth.currentUser;
            const newName = document.getElementById('profile-name').value;
            const paymentBank = document.getElementById('payment-bank').value;
            const paymentUsername = document.getElementById('payment-username').value.replace('@', '');
            if (!newName) return showMessage("Name cannot be empty.");
            try {
                if (user.displayName !== newName) await updateProfile(user, { displayName: newName });
                const updatedData = { displayName: newName, paymentInfo: { bank: paymentBank, username: paymentUsername } };
                await updateDoc(doc(db, "users", user.uid), updatedData);
                userProfilesCache.set(user.uid, { ...userProfilesCache.get(user.uid), ...updatedData });
                renderProfile(user);
                showMessage("Profile updated successfully!", false);
                closeModal(editProfileModal);
            } catch (error) {
                console.error("Error updating profile:", error);
                showMessage("Could not update profile.");
            }
        });

        editExpenseForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const newDescription = editExpenseDescriptionInput.value;
            const expenseId = editExpenseIdInput.value;
            if (!newDescription || !expenseId || !currentTrip) return;
            try {
                await updateDoc(doc(db, 'trips', currentTrip.id, 'expenses', expenseId), { description: newDescription });
                showMessage("Description updated!", false);
            } catch (error) {
                console.error("Error updating description:", error);
                showMessage("Could not update description.");
            } finally {
                expenseToEdit = null;
                closeModal(editExpenseModal);
            }
        });

        confirmDeleteExpenseBtn.addEventListener('click', async () => {
            if (!expenseToDelete || !currentTrip) return;
            try {
                const batch = writeBatch(db);
                batch.update(doc(db, 'trips', currentTrip.id, 'expenses', expenseToDelete), { isDeleted: true });
                batch.update(doc(db, "trips", currentTrip.id), { isSettled: false });
                await batch.commit();
                showMessage("Expense deleted.", false);
            } catch (error) {
                console.error("Error deleting expense:", error);
                showMessage("Could not delete expense.");
            } finally {
                expenseToDelete = null;
                closeModal(deleteExpenseModal);
            }
        });

        confirmDeletePaymentBtn.addEventListener('click', async () => {
            if (paymentToDeleteId === null || !currentTrip) return;
            const updatedPayments = currentTrip.settledPayments.map(p => {
                if (p.paidAt.toMillis() === paymentToDeleteId) return { ...p, isDeleted: true };
                return p;
            });
            try {
                await updateDoc(doc(db, 'trips', currentTrip.id), { settledPayments: updatedPayments, isSettled: false });
                showMessage("Payment deleted.", false);
            } catch (error) {
                console.error("Error deleting payment:", error);
                showMessage("Could not delete payment.");
            } finally {
                paymentToDeleteId = null;
                closeModal(deletePaymentModal);
            }
        });
        
        function calculateSettlement() {
            const balances = calculateAllBalances(currentTrip, allTripExpenses);
            const debtors = [];
            const creditors = [];
            balances.forEach((amountInCents, uid) => {
                if (amountInCents < 0) debtors.push({ uid, amountInCents: -amountInCents });
                else if (amountInCents > 0) creditors.push({ uid, amountInCents });
            });
            debtors.sort((a, b) => a.amountInCents - b.amountInCents);
            creditors.sort((a, b) => a.amountInCents - b.amountInCents);
            const transactions = [];
            while (debtors.length > 0 && creditors.length > 0) {
                const debtor = debtors[0];
                const creditor = creditors[0];
                const amountToSettleInCents = Math.min(debtor.amountInCents, creditor.amountInCents);
                if (amountToSettleInCents > 0) {
                    transactions.push({ from: debtor.uid, to: creditor.uid, amountInCents: amountToSettleInCents });
                }
                debtor.amountInCents -= amountToSettleInCents;
                creditor.amountInCents -= amountToSettleInCents;
                if (debtor.amountInCents <= 0) debtors.shift();
                if (creditor.amountInCents <= 0) creditors.shift();
            }
            return transactions;
        }

        async function calculateAndShowSettlement() {
            const transactions = calculateSettlement();
            const allMemberIds = [...new Set(transactions.flatMap(tx => [tx.from, tx.to]))];
            await fetchUserProfiles(allMemberIds);
            const currentUser = auth.currentUser;
            const isSupremo = currentUser.uid === currentTrip.ownerId && isTripSupremoEnabled;
            const filteredTransactions = transactions.filter(tx => isSupremo || tx.from === currentUser.uid || tx.to === currentUser.uid);
            settlementCurrency.textContent = `All amounts in: ${currentTrip.baseCurrency}`;
            settlementList.innerHTML = '';
            if (filteredTransactions.length === 0) {
                settlementSummary.textContent = transactions.length === 0 ? "Everyone is settled up!" : "You have no outstanding payments to make or receive at this time.";
            } else {
                settlementSummary.textContent = "Here are your outstanding settlements:";
                filteredTransactions.forEach(tx => {
                    const fromUser = userProfilesCache.get(tx.from);
                    const toUser = userProfilesCache.get(tx.to);
                    if (!fromUser || !toUser) return;
                    const toPaymentInfo = toUser.paymentInfo || {};
                    const amountForDisplay = (tx.amountInCents / 100).toFixed(2);
                    let paymentLink = '';
                    if (toPaymentInfo.bank && toPaymentInfo.username) {
                        if (toPaymentInfo.bank === 'Monzo') paymentLink = `https://monzo.me/${toPaymentInfo.username}/${amountForDisplay}`;
                        else if (toPaymentInfo.bank === 'Revolut') paymentLink = `https://revolut.me/${toPaymentInfo.username}/${amountForDisplay}`;
                    }
                    const amPayer = currentUser.uid === tx.from;
                    const canRecordPayment = amPayer || currentUser.uid === tx.to || isSupremo;
                    const paymentEl = document.createElement('div');
                    paymentEl.className = 'p-3 bg-gray-100 rounded-lg';
                    paymentEl.innerHTML = `
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <div class="font-semibold">${fromUser.displayName}</div>
                                <svg class="w-5 h-5 mx-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path></svg>
                                <div class="font-semibold">${toUser.displayName}</div>
                            </div>
                            <div class="font-bold text-lg">${amountForDisplay} ${currentTrip.baseCurrency}</div>
                        </div>
                        ${paymentLink && amPayer ? `<a href="${paymentLink}" target="_blank" class="block mt-2 text-center bg-${toPaymentInfo.bank.toLowerCase() === 'monzo' ? 'yellow' : 'blue'}-500 text-white text-sm font-bold py-2 px-4 rounded-lg hover:bg-${toPaymentInfo.bank.toLowerCase() === 'monzo' ? 'yellow' : 'blue'}-600">Pay with ${toPaymentInfo.bank}</a>` : ''}
                        ${canRecordPayment ? `<button class="record-payment-btn w-full mt-2 bg-green-500 text-white text-sm font-bold py-2 px-4 rounded-lg hover:bg-green-600" data-from-uid="${tx.from}" data-to-uid="${tx.to}" data-amount="${amountForDisplay}">Record as Paid</button>` : ''}
                    `;
                    settlementList.appendChild(paymentEl);
                });
            }
            openModal(settleUpModal);
        }

        async function initializeVisualisation() {
            visualisationCurrency.textContent = `All amounts in: ${currentTrip.baseCurrency}`;
            const balances = calculateAllBalances(currentTrip, allTripExpenses);
            const allMemberIds = currentTrip.memberUids;
            const profiles = await fetchUserProfiles(allMemberIds);
            const currencySymbol = currencySymbols[currentTrip.baseCurrency] || currentTrip.baseCurrency;
            const creditors = [];
            const debtors = [];
            balances.forEach((amountInCents, uid) => {
                const user = profiles[uid];
                if (!user) return;
                if (amountInCents > 0) creditors.push({ name: user.displayName, amount: (amountInCents / 100).toFixed(2) });
                else if (amountInCents < 0) debtors.push({ name: user.displayName, amount: (Math.abs(amountInCents) / 100).toFixed(2) });
            });
            const transactions = calculateSettlement();
            vizDebtorsList.innerHTML = debtors.length > 0 ? debtors.map(d => `<div class="break-words">${d.name} owes <span class="font-bold">${currencySymbol}${d.amount}</span></div>`).join('') : '<p>None</p>';
            vizCreditorsList.innerHTML = creditors.length > 0 ? creditors.map(c => `<div class="break-words">${c.name} is owed <span class="font-bold">${currencySymbol}${c.amount}</span></div>`).join('') : '<p>None</p>';
            vizPaymentsList.innerHTML = transactions.length > 0 ? transactions.map(tx => {
                const from = profiles[tx.from].displayName;
                const to = profiles[tx.to].displayName;
                const amountForDisplay = (tx.amountInCents / 100).toFixed(2);
                return `<div class="grid grid-cols-[1fr_auto_1fr_auto] gap-x-2 items-center">
                    <span class="break-words text-left">${from}</span>
                    <svg class="w-4 h-4 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M17.25 8.25L21 12m0 0l-3.75 3.75M21 12H3" /></svg>
                    <span class="break-words text-left">${to}</span>
                    <span class="font-bold text-right">${currencySymbol}${amountForDisplay}</span>
                </div>`;
            }).join('') : '<p>All settled!</p>';
        }
        
        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), delay);
            };
        }

        function getUserLocation() {
            navigator.geolocation.getCurrentPosition(
                (position) => { userLocation = { lat: position.coords.latitude, lon: position.coords.longitude }; },
                () => { console.warn("Could not get user location."); userLocation = null; }
            );
        }

        async function openCameraView() {
            openModal(aiScanModal);
            try {
                if (cameraStream) cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                videoElement.srcObject = cameraStream;
                videoElement.play();
            } catch (err) {
                console.error("Error accessing camera:", err);
                showMessage("Could not access the camera. Please check permissions.");
                closeCameraView();
            }
        }

        function closeCameraView() {
            if (cameraStream) cameraStream.getTracks().forEach(track => track.stop());
            videoElement.srcObject = null;
            closeModal(aiScanModal);
        }

        async function analyzeImageWithGemini(base64Image) {
            loadingText.textContent = "Analysing Scene...";
            loadingOverlay.classList.remove('hidden-view');
            const payload = { image: base64Image, userLocation, baseCurrency: currentTrip.baseCurrency };
            try {
                const response = await fetch(CLOUD_FUNCTION_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Cloud Function Error: ${response.status}. ${errorText}`);
                }
                const result = await response.json();
                const jsonText = result.candidates[0].content.parts[0].text;
                const data = JSON.parse(jsonText);

                addExpenseForm.reset();
                await populateExpenseModal(); 
                openModal(addExpenseModal);
                
                const descInput = document.getElementById('expense-description');
                const amountInput = document.getElementById('expense-amount');
                const currencySelect = document.getElementById('expense-currency');
                const occurredAtInput = document.getElementById('expense-occurred-at');
                
                let finalDescription = data.description || data.merchantName || '';
                aiReasoningTooltip.innerHTML = '';
                aiReasoningTooltip.classList.add('hidden');
                if (data.confidence && data.confidence !== 'high' && data.merchantName) {
                    finalDescription = `${data.description || data.merchantName} (Suggested: ${data.merchantName})`;
                }
                descInput.value = finalDescription;
                if (data.reasoning) {
                    aiReasoningTooltip.innerHTML = `<span class="info-icon">i<span class="tooltip-text">${data.reasoning}</span></span>`;
                    aiReasoningTooltip.classList.remove('hidden');
                }
                
                if (data.total !== null) amountInput.value = data.total;
                else amountInput.placeholder = "Enter amount manually";

                const detectedCurrency = data.currency;
                if (detectedCurrency) {
                    if (!currencySelect.querySelector(`option[value="${detectedCurrency}"]`)) {
                        const newOption = document.createElement('option');
                        newOption.value = detectedCurrency;
                        newOption.textContent = `${detectedCurrency} (Detected)`;
                        currencySelect.appendChild(newOption);
                    }
                    currencySelect.value = detectedCurrency;
                } else {
                    currencySelect.value = currentTrip.baseCurrency;
                }
                
                const formattedDateTime = formatDateTimeForInput(data.transactionTimestamp);
                if (formattedDateTime) {
                    occurredAtInput.value = formattedDateTime;
                }
                
                let exchangeRate = 1;
                const selectedCurrency = currencySelect.value;
                if (selectedCurrency && selectedCurrency !== currentTrip.baseCurrency) {
                    const rateData = await getExchangeRate(selectedCurrency, currentTrip.baseCurrency);
                    exchangeRate = rateData.conversion_rate;
                }

                if (data.lineItems && data.lineItems.length > 0 && data.confidence === 'high') {
                    const totalInOriginalCents = data.total ? Math.round(data.total * 100) : 0;
                    const totalInBaseCents = Math.round(totalInOriginalCents * exchangeRate);
                    
                    const lineItemsProcessed = data.lineItems.map(item => ({
                        ...item,
                        priceInOriginalCents: Math.round(item.price * 100)
                    }));
                    
                    currentItemization = {
                        currency: selectedCurrency,
                        exchangeRate: exchangeRate,
                        lineItems: lineItemsProcessed,
                        totalInOriginalCents: totalInOriginalCents,
                        totalInBaseCents: totalInBaseCents
                    };

                    splitModeToggleContainer.classList.remove('hidden');
                    equalSplitSection.classList.remove('hidden');
                    itemizedSplitSection.classList.add('hidden');
                    toggleSplitModeBtn.textContent = 'Switch to Split by Item';
                    renderItemizationUI(currentItemization);
                }
                
                await handleCurrencyChange();
                autoDistributeAmount();
                triggerAiCategorySuggestion();

            } catch (error) {
                console.error('Gemini Scan failed:', error);
                showMessage(`Gemini analysis failed: ${error.message}. Please enter the expense manually.`);
                addExpenseForm.reset();
                await populateExpenseModal();
                openModal(addExpenseModal);
            } finally {
                loadingOverlay.classList.add('hidden-view');
            }
        }

        async function handleAiCapture() {
            try {
                const context = canvasElement.getContext('2d');
                canvasElement.width = videoElement.videoWidth;
                canvasElement.height = videoElement.videoHeight;
                context.drawImage(videoElement, 0, 0, canvasElement.width, canvasElement.height);
                const imageDataUrl = canvasElement.toDataURL('image/jpeg', 0.8);
                const base64Image = imageDataUrl.split(',')[1];
                closeCameraView();
                await analyzeImageWithGemini(base64Image);
            } catch (error) {
                 console.error("Error capturing photo:", error);
                 showMessage("Could not capture photo.");
                 loadingOverlay.classList.add('hidden-view');
            }
        }

        async function handleReceiptFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const options = { maxSizeMB: 2, maxWidthOrHeight: 1920, useWebWorker: true };
            try {
                loadingText.textContent = "Compressing image...";
                loadingOverlay.classList.remove('hidden-view');
                const compressedFile = await imageCompression(file, options);
                const base64Image = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result.split(',')[1]);
                    reader.onerror = (error) => reject(error);
                    reader.readAsDataURL(compressedFile);
                });
                await analyzeImageWithGemini(base64Image);
            } catch (error) {
                 console.error("Error processing uploaded file:", error);
                 showMessage("Could not process the selected image.");
                 loadingOverlay.classList.add('hidden-view');
            } finally {
                event.target.value = '';
            }
        }
        
        async function triggerAiCategorySuggestion() {
            const merchantName = document.getElementById('expense-description').value;
            if (!merchantName || merchantName.length < 3) return;
            aiCategorySpinner.innerHTML = `<div class="mini-spinner"></div><span class="ml-2 text-sm text-indigo-600">Getting suggestion...</span>`;
            aiCategorySpinner.classList.remove('hidden');
            const locationInfo = userLocation ? ` near latitude ${userLocation.lat} and longitude ${userLocation.lon}` : '';
            const prompt = `From the following list, choose the single best category for the expense "${merchantName}"${locationInfo}: Food & Drink, Transport, Accommodation, Activities, Shopping, Other. Your entire response must be ONLY the category name and nothing else.`;
            const payload = { prompt: prompt };
            try {
                const response = await fetch(CLOUD_FUNCTION_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error("API Error");
                const result = await response.json();
                const suggestedCategory = result.candidates[0].content.parts[0].text.trim();
                const categorySelect = document.getElementById('expense-category');
                if ([...categorySelect.options].some(opt => opt.value === suggestedCategory)) {
                    categorySelect.value = suggestedCategory;
                }
            } catch (error) {
                console.error("Error getting category suggestion:", error);
            } finally {
                aiCategorySpinner.classList.add('hidden');
            }
        }
        
        const debouncedCategorySuggestion = debounce(triggerAiCategorySuggestion, 1000);
        fabToggle.addEventListener('click', () => { fabContainer.classList.toggle('open'); });
        fabManualAdd.addEventListener('click', () => {
            fabContainer.classList.remove('open');
            addExpenseForm.reset();
            populateExpenseModal();
            openModal(addExpenseModal);
        });
        fabCameraScan.addEventListener('click', () => {
            fabContainer.classList.remove('open');
            getUserLocation();
            openCameraView();
        });
        fabGalleryUpload.addEventListener('click', () => {
            fabContainer.classList.remove('open');
            getUserLocation();
            receiptUploadInput.click();
        });
        
        receiptUploadInput.addEventListener('change', handleReceiptFileUpload);
        aiCancelBtn.addEventListener('click', closeCameraView);
        aiCaptureBtn.addEventListener('click', handleAiCapture);

        toggleSplitModeBtn.addEventListener('click', () => {
            const isItemMode = !itemizedSplitSection.classList.contains('hidden');
            if (isItemMode) {
                itemizedSplitSection.classList.add('hidden');
                equalSplitSection.classList.remove('hidden');
                toggleSplitModeBtn.textContent = 'Switch to Split by Item';
                autoDistributeAmount();
            } else {
                itemizedSplitSection.classList.remove('hidden');
                equalSplitSection.classList.add('hidden');
                toggleSplitModeBtn.textContent = 'Switch to Split by Amount';
                renderItemizationUI(currentItemization);
            }
        });

        function renderItemizationUI(itemizationData) {
            itemizedListDiv.innerHTML = '';
            itemizationData.lineItems.forEach((item, index) => {
                const itemEl = document.createElement('div');
                itemEl.className = 'item-row bg-white rounded-md p-2 flex flex-col';
                itemEl.dataset.index = index;
                const detailsHTML = `<div class="w-full flex justify-between items-center"><p class="font-medium text-gray-800">${item.description}</p><p class="text-sm text-gray-500">${item.price.toFixed(2)} ${itemizationData.currency}</p></div>`;
                const memberAvatarsHTML = currentTrip.members
                    .filter(member => userProfilesCache.has(member.uid))
                    .map(member => {
                        const profile = userProfilesCache.get(member.uid);
                        let avatar = profile.photoURL 
                            ? `<img src="${profile.photoURL}" alt="${profile.displayName}" class="w-8 h-8 rounded-full object-cover cursor-pointer item-assignment-avatar">`
                            : `<div class="w-8 h-8 rounded-full bg-blue-500 text-white flex items-center justify-center text-sm font-bold cursor-pointer item-assignment-avatar">${profile.displayName.charAt(0).toUpperCase()}</div>`;
                        return `<div data-uid="${member.uid}" title="${profile.displayName}">${avatar}</div>`;
                }).join('');
                itemEl.innerHTML = `${detailsHTML}<div class="w-full flex space-x-1 mt-2">${memberAvatarsHTML}</div>`;
                itemizedListDiv.appendChild(itemEl);
            });
            updateItemizationSummary();
        }
        
        itemizedListDiv.addEventListener('click', (e) => {
            const avatarContainer = e.target.closest('[data-uid]');
            if (!avatarContainer) return;
            const avatar = avatarContainer.querySelector('.item-assignment-avatar');
            if (!avatar) return;
            const row = avatar.closest('.item-row, #live-remainder-row');
            if (row && row.id === 'live-remainder-row') {
                const identifier = avatarContainer.dataset.uid;
                if (remainderAssignments.has(identifier)) remainderAssignments.delete(identifier);
                else remainderAssignments.add(identifier);
            }
            avatar.classList.toggle('assigned');
            updateItemizationSummary();
        });
        
        function calculateItemizedShares() {
            const memberSharesInOriginalCents = {};
            currentTrip.memberUids.forEach(uid => memberSharesInOriginalCents[uid] = 0);
            
            let assignedItemsTotalInOriginalCents = 0;

            document.querySelectorAll('.item-row').forEach(row => {
                const item = currentItemization.lineItems[parseInt(row.dataset.index, 10)];
                const itemPriceInOriginalCents = item.priceInOriginalCents;
                const assignedAvatars = row.querySelectorAll('.item-assignment-avatar.assigned');

                if (assignedAvatars.length > 0) {
                    assignedItemsTotalInOriginalCents += itemPriceInOriginalCents;
                    const baseShare = Math.floor(itemPriceInOriginalCents / assignedAvatars.length);
                    let remainder = itemPriceInOriginalCents % assignedAvatars.length;

                    const assignedUids = Array.from(assignedAvatars).map(av => av.closest('[data-uid]').dataset.uid);
                    shuffleArray(assignedUids);

                    assignedUids.forEach(uid => {
                        let userShare = baseShare;
                        if (remainder > 0) {
                            userShare++;
                            remainder--;
                        }
                        memberSharesInOriginalCents[uid] += userShare;
                    });
                }
            });
            
            const totalUnassignedOriginalCents = currentItemization.totalInOriginalCents - assignedItemsTotalInOriginalCents;

            if (totalUnassignedOriginalCents > 0 && remainderAssignments.size > 0) {
                const sharePerPerson = Math.floor(totalUnassignedOriginalCents / remainderAssignments.size);
                let remainder = totalUnassignedOriginalCents % remainderAssignments.size;
                
                const remainderUids = Array.from(remainderAssignments);
                shuffleArray(remainderUids);

                remainderUids.forEach(uid => {
                    let userShare = sharePerPerson;
                    if(remainder > 0){
                        userShare++;
                        remainder--;
                    }
                    memberSharesInOriginalCents[uid] += userShare;
                });
            }

            const memberSharesInBaseCents = {};
            let totalSplitInBaseCents = 0;
            const rate = currentItemization.exchangeRate;

            for (const uid in memberSharesInOriginalCents) {
                if (memberSharesInOriginalCents[uid] > 0) {
                    const baseCents = Math.round(memberSharesInOriginalCents[uid] * rate);
                    memberSharesInBaseCents[uid] = baseCents;
                    totalSplitInBaseCents += baseCents;
                }
            }

            const difference = currentItemization.totalInBaseCents - totalSplitInBaseCents;
            if (difference !== 0 && Object.keys(memberSharesInBaseCents).length > 0) {
                const firstMemberUid = Object.keys(memberSharesInBaseCents)[0];
                memberSharesInBaseCents[firstMemberUid] += difference;
            }

            return { memberSharesInCents: memberSharesInBaseCents };
        }
        
        function updateItemizationSummary() {
            const memberSharesInOriginalCents = {};
            currentTrip.memberUids.forEach(uid => memberSharesInOriginalCents[uid] = 0);
            
            let assignedItemsTotalInOriginalCents = 0;

            document.querySelectorAll('.item-row').forEach(row => {
                const item = currentItemization.lineItems[parseInt(row.dataset.index, 10)];
                const itemPriceInOriginalCents = item.priceInOriginalCents;
                const assignedAvatars = row.querySelectorAll('.item-assignment-avatar.assigned');

                if (assignedAvatars.length > 0) {
                    assignedItemsTotalInOriginalCents += itemPriceInOriginalCents;
                    const baseShare = Math.floor(itemPriceInOriginalCents / assignedAvatars.length);
                    let remainder = itemPriceInOriginalCents % assignedAvatars.length;

                    const assignedUids = Array.from(assignedAvatars).map(av => av.closest('[data-uid]').dataset.uid);
                    shuffleArray(assignedUids); 

                    assignedUids.forEach(uid => {
                        let userShare = baseShare;
                        if (remainder > 0) {
                            userShare++;
                            remainder--;
                        }
                        memberSharesInOriginalCents[uid] += userShare;
                    });
                }
            });

            const liveRemainderInOriginalCents = currentItemization.totalInOriginalCents - assignedItemsTotalInOriginalCents;

            if (liveRemainderInOriginalCents > 0 && remainderAssignments.size > 0) {
                const sharePerPerson = Math.floor(liveRemainderInOriginalCents / remainderAssignments.size);
                let remainder = liveRemainderInOriginalCents % remainderAssignments.size;
                
                const remainderUids = Array.from(remainderAssignments);
                shuffleArray(remainderUids);

                remainderUids.forEach(uid => {
                    let userShare = sharePerPerson;
                    if(remainder > 0){
                        userShare++;
                        remainder--;
                    }
                    memberSharesInOriginalCents[uid] += userShare;
                });
            }

            document.getElementById('live-remainder-row')?.remove(); 
            if (liveRemainderInOriginalCents > 0) {
                const remainderEl = document.createElement('div');
                remainderEl.id = 'live-remainder-row';
                remainderEl.className = 'bg-green-50 rounded-md p-2 flex flex-col mt-3';
                const remainderForDisplay = (liveRemainderInOriginalCents / 100).toFixed(2);
                
                const avatarsHTML = currentTrip.members.map(member => {
                    const profile = userProfilesCache.get(member.uid);
                    if (!profile) return '';
                    const isAssigned = remainderAssignments.has(member.uid) ? 'assigned' : '';
                    const avatar = profile.photoURL 
                        ? `<img src="${profile.photoURL}" alt="${profile.displayName}" class="w-8 h-8 rounded-full object-cover cursor-pointer item-assignment-avatar ${isAssigned}">`
                        : `<div class="w-8 h-8 rounded-full bg-blue-500 text-white flex items-center justify-center text-sm font-bold cursor-pointer item-assignment-avatar ${isAssigned}">${profile.displayName.charAt(0).toUpperCase()}</div>`;
                    return `<div data-uid="${member.uid}" title="${profile.displayName}">${avatar}</div>`;
                }).join('');
                
                remainderEl.innerHTML = `
                    <div class="w-full flex justify-between items-center">
                        <p class="font-medium text-green-800">Total Unassigned</p>
                        <p class="text-sm font-bold text-green-700">${remainderForDisplay} ${currentItemization.currency}</p>
                    </div>
                    <p class="text-xs text-green-600 mb-2">Select who should split this remaining amount:</p>
                    <div class="w-full flex space-x-1 mt-1">${avatarsHTML}</div>`;
                itemizedListDiv.appendChild(remainderEl);
            }

            itemizedSummaryDiv.innerHTML = '<h4 class="font-semibold text-sm mb-1 mt-3">Member Totals:</h4>';
            let summaryHTML = '';
            let totalSplitInOriginalCents = 0;
            
            for (const uid in memberSharesInOriginalCents) {
                const shareCents = memberSharesInOriginalCents[uid];
                totalSplitInOriginalCents += shareCents;
                if (shareCents > 0) {
                    const profile = userProfilesCache.get(uid);
                    const shareForDisplay = (shareCents / 100).toFixed(2);
                    summaryHTML += `<div class="flex justify-between text-sm text-gray-700"><span>${profile.displayName}</span><span class="font-medium">${shareForDisplay} ${currentItemization.currency}</span></div>`;
                }
            }
            itemizedSummaryDiv.innerHTML += summaryHTML;
            
            const differenceOriginalCents = currentItemization.totalInOriginalCents - totalSplitInOriginalCents;
            const validationEl = document.createElement('div');
            validationEl.className = 'text-xs text-right mt-1 min-h-[1rem] font-semibold';

            if (Math.abs(differenceOriginalCents) < 1) {
                validationEl.textContent = `Total matches receipt!`;
                validationEl.className += ' text-green-600';
                submitExpenseBtn.disabled = false;
            } else {
                const diffInOriginal = (differenceOriginalCents / 100).toFixed(2);
                validationEl.textContent = `Unassigned: ${diffInOriginal} ${currentItemization.currency}`;
                validationEl.className += ' text-red-600';
                submitExpenseBtn.disabled = true;
            }
            itemizedSummaryDiv.appendChild(validationEl);
        }

        function updateSplitInputCurrency() {
            const selectedCurrency = expenseCurrencySelect.value;
            const symbol = currencySymbols[selectedCurrency] || selectedCurrency;
            expenseSplitBetweenDiv.querySelectorAll('.currency-symbol').forEach(span => {
                span.textContent = symbol;
            });
        }

        function populateExpenseModal() {
            if (!currentTrip) return;
            currentItemization = null;
            remainderAssignments.clear();
            itemizedSplitSection.classList.add('hidden');
            equalSplitSection.classList.remove('hidden');
            splitModeToggleContainer.classList.add('hidden');
            fxConversionDisplay.innerHTML = '';
            document.getElementById('expense-occurred-at').value = getCurrentLocalDateTime();
            expenseCurrencySelect.innerHTML = '';
            for (const code in allCurrencies) {
                const option = document.createElement('option');
                option.value = code;
                option.textContent = allCurrencies[code];
                expenseCurrencySelect.appendChild(option);
            }
            expenseCurrencySelect.value = currentTrip.baseCurrency;
            expensePaidBySelect.innerHTML = '';
            currentTrip.members.forEach(member => {
                const profile = userProfilesCache.get(member.uid);
                if (profile) {
                    const option = document.createElement('option');
                    option.value = member.uid;
                    option.textContent = profile.displayName;
                    expensePaidBySelect.appendChild(option);
                }
            });
            expensePaidBySelect.value = auth.currentUser.uid;
            expenseSplitBetweenDiv.innerHTML = '';
            currentTrip.members.forEach(member => {
                const group = document.createElement('div');
                group.className = 'split-input-group flex items-center justify-between p-2 bg-white rounded-md';
                const profile = userProfilesCache.get(member.uid);
                if (profile) {
                    const memberId = `split-member-${member.uid}`;
                    group.dataset.uid = member.uid;
                    group.innerHTML = `<label for="${memberId}" class="flex items-center cursor-pointer flex-grow min-w-0"><input type="checkbox" id="${memberId}" checked class="h-5 w-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 mr-3 flex-shrink-0"><span class="text-sm truncate">${profile.displayName}</span></label><div class="relative flex-shrink-0"><span class="currency-symbol absolute inset-y-0 left-0 pl-3 flex items-center text-gray-500 text-sm"></span><input type="number" step="0.01" class="w-24 pl-7 pr-2 py-1 border border-gray-300 rounded-md text-right" placeholder="0.00"></div>`;
                    expenseSplitBetweenDiv.appendChild(group);
                }
            });
            updateSplitInputCurrency();
            addSplitInputListeners();
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function autoDistributeAmount() {
            const totalAmountFloat = parseFloat(expenseAmountInput.value) || 0;
            const allSharers = Array.from(expenseSplitBetweenDiv.querySelectorAll('.split-input-group'));
            const checkedSharers = allSharers.filter(group => group.querySelector('input[type="checkbox"]:checked'));
            
            allSharers.forEach(group => { group.querySelector('input[type="number"]').value = '0.00'; });
            if (checkedSharers.length === 0 || totalAmountFloat === 0) {
                validateSplitTotal();
                return;
            }

            const totalCents = Math.round(totalAmountFloat * 100);
            const numSharers = checkedSharers.length;
            const baseShareCents = Math.floor(totalCents / numSharers);
            let remainderCents = totalCents % numSharers;
            
            const sharerGroups = checkedSharers;
            shuffleArray(sharerGroups);

            sharerGroups.forEach((group) => {
                let shareForThisUser = baseShareCents;
                if (remainderCents > 0) {
                    shareForThisUser++;
                    remainderCents--;
                }
                group.querySelector('input[type="number"]').value = (shareForThisUser / 100).toFixed(2);
            });
            validateSplitTotal();
        }

        function addSplitInputListeners() {
            expenseSplitBetweenDiv.querySelectorAll('input').forEach(input => {
                input.addEventListener('input', () => {
                    if (input.type === 'checkbox') {
                        autoDistributeAmount();
                    } else {
                        validateSplitTotal(); 
                    }
                });
            });
            expenseAmountInput.addEventListener('input', autoDistributeAmount);
            document.getElementById('deselect-all-btn').addEventListener('click', () => {
                expenseSplitBetweenDiv.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
                autoDistributeAmount();
            });
        }
        
        function validateSplitTotal() {
            const totalAmountFloat = parseFloat(expenseAmountInput.value) || 0;
            const totalCents = Math.round(totalAmountFloat * 100);

            let splitSumCents = 0;
            expenseSplitBetweenDiv.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => {
                const group = cb.closest('.split-input-group');
                const splitAmountFloat = parseFloat(group.querySelector('input[type="number"]').value) || 0;
                splitSumCents += Math.round(splitAmountFloat * 100);
            });
            
            const differenceCents = totalCents - splitSumCents;

            if (differenceCents === 0) {
                splitTotalValidation.textContent = 'Total matches!';
                splitTotalValidation.className = 'text-xs text-right mt-1 min-h-[1rem] text-green-600';
                submitExpenseBtn.disabled = false;
            } else {
                const differenceFloat = (differenceCents / 100).toFixed(2);
                splitTotalValidation.textContent = `Remaining: ${differenceFloat}`;
                splitTotalValidation.className = 'text-xs text-right mt-1 min-h-[1rem] text-red-600';
                submitExpenseBtn.disabled = true;
            }
        }
        
        async function handleCurrencyChange() {
            const selectedCurrency = expenseCurrencySelect.value;
            const baseCurrency = currentTrip.baseCurrency;
            const amount = parseFloat(expenseAmountInput.value);
            updateSplitInputCurrency();
            if (selectedCurrency === baseCurrency || !amount) {
                fxConversionDisplay.innerHTML = '';
                if (currentItemization) {
                    currentItemization.exchangeRate = 1;
                    currentItemization.currency = baseCurrency;
                    currentItemization.totalInBaseCents = currentItemization.totalInOriginalCents;
                    if(!itemizedSplitSection.classList.contains('hidden')) {
                        updateItemizationSummary();
                    }
                }
                return;
            }
            fxConversionDisplay.innerHTML = `<div class="mini-spinner"></div><span class="ml-2 text-sm text-indigo-600">Fetching rate...</span>`;
            try {
                const rateData = await getExchangeRate(selectedCurrency, baseCurrency);
                const convertedAmount = amount * rateData.conversion_rate;
                fxConversionDisplay.innerHTML = `~ ${convertedAmount.toFixed(2)} ${baseCurrency} (1 ${selectedCurrency} = ${rateData.conversion_rate.toFixed(4)} ${baseCurrency})`;

                if (currentItemization) {
                    currentItemization.exchangeRate = rateData.conversion_rate;
                    currentItemization.currency = selectedCurrency;
                    currentItemization.totalInBaseCents = Math.round(currentItemization.totalInOriginalCents * rateData.conversion_rate);
                     if(!itemizedSplitSection.classList.contains('hidden')) {
                        updateItemizationSummary();
                    }
                }
            } catch (error) {
                fxConversionDisplay.textContent = 'Could not get rate.';
                showMessage(error.message);
            }
        }

        function simpleMarkdownToHtml(md) {
            return md.replace(/^### (.*$)/gim, '<h3>$1</h3>').replace(/^## (.*$)/gim, '<h2>$1</h2>').replace(/^\* (.*$)/gim, '<ul><li>$1</li></ul>').replace(/<\/ul>\n<ul>/gim, '').replace(/\*\*(.*)\*\*/gim, '<strong>$1</strong>');
        }

        function generateTripCsv() {
            const headers = ["Date", "Description", "Category", "Amount", "Currency", "Paid By", "Split Between", "Is Deleted"];
            const expensesToExport = allTripExpenses.filter(e => showDeletedItems || !e.isDeleted);
            if (expensesToExport.length === 0) return "No expense data to export for this trip.";
            const rows = expensesToExport.map(expense => {
                const date = expense.occurredAt.toDate().toISOString().split('T')[0];
                const description = `"${expense.description.replace(/"/g, '""')}"`; 
                const category = expense.category || 'N/A';
                const amount = ((expense.amountDetails.baseAmountInCents || 0) / 100).toFixed(2);
                const currency = expense.amountDetails.baseCurrency;
                const paidBy = userProfilesCache.get(expense.paidBy)?.displayName || expense.paidBy;
                const splitWith = Object.keys(expense.splitBetweenInCents).map(uid => userProfilesCache.get(uid)?.displayName || uid).join('; ');
                const isDeleted = expense.isDeleted ? "Yes" : "No";
                return [date, description, category, amount, currency, `"${paidBy}"`, `"${splitWith}"`, isDeleted].join(',');
            });
            return [headers.join(','), ...rows].join('\n');
        }

        async function handleGenerateAiReport(e) {
            e.preventDefault();
            const reportType = document.getElementById('ai-report-type').value;
            if (reportType === 'spreadsheet_data') {
                const csvData = generateTripCsv();
                aiReportContent.innerHTML = `<p class="text-sm text-gray-600 mb-2">Copy the data below and paste it into your spreadsheet software (e.g., Excel, Google Sheets).</p><pre><code>${csvData}</code></pre>`;
                lastAiReportMarkdown = csvData; 
                closeModal(aiReportModal);
                openModal(aiReportDisplayModal);
                return;
            }
            loadingText.textContent = 'Your AI is analysing the trip data...';
            const customQuestion = document.getElementById('ai-report-question').value.trim();
            closeModal(aiReportModal);
            loadingOverlay.classList.remove('hidden-view');
            
            const tripDataForAI = {
                name: currentTrip.name,
                baseCurrency: currentTrip.baseCurrency,
                members: currentTrip.memberUids.map(uid => userProfilesCache.get(uid)?.displayName || 'Unknown User'),
                expenses: allTripExpenses
                    .filter(exp => !exp.isDeleted)
                    .map(exp => ({
                        description: exp.description,
                        category: exp.category,
                        amount: ((exp.amountDetails.baseAmountInCents || 0) / 100),
                        paidBy: userProfilesCache.get(exp.paidBy)?.displayName || 'Unknown',
                        date: exp.occurredAt.toDate().toISOString().split('T')[0]
                    })),
            };

            let userPrompt = `Here is the trip data for your analysis:\n${JSON.stringify(tripDataForAI, null, 2)}\n\n`;
            
            switch (reportType) {
                case 'spending_analysis':
                    userPrompt += "Please provide a concise but insightful spending analysis for this trip. Focus on total spending, spending per person, top categories, and any interesting outliers. Present it in markdown format.";
                    break;
                case 'fun_awards':
                    userPrompt += "Based on the trip data, create a list of fun, lighthearted 'awards' for the trip members (e.g., 'The High Roller' for most spent, 'The Social Butterfly' for being in the most group expenses). Be creative and friendly. Present it in markdown format.";
                    break;
                case 'custom_question':
                    userPrompt += `Now, please answer this specific question based on the data: "${customQuestion}"`;
                    break;
            }

            const payload = { prompt: userPrompt };

            try {
                const response = await fetch(CLOUD_FUNCTION_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Cloud Function Error: ${response.status}. ${errorText}`);
                }
                const result = await response.json();
                const markdownContent = result.candidates[0].content.parts[0].text;
                lastAiReportMarkdown = markdownContent;
                aiReportContent.innerHTML = simpleMarkdownToHtml(markdownContent);
                openModal(aiReportDisplayModal);
            } catch (error) {
                console.error("Error generating AI report:", error);
                showMessage(error.message);
            } finally {
                loadingOverlay.classList.add('hidden-view');
            }
        }
        
        forgotPasswordLink.addEventListener('click', (e) => {
            e.preventDefault();
            const loginEmail = document.getElementById('login-email').value;
            document.getElementById('reset-email').value = loginEmail;
            openModal(passwordResetModal);
        });
        
        cancelPasswordResetBtn.addEventListener('click', () => {
            closeModal(passwordResetModal);
            passwordResetForm.reset();
        });
        
        passwordResetForm.addEventListener('submit', handlePasswordReset);

        aiReportForm.addEventListener('submit', handleGenerateAiReport);
        copyAiReportBtn.addEventListener('click', () => { navigator.clipboard.writeText(lastAiReportMarkdown).then(() => showMessage("Report copied to clipboard!", false), () => showMessage("Failed to copy report.")); });
        loginTabBtn.addEventListener('click', () => {
            loginForm.classList.remove('hidden'); registerForm.classList.add('hidden');
            loginTabBtn.classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
            registerTabBtn.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            registerTabBtn.classList.add('text-gray-500'); hideAuthMessage();
        });
        registerTabBtn.addEventListener('click', () => {
            registerForm.classList.remove('hidden'); loginForm.classList.add('hidden');
            registerTabBtn.classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
            loginTabBtn.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            loginTabBtn.classList.add('text-gray-500'); hideAuthMessage();
        });
        expenseCurrencySelect.addEventListener('change', handleCurrencyChange);
        expenseAmountInput.addEventListener('input', debounce(handleCurrencyChange, 500));
        document.getElementById('expense-description').addEventListener('input', debouncedCategorySuggestion);
        aiReportTypeSelect.addEventListener('change', () => {
            if (aiReportTypeSelect.value === 'custom_question') customQuestionArea.classList.remove('hidden');
            else customQuestionArea.classList.add('hidden');
        });
        cancelAddExpenseBtn.addEventListener('click', () => closeModal(addExpenseModal));
        cancelEditProfileBtn.addEventListener('click', () => closeModal(editProfileModal));
        cancelEditExpenseBtn.addEventListener('click', () => closeModal(editExpenseModal));
        cancelInviteBtn.addEventListener('click', () => {
            closeModal(inviteMemberModal);
            resetInviteModal();
        });
        closeInviteModalXBtn.addEventListener('click', () => {
            closeModal(inviteMemberModal);
            resetInviteModal();
        });
        cancelArchiveTripBtn.addEventListener('click', () => closeModal(archiveTripModal));
        cancelDeleteExpenseBtn.addEventListener('click', () => closeModal(deleteExpenseModal));
        cancelDeletePaymentBtn.addEventListener('click', () => closeModal(deletePaymentModal));
        closeSettleUpBtn.addEventListener('click', () => closeModal(settleUpModal));
        closeSettleUpBtnX.addEventListener('click', () => closeModal(settleUpModal));
        closeVisualisationBtn.addEventListener('click', () => closeModal(settlementVisualisationModal));
        cancelAiReportBtn.addEventListener('click', () => closeModal(aiReportModal));
        closeAiDisplayBtn.addEventListener('click', () => closeModal(aiReportDisplayModal));
        closeAiDisplayBtnX.addEventListener('click', () => closeModal(aiReportDisplayModal));
        
        inviteMemberBtn.addEventListener('click', () => {
            resetInviteModal();
            openModal(inviteMemberModal);
            populateCompanionList();
        });

        const companionSearchInput = document.getElementById('companion-search');
        companionSearchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const companions = document.querySelectorAll('#companion-list-container .companion-item');
            companions.forEach(item => {
                const name = item.dataset.name;
                if (name.includes(searchTerm)) {
                    item.classList.remove('hidden');
                } else {
                    item.classList.add('hidden');
                }
            });
        });

        addSelectedCompanionsBtn.addEventListener('click', async () => {
            const uidsToAdd = Array.from(selectedCompanions);
            if (uidsToAdd.length > 0) {
                await addMultipleUsersToCurrentTrip(uidsToAdd);
            }
        });

        closeMyQrCodeBtn.addEventListener('click', () => closeModal(showQrCodeModal));
        showMyQrCodeIconBtn.addEventListener('click', showMyJoinCode);
        scanQrCodeBtn.addEventListener('click', () => { 
            closeModal(inviteMemberModal);
            startQrScanner();
        });
        cancelScanQrBtn.addEventListener('click', stopQrScanner);

        settleUpBtn.addEventListener('click', calculateAndShowSettlement);
        visualiseSettlementBtn.addEventListener('click', async () => { await initializeVisualisation(); openModal(settlementVisualisationModal); });
        aiReportBtn.addEventListener('click', () => openModal(aiReportModal));
    </script>
</body>
</html>

